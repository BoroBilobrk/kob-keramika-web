<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>KOB-Keramika</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Tesseract.js za OCR iz slike -->
  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: #000;
      color: #fff;
    }
    header {
      background: #000;
      border-bottom: 1px solid #444;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    header img.logo {
      height: 40px;
      width: auto;
    }
    header .title-block {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      line-height: 1.1;
    }
    header .app-name { font-weight: bold; font-size: 18px; }
    header .subtitle { font-size: 12px; color: #ccc; }

    main { padding: 12px; }
    .card {
      border: 1px solid #444;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      background: #111;
    }
    h3 { margin-top: 0; font-size: 16px; }
    label {
      font-size: 14px;
      display: block;
      margin-top: 8px;
    }
    input, textarea, select, button {
      width: 100%;
      box-sizing: border-box;
      margin-top: 4px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #444;
      background: #000;
      color: #fff;
      font-size: 14px;
    }
    input:focus, textarea:focus, select:focus { outline: 1px solid #888; }
    button {
      background: #fff;
      color: #000;
      font-weight: bold;
      cursor: pointer;
    }
    button.secondary { background: #111; color: #fff; }
    button:disabled { opacity: 0.4; cursor: default; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th, td {
      border-bottom: 1px solid #333;
      padding: 6px;
      text-align: left;
      vertical-align: top;
    }
    th { background: #111; }
    .totals { margin-top: 12px; font-size: 14px; }
    .image-preview { margin-top: 8px; text-align: center; }
    .image-preview img {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #444;
    }
    .actions-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .actions-row button { flex: 1; }
    footer {
      text-align: center;
      font-size: 11px;
      color: #777;
      padding: 8px;
      border-top: 1px solid #222;
    }
    .hint {
      font-size: 11px;
      color: #aaa;
      margin-top: 4px;
    }
    /* pogledi/ekrani */
    .view { display: none; }
    .view.active { display: block; }

    #splashView {
      text-align: center;
      padding-top: 40px;
    }
    #splashLogo {
      width: 160px;
      height: auto;
      margin-bottom: 20px;
    }
    #splashButtons button { margin-top: 10px; }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="KOB-Keramika logo" class="logo" id="headerLogo" />
    <div class="title-block">
      <span class="app-name">KOB-Keramika</span>
      <span class="subtitle">Tro≈°kovi po radniku i gradili≈°tu</span>
    </div>
  </header>

  <main>
    <!-- POƒåETNI EKRAN -->
    <section id="splashView" class="view active">
      <div class="card">
        <img src="logo.png" id="splashLogo" alt="KOB-Keramika logo" />
        <h3>KOB-Keramika</h3>
        <p>Interna aplikacija za skeniranje raƒçuna i praƒáenje tro≈°kova.</p>
        <div id="splashButtons">
          <button id="goEntry">‚ûï Unos tro≈°ka</button>
          <button id="goOverview" class="secondary">üìã Pregled tro≈°kova</button>
          <button id="goWorkers" class="secondary">üë∑ Po radniku</button>
        </div>
        <p class="hint">Dodaj na poƒçetni zaslon za iskustvo kao aplikacija.</p>
      </div>
    </section>

    <!-- GLAVNI EKRAN (unos + lista) -->
    <section id="entryView" class="view">
      <section class="card">
        <h3>Unos tro≈°ka</h3>
        <label>Radnik
          <input type="text" id="workerInput" placeholder="Ime radnika" />
        </label>
        <label>Gradili≈°te
          <input type="text" id="siteInput" placeholder="Naziv gradili≈°ta / projekta" />
        </label>
        <label>Iznos (‚Ç¨)
          <input type="number" step="0.01" id="amountInput" placeholder="0.00" />
        </label>
        <div class="hint">Ako uƒçita≈° sliku raƒçuna, aplikacija ƒáe poku≈°ati proƒçitati iznos (OCR).</div>
        <label>Opis tro≈°ka
          <textarea id="descInput" rows="2" placeholder="Opis"></textarea>
        </label>

        <label>Dokument (kamera ili galerija)
          <input type="file" id="imageInput" accept="image/*" capture="environment" />
        </label>

        <div class="image-preview" id="imagePreview" style="display:none;">
          <p>Zadnji uƒçitani dokument:</p>
          <img id="previewImg" src="" alt="Skenirani dokument" />
        </div>

        <button id="addExpenseBtn">Dodaj tro≈°ak</button>
      </section>

      <section class="card">
        <h3>Filtriranje i izvoz</h3>
        <label>Filter po radniku
          <select id="workerFilter">
            <option value="">Svi radnici</option>
          </select>
        </label>

        <div class="actions-row">
          <button id="exportCsvBtn">Export CSV (Excel)</button>
          <button class="secondary" id="printBtn">Print / PDF</button>
        </div>

        <div class="totals" id="selectedWorkerTotal"></div>
      </section>

      <section class="card">
        <h3>Popis tro≈°kova</h3>
        <div id="expensesContainer"></div>
        <div class="totals" id="totalsContainer"></div>
      </section>
    </section>

    <!-- EKRAN PO RADNIKU -->
    <section id="workersView" class="view">
      <section class="card">
        <h3>Sa≈æetak po radniku</h3>
        <div id="workersSummary"></div>
        <p class="hint">Dodirni ‚ÄúPrika≈æi‚Äù za filtrirani prikaz tro≈°kova tog radnika.</p>
      </section>
    </section>
  </main>

  <footer>
    KOB-Keramika ‚Äî lokalna PWA aplikacija (podaci se ƒçuvaju samo na ovom ureƒëaju)
  </footer>

  <script>
    const STORAGE_KEY = 'kob_keramika_expenses_v3';

    function loadExpenses() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error('Load error', e);
        return [];
      }
    }
    function saveExpenses(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    let expenses = loadExpenses();

    // pogledi
    const splashView = document.getElementById('splashView');
    const entryView = document.getElementById('entryView');
    const workersView = document.getElementById('workersView');
    const goEntryBtn = document.getElementById('goEntry');
    const goOverviewBtn = document.getElementById('goOverview');
    const goWorkersBtn = document.getElementById('goWorkers');
    const headerLogo = document.getElementById('headerLogo');
    const workersSummary = document.getElementById('workersSummary');

    function showView(id) {
      [splashView, entryView, workersView].forEach(v => v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    goEntryBtn.addEventListener('click', () => showView('entryView'));
    goOverviewBtn.addEventListener('click', () => showView('entryView'));
    goWorkersBtn.addEventListener('click', () => { renderWorkersSummary(); showView('workersView'); });
    headerLogo.addEventListener('click', () => showView('splashView'));

    // elementi za unos
    const workerInput = document.getElementById('workerInput');
    const siteInput = document.getElementById('siteInput');
    const amountInput = document.getElementById('amountInput');
    const descInput = document.getElementById('descInput');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const addExpenseBtn = document.getElementById('addExpenseBtn');
    const expensesContainer = document.getElementById('expensesContainer');
    const totalsContainer = document.getElementById('totalsContainer');
    const selectedWorkerTotal = document.getElementById('selectedWorkerTotal');
    const workerFilter = document.getElementById('workerFilter');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const printBtn = document.getElementById('printBtn');

    let latestImageDataUrl = null;

    // pametni OCR iznos: prvo tra≈æi broj uz EUR/‚Ç¨, pa najveƒái broj
    function smartExtractAmount(text) {
      if (!text) return null;
      const lower = text.toLowerCase();

      // broj uz eur/euro/‚Ç¨
      const euroRegex = /(eur|euro|‚Ç¨)\s*([0-9]+(?:[.,][0-9]{1,2})?)/g;
      let match;
      let best = null;
      while ((match = euroRegex.exec(lower)) !== null) {
        const val = parseFloat(match[2].replace(',', '.'));
        if (!isNaN(val) && (best === null || val > best)) best = val;
      }
      if (best !== null) return best.toString();

      // svi brojevi s decimalom do 100000
      const numRegex = /([0-9]+(?:[.,][0-9]{1,2}))/g;
      let maxVal = null;
      while ((match = numRegex.exec(lower)) !== null) {
        const v = parseFloat(match[1].replace(',', '.'));
        if (!isNaN(v) && v > 0 && v <= 100000 && (maxVal === null || v > maxVal)) {
          maxVal = v;
        }
      }
      if (maxVal !== null) return maxVal.toString();

      return null;
    }

    // slika + OCR
    imageInput.addEventListener('change', () => {
      const file = imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (evt) => {
        latestImageDataUrl = evt.target.result;
        previewImg.src = latestImageDataUrl;
        imagePreview.style.display = 'block';

        if (window.Tesseract) {
          try {
            const res = await Tesseract.recognize(latestImageDataUrl, 'eng', { logger: m => console.log(m) });
            const amountStr = smartExtractAmount(res.data.text);
            if (amountStr) amountInput.value = amountStr;
          } catch (e) {
            console.warn('OCR error', e);
          }
        }
      };
      reader.readAsDataURL(file);
    });

    // dodavanje tro≈°ka
    addExpenseBtn.addEventListener('click', () => {
      const worker = workerInput.value.trim();
      const site = siteInput.value.trim();
      const amount = parseFloat((amountInput.value || '0').replace(',', '.'));
      const desc = descInput.value.trim();

      if (!worker || isNaN(amount)) {
        alert('Unesi ime radnika i ispravan iznos.');
        return;
      }

      const exp = {
        id: Date.now(),
        worker,
        site,
        amount,
        desc,
        image: latestImageDataUrl || null,
        date: new Date().toISOString()
      };
      expenses.push(exp);
      saveExpenses(expenses);

      workerInput.value = '';
      siteInput.value = '';
      amountInput.value = '';
      descInput.value = '';
      renderAll();
    });

    function renderAll() {
      // dropdown radnika
      const workers = [...new Set(expenses.map(e => e.worker))].sort();
      const current = workerFilter.value;
      workerFilter.innerHTML = '<option value="">Svi radnici</option>';
      workers.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.textContent = w;
        if (w === current) opt.selected = true;
        workerFilter.appendChild(opt);
      });

      const filterVal = workerFilter.value;
      const filtered = filterVal
        ? expenses.filter(e => e.worker === filterVal)
        : expenses.slice().sort((a, b) => b.date.localeCompare(a.date) * -1);

      if (!filtered.length) {
        expensesContainer.innerHTML = '<p>Nema upisanih tro≈°kova.</p>';
      } else {
        let html = '<table><thead><tr><th>Datum</th><th>Radnik</th><th>Gradili≈°te</th><th>Iznos</th><th>Opis</th></tr></thead><tbody>';
        filtered.forEach(e => {
          const d = new Date(e.date);
          const ds = d.toLocaleDateString('hr-HR') + ' ' +
            d.toLocaleTimeString('hr-HR', { hour: '2-digit', minute: '2-digit' });
          html += '<tr>' +
            '<td>' + ds + '</td>' +
            '<td>' + e.worker + '</td>' +
            '<td>' + (e.site || '') + '</td>' +
            '<td>' + e.amount.toFixed(2) + '</td>' +
            '<td>' + (e.desc || '') + '</td>' +
            '</tr>';
        });
        html += '</tbody></table>';
        expensesContainer.innerHTML = html;
      }

      // ukupno po svim radnicima
      const totals = {};
      expenses.forEach(e => {
        totals[e.worker] = (totals[e.worker] || 0) + e.amount;
      });
      if (!Object.keys(totals).length) {
        totalsContainer.innerHTML = '';
      } else {
        let tHtml = '<strong>Ukupno po radniku (svi tro≈°kovi):</strong><br>';
        Object.keys(totals).forEach(w => {
          tHtml += w + ': ' + totals[w].toFixed(2) + ' ‚Ç¨<br>';
        });
        totalsContainer.innerHTML = tHtml;
      }

      // ukupno za odabranog radnika (trenutni filter)
      if (filterVal && filtered.length) {
        const sumSel = filtered.reduce((s, e) => s + e.amount, 0);
        selectedWorkerTotal.innerHTML =
          '<strong>Ukupno za radnika ' + filterVal + ' (trenutni filter):</strong> ' +
          sumSel.toFixed(2) + ' ‚Ç¨';
      } else {
        selectedWorkerTotal.innerHTML = '';
      }

      // update ekrana po radniku
      renderWorkersSummary();
    }

    workerFilter.addEventListener('change', () => {
      renderAll();
      showView('entryView');
    });

    function renderWorkersSummary() {
      if (!expenses.length) {
        workersSummary.innerHTML = '<p>Nema podataka.</p>';
        return;
      }
      const agg = {};
      expenses.forEach(e => {
        if (!agg[e.worker]) agg[e.worker] = { total: 0, count: 0 };
        agg[e.worker].total += e.amount;
        agg[e.worker].count += 1;
      });
      let html = '<table><thead><tr><th>Radnik</th><th>Broj tro≈°kova</th><th>Ukupno</th><th></th></tr></thead><tbody>';
      Object.keys(agg).forEach(w => {
        const info = agg[w];
        html += '<tr>' +
          '<td>' + w + '</td>' +
          '<td>' + info.count + '</td>' +
          '<td>' + info.total.toFixed(2) + ' ‚Ç¨</td>' +
          '<td><button data-worker="' + w + '" class="btnShowWorker">Prika≈æi</button></td>' +
          '</tr>';
      });
      html += '</tbody></table>';
      workersSummary.innerHTML = html;

      const btns = workersSummary.querySelectorAll('.btnShowWorker');
      btns.forEach(btn => {
        btn.addEventListener('click', () => {
          const w = btn.getAttribute('data-worker');
          workerFilter.value = w;
          renderAll();
          showView('entryView');
        });
      });
    }

    // CSV export
    exportCsvBtn.addEventListener('click', () => {
      if (!expenses.length) {
        alert('Nema tro≈°kova za export.');
        return;
      }
      const rows = [['datum', 'radnik', 'gradiliste', 'iznos', 'opis']];
      expenses.forEach(e => {
        rows.push([
          e.date,
          e.worker,
          e.site || '',
          e.amount.toString().replace('.', ','),
          e.desc || ''
        ]);
      });
      const csvContent = rows
        .map(row => row.map(val => '"' + String(val || '').replace(/"/g, '""') + '"').join(';'))
        .join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kob_keramika_troskovi.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    printBtn.addEventListener('click', () => window.print());

    // ako ≈æeli≈° opet offline cache, ovdje mo≈æe iƒái register('sw.js')
    // zasad ga mo≈æemo preskoƒçiti dok sve ne proradi 100%
    // if ('serviceWorker' in navigator) {
    //   window.addEventListener('load', () => {
    //     navigator.serviceWorker.register('sw.js').catch(console.error);
    //   });
    // }

    renderAll();
  </script>
</body>
</html>
