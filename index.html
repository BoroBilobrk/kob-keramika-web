<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>KOB-Keramika ‚Äì Pro obraƒçun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA manifest (ako ga ima≈°) -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- jsPDF za PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #050505;
      --card: #121212;
      --border: #333;
      --accent: #ffffff;
      --accent-soft: #888;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI";
      background: radial-gradient(circle at top, #202020 0, #000 55%);
      color: #fff;
    }

    header {
      position: sticky;
      top: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    header .left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header img.logo {
      height: 42px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
    }

    main {
      padding: 12px;
      max-width: 1100px;
      margin: 0 auto 40px auto;
    }

    .card {
      border-radius: 16px;
      padding: 14px 12px;
      margin-bottom: 12px;
      background: radial-gradient(circle at top left, #1c1c1c, #101010);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .view { display: none; }
    .view.active { display: block; }

    h2 { margin-top: 0; }

    label {
      font-size: 13px;
      display: block;
      margin-top: 8px;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 3px;
      background: #000;
      color: #fff;
      border: 1px solid #333;
      border-radius: 8px;
      font-size: 13px;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 12px;
      background: #fff;
      color: #000;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }

    button.secondary {
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }

    .btn-small {
      width: auto;
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 10px;
      margin-top: 4px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 13px;
    }

    .checkbox-row input {
      width: auto;
      margin-top: 0;
    }

    .section-title {
      margin-top: 4px;
      font-size: 15px;
      font-weight: 700;
      border-bottom: 1px solid #333;
      padding-bottom: 4px;
      margin-bottom: 6px;
    }

    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .openings-header {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .opening-card {
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #141414;
      border: 1px solid #333;
      font-size: 12px;
    }

    .opening-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .opening-meta {
      opacity: 0.85;
    }

    .opening-actions {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #444;
      margin-right: 4px;
      margin-top: 2px;
    }

    #calcOutput {
      font-size: 13px;
      line-height: 1.35;
    }

    @media (min-width: 800px) {
      .layout-split {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 12px;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="left">
    <img src="logo.png" class="logo" alt="Logo">
    <div>
      <div style="font-weight:bold">KOB-Keramika</div>
      <div style="font-size:12px;opacity:0.8">Pro obraƒçun prostorije</div>
    </div>
  </div>
  <div style="font-size:11px;opacity:0.7;">INTERNI ALAT</div>
</header>

<main>

  <!-- HOME VIEW -->
  <section id="homeView" class="view active">
    <div class="card">
      <h2>≈†to ≈æeli≈° raditi?</h2>
      <button id="btnOpenAutoCalc">üìê Automatski obraƒçun prostorije</button>
      <button id="btnOpenMeasures">‚úèÔ∏è Ruƒçni unos mjera (u pripremi)</button>
      <button id="btnOpenCosts">üí∞ Tro≈°kovi (postojeƒái modul)</button>
      <button id="btnOpenPrices">üí∂ Cjenik (postojeƒái modul)</button>
    </div>
  </section>

  <!-- AUTOMATSKI OBRAƒåUN PROSTORIJE -->
  <section id="autoCalcView" class="view">
    <div class="card">
      <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
      <h2>üìê Automatski obraƒçun prostorije</h2>
      <p style="font-size:13px;opacity:0.8;">
        Dimenzije prostorije + otvori (vrata, prozori, ni≈°e...) ‚Üí automatski obraƒçun poda, zidova, hidroizolacije, traka,
        silikona, sokla, stepenica, lajsni i gerunga. Na kraju mo≈æe≈° generirati PDF graƒëevinsku knjigu i CSV za Excel.
      </p>
    </div>

    <div class="layout-split">

      <!-- LIJEVA STRANA ‚Äì UNOS -->
      <div>

        <div class="card">
          <div class="section-title">üìè Osnovne dimenzije prostorije</div>

          <label>Duljina D (m)
            <input type="number" id="dimD" step="0.001" placeholder="npr. 4.20">
          </label>

          <label>≈†irina ≈† (m)
            <input type="number" id="dimS" step="0.001" placeholder="npr. 3.10">
          </label>

          <label>Visina V (m)
            <input type="number" id="dimV" step="0.001" placeholder="npr. 2.65">
          </label>
        </div>

        <div class="card">
          <div class="section-title">‚òë ≈†to se raƒçuna?</div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkPod">
            <label for="chkPod">Pod (m¬≤)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkZidovi">
            <label for="chkZidovi">Zidovi (bruto + odbitak vrata)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkHidroPod">
            <label for="chkHidroPod">Hidroizolacija ‚Äì pod</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkHidroTus">
            <label for="chkHidroTus">Hidroizolacija ‚Äì tu≈° zona</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkHidroTraka">
            <label for="chkHidroTraka">Hidro traka</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkSilikon">
            <label for="chkSilikon">Silikon</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkSokl">
            <label for="chkSokl">Sokl</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkStepenice">
            <label for="chkStepenice">Stepenice</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkLajsne">
            <label for="chkLajsne">Lajsne (ukupno)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkGerung">
            <label for="chkGerung">Gerung (ukupno)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkDodatne">
            <label for="chkDodatne">Dodatne mjere (3 polja)</label>
          </div>
        </div>

        <!-- Tu≈° zona -->
        <div class="card" id="cardTus" style="display:none;">
          <div class="section-title">üöø Tu≈° zona</div>
          <div class="two-col">
            <label>Duljina tu≈°a (m)
              <input type="number" id="tusD" step="0.001">
            </label>
            <label>≈†irina tu≈°a (m)
              <input type="number" id="tusS" step="0.001">
            </label>
          </div>
          <label>Visina tu≈°a (m)
            <input type="number" id="tusV" step="0.001" value="2.65">
          </label>
        </div>

        <!-- Silikon ‚Äì vi≈°e visina -->
        <div class="card" id="cardSilikon" style="display:none;">
          <div class="section-title">üßº Silikon ‚Äì visine</div>
          <p style="font-size:12px;opacity:0.8;">Ako prostor ima vi≈°e visina, upi≈°i ih redom (zbrajaju se).</p>
          <label>Visina 1 (m)
            <input type="number" id="silV1" step="0.001">
          </label>
          <label>Visina 2 (m)
            <input type="number" id="silV2" step="0.001">
          </label>
          <label>Visina 3 (m)
            <input type="number" id="silV3" step="0.001">
          </label>
        </div>

        <!-- Sokl -->
        <div class="card" id="cardSokl" style="display:none;">
          <div class="section-title">üìè Sokl ‚Äì korekcije</div>
          <label>Odbijanje sokla (m)
            <input type="number" id="soklMinus" step="0.001">
          </label>
          <label>Dodatno sokla (m)
            <input type="number" id="soklPlus" step="0.001">
          </label>
        </div>

        <!-- Stepenice -->
        <div class="card" id="cardStepenice" style="display:none;">
          <div class="section-title">ü™ú Stepenice</div>
          <label>≈†irina stepenice (m)
            <input type="number" id="stepWidth" step="0.001">
          </label>
          <label>Broj stepenica (kom)
            <input type="number" id="stepCount" step="1">
          </label>
          <label>Vrsta obraƒçuna
            <select id="stepMode">
              <option value="duzni">Du≈æni metri</option>
              <option value="komada">Komada</option>
            </select>
          </label>
        </div>

        <!-- Lajsne manual -->
        <div class="card" id="cardLajsne" style="display:none;">
          <div class="section-title">üîπ Lajsne ‚Äì ruƒçni metri</div>
          <label>Lajsna 1 (m)
            <input type="number" id="l1" step="0.001">
          </label>
          <label>Lajsna 2 (m)
            <input type="number" id="l2" step="0.001">
          </label>
          <label>Lajsna 3 (m)
            <input type="number" id="l3" step="0.001">
          </label>
        </div>

        <!-- Gerung manual -->
        <div class="card" id="cardGerung" style="display:none;">
          <div class="section-title">üî™ Gerung ‚Äì ruƒçni metri</div>
          <label>Gerung 1 (m)
            <input type="number" id="g1" step="0.001">
          </label>
          <label>Gerung 2 (m)
            <input type="number" id="g2" step="0.001">
          </label>
          <label>Gerung 3 (m)
            <input type="number" id="g3" step="0.001">
          </label>
        </div>

        <!-- Dodatne mjere -->
        <div class="card" id="cardDodatne" style="display:none;">
          <div class="section-title">‚ûï Dodatne mjere (3 polja)</div>
          <label>Mjera 1
            <input type="number" id="dm1" step="0.001">
          </label>
          <label>Mjera 2
            <input type="number" id="dm2" step="0.001">
          </label>
          <label>Mjera 3
            <input type="number" id="dm3" step="0.001">
          </label>
          <div class="section-title">Gdje se dodaje?</div>
          <div class="checkbox-row"><input type="checkbox" id="dmPod"><label for="dmPod">Pod</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmZidovi"><label for="dmZidovi">Zidovi</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmHidro"><label for="dmHidro">Hidro</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmSilikon"><label for="dmSilikon">Silikon</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmTraka"><label for="dmTraka">Hidro traka</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmSokl"><label for="dmSokl">Sokl</label></div>
        </div>

        <!-- Gumbi za izraƒçun -->
        <div class="card">
          <button id="btnCalcNow">üîç Izraƒçunaj sve</button>
          <button id="btnExportPdfAuto" class="secondary">üìÑ PDF ‚Äì graƒëevinska knjiga</button>
          <button id="btnExportCsvAuto" class="secondary">üìë CSV ‚Äì Excel export</button>
        </div>

      </div>

      <!-- DESNA STRANA ‚Äì OTVORI + REZULTATI -->
      <div>

        <!-- Otvori kao kartice -->
        <div class="card">
          <div class="section-title">üß± Otvori (vrata, prozori, ni≈°e...)</div>
          <p style="font-size:12px;opacity:0.8;">
            Vrata se odbijaju od zidova. Ostali otvori slu≈æe za obraƒçun rubova (silikon, lajsne, gerung).
          </p>
          <div class="openings-header">
            <button id="btnAddDoor"   class="btn-small">‚ûï Vrata</button>
            <button id="btnAddWindow" class="btn-small">‚ûï Prozor</button>
            <button id="btnAddGeberit" class="btn-small">‚ûï Geberit</button>
            <button id="btnAddNiche"  class="btn-small">‚ûï Ni≈°a</button>
            <button id="btnAddCustom" class="btn-small">‚ûï Custom otvor</button>
          </div>
          <div id="openingsList"></div>
        </div>

        <!-- Rezultati -->
        <div class="card" id="calcResult" style="display:none;">
          <h3>üìä Rezultati obraƒçuna</h3>
          <div id="calcOutput"></div>
        </div>

      </div>

    </div>
  </section>

</main>

<script>
/* ------------ POMOƒÜNE FUNKCIJE / STATE ------------ */
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

document.getElementById('btnOpenAutoCalc').onclick = () => showView('autoCalcView');
document.getElementById('btnOpenMeasures').onclick = () => alert("Ruƒçni modul mjera ƒáe se naknadno preseliti na novi engine.");
document.getElementById('btnOpenCosts').onclick = () => alert("Modul tro≈°kova ostaje kao posebna stranica.");
document.getElementById('btnOpenPrices').onclick = () => alert("Cjenik i backup ostaju kao u postojeƒáoj verziji.");

// poka≈æi/sakrij kartice prema kvaƒçicama
function bindToggle(chkId, cardId) {
  const chk = document.getElementById(chkId);
  const card = document.getElementById(cardId);
  if (!chk || !card) return;
  chk.addEventListener('change', () => {
    card.style.display = chk.checked ? 'block' : 'none';
  });
}
bindToggle('chkHidroTus', 'cardTus');
bindToggle('chkSilikon', 'cardSilikon');
bindToggle('chkSokl', 'cardSokl');
bindToggle('chkStepenice', 'cardStepenice');
bindToggle('chkLajsne', 'cardLajsne');
bindToggle('chkGerung', 'cardGerung');
bindToggle('chkDodatne', 'cardDodatne');

// OTVORI ‚Äì kartice
let openings = []; // {id, type, label, w, h, count, subtract}

// generiraj ID
function newId() {
  return 'o_' + Math.random().toString(36).substr(2, 9);
}

// dodavanje otvora putem prompt prozora (jednostavno za sada)
function addOpening(type) {
  let label;
  if (type === 'vrata') label = 'Vrata';
  else if (type === 'prozor') label = 'Prozor';
  else if (type === 'geberit') label = 'Geberit';
  else if (type === 'nisa') label = 'Ni≈°a';
  else label = prompt("Naziv otvora:", "Custom otvor") || "Custom otvor";

  const w = parseFloat(prompt(label + " - ≈°irina (m):", "0.9") || "0") || 0;
  const h = parseFloat(prompt(label + " - visina (m):", "2.0") || "0") || 0;
  const c = parseInt(prompt(label + " - komada:", "1") || "0") || 0;

  if (!w || !h || !c) {
    alert("Nije unesena puna dimenzija ‚Äì otvor je preskoƒçen.");
    return;
  }

  const subtract = (type === 'vrata'); // samo vrata odbijaju zidove

  openings.push({ id: newId(), type, label, w, h, count: c, subtract });
  renderOpenings();
}

function deleteOpening(id) {
  openings = openings.filter(o => o.id !== id);
  renderOpenings();
}

function renderOpenings() {
  const list = document.getElementById('openingsList');
  if (!openings.length) {
    list.innerHTML = '<p style="font-size:12px;opacity:0.7;">Nema unesenih otvora.</p>';
    return;
  }
  let html = '';
  openings.forEach(o => {
    const perim = 2 * (o.w + o.h) * o.count;
    const area = (o.w * o.h * o.count);
    html += `
      <div class="opening-card">
        <div class="opening-title">${o.label}</div>
        <div class="opening-meta">
          Tip: ${o.type}<br>
          ≈†=${o.w} m, V=${o.h} m, kom=${o.count}<br>
          Povr≈°ina: ${area.toFixed(3)} m¬≤<br>
          Obod (rubovi): ${perim.toFixed(3)} m
        </div>
        <div style="margin-top:4px;">
          <span class="tag">${o.subtract ? "Odbija zidove: DA" : "Odbija zidove: NE"}</span>
          <span class="tag">Rubovi za silikon/lajsne/gerung</span>
        </div>
        <div class="opening-actions">
          <button class="btn-small secondary" onclick="deleteOpening('${o.id}')">üóë Obri≈°i</button>
        </div>
      </div>
    `;
  });
  list.innerHTML = html;
}

document.getElementById('btnAddDoor').onclick    = () => addOpening('vrata');
document.getElementById('btnAddWindow').onclick  = () => addOpening('prozor');
document.getElementById('btnAddGeberit').onclick = () => addOpening('geberit');
document.getElementById('btnAddNiche').onclick   = () => addOpening('nisa');
document.getElementById('btnAddCustom').onclick  = () => addOpening('custom');

// Glavni izraƒçun
let lastCalc = null;

function runAutoCalc(showHtml = true) {
  const D = parseFloat(document.getElementById('dimD').value) || 0;
  const S = parseFloat(document.getElementById('dimS').value) || 0;
  const V = parseFloat(document.getElementById('dimV').value) || 0;

  const chkPod        = document.getElementById('chkPod').checked;
  const chkZidovi     = document.getElementById('chkZidovi').checked;
  const chkHidroPod   = document.getElementById('chkHidroPod').checked;
  const chkHidroTus   = document.getElementById('chkHidroTus').checked;
  const chkHidroTraka = document.getElementById('chkHidroTraka').checked;
  const chkSilikon    = document.getElementById('chkSilikon').checked;
  const chkSokl       = document.getElementById('chkSokl').checked;
  const chkStepenice  = document.getElementById('chkStepenice').checked;
  const chkLajsne     = document.getElementById('chkLajsne').checked;
  const chkGerung     = document.getElementById('chkGerung').checked;
  const chkDodatne    = document.getElementById('chkDodatne').checked;

  let html = `<h4>Dimenzije prostorije:</h4>
    D = ${D} m<br>
    ≈† = ${S} m<br>
    V = ${V} m<br><br>`;

  const results = {};

  // POD
  if (chkPod) {
    const pod = D * S;
    results.pod = pod;
    html += `<b>Pod:</b><br>D √ó ≈† = ${D} √ó ${S} = <b>${pod.toFixed(3)} m¬≤</b><br><br>`;
  }

  // ZIDOVI bruto
  let zidoviBruto = 0;
  if (chkZidovi) {
    zidoviBruto = 2 * (D * V) + 2 * (S * V);
    // odbijanje samo vrata
    let areaVrata = 0;
    openings.forEach(o => {
      if (o.subtract) {
        areaVrata += o.w * o.h * o.count;
      }
    });
    const zidoviNeto = zidoviBruto - areaVrata;
    results.zidoviBruto = zidoviBruto;
    results.zidoviNeto  = zidoviNeto;
    results.odbitakVrata = areaVrata;

    html += `<b>Zidovi:</b><br>`;
    html += `Bruto = 2√ó(D√óV) + 2√ó(≈†√óV) = ${zidoviBruto.toFixed(3)} m¬≤<br>`;
    html += `Odbitak vrata = ${areaVrata.toFixed(3)} m¬≤<br>`;
    html += `Neto zidovi = <b>${zidoviNeto.toFixed(3)} m¬≤</b><br><br>`;
  }

  // HIDRO POD
  let hidroPod = 0;
  if (chkHidroPod) {
    hidroPod = D * S;
    results.hidroPod = hidroPod;
    html += `<b>Hidro ‚Äì pod:</b><br>D √ó ≈† = ${D} √ó ${S} = <b>${hidroPod.toFixed(3)} m¬≤</b><br><br>`;
  }

  // HIDRO TU≈†
  let hidroTus = 0;
  if (chkHidroTus) {
    const td = parseFloat(document.getElementById('tusD').value) || 0;
    const ts = parseFloat(document.getElementById('tusS').value) || 0;
    const tv = parseFloat(document.getElementById('tusV').value) || 0;
    const opsegTus = 2 * (td + ts);
    hidroTus = opsegTus * tv;
    results.hidroTus = hidroTus;
    results.tus = { td, ts, tv, opseg: opsegTus };

    html += `<b>Hidro ‚Äì tu≈° zona:</b><br>`;
    html += `Opseg tu≈°a = 2√ó(d+≈°) = 2√ó(${td}+${ts}) = ${opsegTus.toFixed(3)} m<br>`;
    html += `Hidro tu≈° = opseg √ó visina = ${opsegTus.toFixed(3)} √ó ${tv} = <b>${hidroTus.toFixed(3)} m¬≤</b><br><br>`;
  }

  // HIDRO TRAKA
  let hidroTraka = 0;
  if (chkHidroTraka) {
    hidroTraka = 2 * D + 2 * S + 2 * V;
    results.hidroTraka = hidroTraka;
    html += `<b>Hidro traka:</b><br>(2√óD)+(2√ó≈†)+(2√óV) = <b>${hidroTraka.toFixed(3)} m</b><br><br>`;
  }

  // RUBOVI OTVORA (za silikon / lajsne / gerung)
  let totalOpeningPerim = 0;
  openings.forEach(o => {
    const perim = 2 * (o.w + o.h) * o.count;
    totalOpeningPerim += perim;
  });

  // SILIKON
  let silikon = 0;
  if (chkSilikon) {
    const v1 = parseFloat(document.getElementById('silV1').value) || 0;
    const v2 = parseFloat(document.getElementById('silV2').value) || 0;
    const v3 = parseFloat(document.getElementById('silV3').value) || 0;
    const opseg = 2 * (D + S);
    const dodatno = 4 * (v1 + v2 + v3);
    silikon = opseg + dodatno + totalOpeningPerim;

    results.silikon = silikon;
    results.silikonData = { v1, v2, v3, opseg, dodatno, openings: totalOpeningPerim };

    html += `<b>Silikon:</b><br>`;
    html += `Osnovni opseg poda: 2√ó(D+≈†) = ${opseg.toFixed(3)} m<br>`;
    html += `Visine: 4√ó(v1+v2+v3) = ${dodatno.toFixed(3)} m<br>`;
    html += `Rubovi otvora: ${totalOpeningPerim.toFixed(3)} m<br>`;
    html += `Ukupno silikon = <b>${silikon.toFixed(3)} m</b><br><br>`;
  }

  // SOKL
  let sokl = 0;
  if (chkSokl) {
    const osnovni = 2 * (D + S);
    const minus = parseFloat(document.getElementById('soklMinus').value) || 0;
    const plus  = parseFloat(document.getElementById('soklPlus').value)  || 0;
    sokl = osnovni - minus + plus;
    results.sokl = sokl;
    results.soklData = { osnovni, minus, plus };

    html += `<b>Sokl:</b><br>`;
    html += `Osnovni opseg: 2√ó(D+≈†) = ${osnovni.toFixed(3)} m<br>`;
    html += `‚àí odbijanje: ${minus} m<br>`;
    html += `+ dodatno: ${plus} m<br>`;
    html += `Ukupno sokl = <b>${sokl.toFixed(3)} m</b><br><br>`;
  }

  // STEPENICE
  let stepenice = 0;
  if (chkStepenice) {
    const sw = parseFloat(document.getElementById('stepWidth').value) || 0;
    const sc = parseInt(document.getElementById('stepCount').value) || 0;
    const mode = document.getElementById('stepMode').value || 'duzni';
    stepenice = sw * sc;
    results.stepenice = { vrijednost: stepenice, mode, sw, sc };

    html += `<b>Stepenice:</b><br>`;
    html += `≈†irina √ó komada = ${sw} √ó ${sc} = <b>${stepenice.toFixed(3)} ${mode === 'duzni' ? 'm' : 'kom'}</b><br><br>`;
  }

  // LAJSNE
  let lajsne = 0;
  if (chkLajsne) {
    const L1 = parseFloat(document.getElementById('l1').value) || 0;
    const L2 = parseFloat(document.getElementById('l2').value) || 0;
    const L3 = parseFloat(document.getElementById('l3').value) || 0;
    lajsne = L1 + L2 + L3 + totalOpeningPerim;
    results.lajsne = lajsne;
    results.lajsneData = { L1, L2, L3, openings: totalOpeningPerim };

    html += `<b>Lajsne:</b><br>`;
    html += `Ruƒçno: ${L1 + L2 + L3} m<br>`;
    html += `Rubovi otvora: ${totalOpeningPerim.toFixed(3)} m<br>`;
    html += `Ukupno lajsne = <b>${lajsne.toFixed(3)} m</b><br><br>`;
  }

  // GERUNG
  let gerung = 0;
  if (chkGerung) {
    const G1 = parseFloat(document.getElementById('g1').value) || 0;
    const G2 = parseFloat(document.getElementById('g2').value) || 0;
    const G3 = parseFloat(document.getElementById('g3').value) || 0;
    gerung = G1 + G2 + G3 + totalOpeningPerim;
    results.gerung = gerung;
    results.gerungData = { G1, G2, G3, openings: totalOpeningPerim };

    html += `<b>Gerung:</b><br>`;
    html += `Ruƒçno: ${G1 + G2 + G3} m<br>`;
    html += `Rubovi otvora: ${totalOpeningPerim.toFixed(3)} m<br>`;
    html += `Ukupno gerung = <b>${gerung.toFixed(3)} m</b><br><br>`;
  }

  // DODATNE MJERE
  let dm1v = parseFloat(document.getElementById('dm1').value) || 0;
  let dm2v = parseFloat(document.getElementById('dm2').value) || 0;
  let dm3v = parseFloat(document.getElementById('dm3').value) || 0;
  let dmTotal = dm1v + dm2v + dm3v;
  const dmPod     = document.getElementById('dmPod').checked;
  const dmZidovi  = document.getElementById('dmZidovi').checked;
  const dmHidro   = document.getElementById('dmHidro').checked;
  const dmSil     = document.getElementById('dmSilikon').checked;
  const dmTraka   = document.getElementById('dmTraka').checked;
  const dmSokl    = document.getElementById('dmSokl').checked;

  if (chkDodatne) {
    html += `<b>Dodatne mjere:</b><br>`;
    html += `Mjera 1 = ${dm1v}<br>`;
    html += `Mjera 2 = ${dm2v}<br>`;
    html += `Mjera 3 = ${dm3v}<br>`;
    html += `Ukupno dodatno = ${dmTotal}<br><br>`;

    if (dmPod && results.pod != null)       results.pod       += dmTotal;
    if (dmZidovi && results.zidoviNeto != null) results.zidoviNeto += dmTotal;
    if (dmHidro && results.hidroPod != null) results.hidroPod += dmTotal;
    if (dmSil && results.silikon != null)    results.silikon  += dmTotal;
    if (dmTraka && results.hidroTraka != null) results.hidroTraka += dmTotal;
    if (dmSokl && results.sokl != null)      results.sokl     += dmTotal;
  }

  lastCalc = {
    D, S, V,
    openings,
    results
  };

  if (showHtml) {
    document.getElementById('calcOutput').innerHTML = html;
    document.getElementById('calcResult').style.display = 'block';
  }

  return lastCalc;
}

// BTN Izraƒçunaj
document.getElementById('btnCalcNow').addEventListener('click', () => {
  runAutoCalc(true);
});

// PDF EXPORT
document.getElementById('btnExportPdfAuto').addEventListener('click', () => {
  const data = runAutoCalc(true);
  if (!data) {
    alert("Prvo izraƒçunaj.");
    return;
  }
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) {
    alert("PDF modul nije uƒçitan.");
    return;
  }
  const doc = new jsPDF();
  let y = 15;
  doc.setFontSize(14);
  doc.text("KOB-Keramika ‚Äì Graƒëevinska knjiga (auto obraƒçun)", 10, y);
  y += 8;
  doc.setFontSize(11);
  doc.text(`Dimenzije: D=${data.D} m, ≈†=${data.S} m, V=${data.V} m`, 10, y);
  y += 8;

  function w(text) {
    const lines = doc.splitTextToSize(text, 190);
    lines.forEach(line => {
      if (y > 280) { doc.addPage(); y = 15; }
      doc.text(line, 10, y);
      y += 5;
    });
  }

  const r = data.results;

  if (r.pod != null) {
    w(`POD: ${r.pod.toFixed(3)} m¬≤`);
    y += 2;
  }
  if (r.zidoviNeto != null) {
    w(`ZIDOVI: Neto ${r.zidoviNeto.toFixed(3)} m¬≤ (Bruto ${(r.zidoviBruto || 0).toFixed(3)} m¬≤, odbitak vrata ${(r.odbitakVrata || 0).toFixed(3)} m¬≤)`);
    y += 2;
  }
  if (r.hidroPod != null) {
    w(`HIDRO POD: ${r.hidroPod.toFixed(3)} m¬≤`);
    y += 2;
  }
  if (r.hidroTus != null) {
    w(`HIDRO TU≈† ZONA: ${r.hidroTus.toFixed(3)} m¬≤`);
    y += 2;
  }
  if (r.hidroTraka != null) {
    w(`HIDRO TRAKA: ${r.hidroTraka.toFixed(3)} m`);
    y += 2;
  }
  if (r.silikon != null) {
    w(`SILIKON: ${r.silikon.toFixed(3)} m`);
    y += 2;
  }
  if (r.sokl != null) {
    w(`SOKL: ${r.sokl.toFixed(3)} m`);
    y += 2;
  }
  if (r.stepenice != null) {
    w(`STEPENICE: ${r.stepenice.vrijednost.toFixed(3)} ${r.stepenice.mode === 'duzni' ? 'm' : 'kom'}`);
    y += 2;
  }
  if (r.lajsne != null) {
    w(`LAJSNE: ${r.lajsne.toFixed(3)} m`);
    y += 2;
  }
  if (r.gerung != null) {
    w(`GERUNG: ${r.gerung.toFixed(3)} m`);
    y += 2;
  }

  if (data.openings && data.openings.length) {
    y += 4;
    w("OTVORI:");
    data.openings.forEach(o => {
      w(`- ${o.label}: ≈†=${o.w} m, V=${o.h} m, kom=${o.count}, odbija zidove: ${o.subtract ? 'DA' : 'NE'}`);
    });
  }

  doc.save("kob-keramika-gradevinska-knjiga.pdf");
});

// CSV EXPORT
document.getElementById('btnExportCsvAuto').addEventListener('click', () => {
  const data = runAutoCalc(true);
  if (!data) {
    alert("Prvo izraƒçunaj.");
    return;
  }
  const r = data.results;
  const rows = [];
  const push = (name, val, unit, note="") => {
    rows.push([name, String(val), unit, note]);
  };

  push("Duljina", data.D, "m");
  push("≈†irina", data.S, "m");
  push("Visina", data.V, "m");

  if (r.pod != null)        push("Pod", r.pod.toFixed(3), "m2", "D√ó≈†");
  if (r.zidoviNeto != null) push("Zidovi neto", r.zidoviNeto.toFixed(3), "m2", "2(DV)+2(SV) - vrata");
  if (r.hidroPod != null)   push("Hidro pod", r.hidroPod.toFixed(3), "m2", "");
  if (r.hidroTus != null)   push("Hidro tu≈° zona", r.hidroTus.toFixed(3), "m2", "");
  if (r.hidroTraka != null) push("Hidro traka", r.hidroTraka.toFixed(3), "m", "");
  if (r.silikon != null)    push("Silikon", r.silikon.toFixed(3), "m", "");
  if (r.sokl != null)       push("Sokl", r.sokl.toFixed(3), "m", "");
  if (r.stepenice != null)  push("Stepenice", r.stepenice.vrijednost.toFixed(3), (r.stepenice.mode === 'duzni' ? "m" : "kom"), "");
  if (r.lajsne != null)     push("Lajsne", r.lajsne.toFixed(3), "m", "");
  if (r.gerung != null)     push("Gerung", r.gerung.toFixed(3), "m", "");

  if (data.openings && data.openings.length) {
    data.openings.forEach(o => {
      push(
        `Otvor - ${o.label}`,
        (o.w * o.h * o.count).toFixed(3),
        "m2",
        `≈†=${o.w}, V=${o.h}, kom=${o.count}, odbija=${o.subtract?'DA':'NE'}`
      );
    });
  }

  const header = ["Naziv","Vrijednost","Jedinica","Opis"];
  const csv = [header].concat(rows)
    .map(row => row.map(v => `"${String(v).replace(/"/g,'""')}"`).join(";"))
    .join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "kob-keramika-auto-obracun.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
