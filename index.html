<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>KOB-Keramika ‚Äì Pro obraƒçun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- OCR -->
  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase (opcionalno) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #050505;
      --card: #121212;
      --border: #333;
      --accent: #ffffff;
      --accent-soft: #888;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI";
      background: radial-gradient(circle at top, #202020 0, #000 55%);
      color: #fff;
    }

    header {
      position: sticky;
      top: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header img.logo {
      height: 42px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
      cursor: pointer;
    }

    .view { display: none; }
    .view.active { display: block; }

    main { padding: 12px; max-width: 1000px; margin: 0 auto; }

    .card {
      border-radius: 16px;
      padding: 14px 12px;
      margin-bottom: 12px;
      background: radial-gradient(circle at top left, #1c1c1c, #101010);
      border: 1px solid rgba(255,255,255,0.06);
    }

    label { font-size: 14px; display: block; margin-top: 10px; }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      background: #000;
      color: #fff;
      border: 1px solid #333;
      border-radius: 8px;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-top: 12px;
      border-radius: 12px;
      background: #fff;
      color: #000;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .checkbox-row input {
      width: auto;
    }

    .section-title {
      margin-top: 16px;
      font-size: 16px;
      font-weight: bold;
      border-bottom: 1px solid #333;
      padding-bottom: 4px;
    }

  </style>
</head>
<body>

<header>
  <div class="left">
    <img src="logo.png" class="logo" id="headerLogo" />
    <div>
      <div style="font-weight:bold">KOB-Keramika</div>
      <div style="font-size:12px;opacity:0.8">Pro obraƒçun prostorije</div>
    </div>
  </div>
  <div>INTERNI</div>
</header>

<main>

  <!-- HOME VIEW -->
  <section id="homeView" class="view active">
    <div class="card">
      <h2>≈†to ≈æeli≈° raditi?</h2>
      <button id="btnOpenAutoCalc">üìê Automatski obraƒçun prostorije</button>
      <button id="btnOpenMeasures">‚úèÔ∏è Ruƒçni unos mjera</button>
      <button id="btnOpenCosts">üí∞ Tro≈°kovi</button>
      <button id="btnOpenPrices">üí∂ Cjenik</button>
    </div>
  </section>

  <!-- NOVI AUTOMATSKI OBRAƒåUN PROSTORIJE -->
  <section id="autoCalcView" class="view">

    <div class="card">
      <button onclick="showView('homeView')" style="background:#333;color:#fff;">‚Üê Natrag</button>
      <h2>üìê Automatski obraƒçun prostorije</h2>
      <p>Ovdje se dimenzijama automatski izraƒçunava: pod, zidovi, hidro, trake, silikon, sokl, stepenice, lajsne, gerung i dodatne mjere.</p>
    </div>

    <div class="card">
      <div class="section-title">üìè Osnovne dimenzije prostorije</div>

      <label>Duljina (m)
        <input type="number" id="dimD" step="0.001">
      </label>

      <label>≈†irina (m)
        <input type="number" id="dimS" step="0.001">
      </label>

      <label>Visina (m)
        <input type="number" id="dimV" step="0.001">
      </label>
    </div>

    <div class="card">
      <div class="section-title">‚òë ≈†to se raƒçuna?</div>

      <div class="checkbox-row">
        <input type="checkbox" id="chkPod">
        <label for="chkPod">Pod</label>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="chkZidovi">
        <label for="chkZidovi">Zidovi (bez odbijanja)</label>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="chkHidroPod">
        <label for="chkHidroPod">Hidroizolacija pod</label>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="chkHidroTus">
        <label for="chkHidroTus">Hidroizolacija tu≈° zona</label>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="chkHidroTraka">
        <label for="chkHidroTraka">Hidroizolacijska traka</label>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="chkSilikon">
        <label for="chkSilikon">Silikon</label>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="chkSokl">
        <label for="chkSokl">Sokl</label>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="chkStepenice">
        <label for="chkStepenice">Stepenice</label>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="chkLajsne">
        <label for="chkLajsne">Lajsne (prozor / vertikala)</label>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="chkGerung">
        <label for="chkGerung">Gerung (ruƒçno)</label>
      </div>

      <div class="checkbox-row">
        <input type="checkbox" id="chkDodatne">
        <label for="chkDodatne">Dodatne mjere (3 polja)</label>
      </div>
    </div>

    
    <!-- TU≈† ZONA -->
    <div class="card" id="cardTus" style="display:none;">
      <div class="section-title">üöø Tu≈° zona</div>

      <label>Duljina tu≈°a (m)
        <input type="number" id="tusD" step="0.001">
      </label>

      <label>≈†irina tu≈°a (m)
        <input type="number" id="tusS" step="0.001">
      </label>

      <label>Visina tu≈°a (m)
        <input type="number" id="tusV" value="2.65" step="0.001">
      </label>
    </div>

    <!-- SILIKON ‚Äì VI≈†E VISINA -->
    <div class="card" id="cardSilikon" style="display:none;">
      <div class="section-title">üßº Silikon ‚Äì visine</div>
      <p style="font-size:13px;opacity:0.7;">Ako prostor ima vi≈°e visina, upi≈°i ih redom.</p>

      <label>Visina 1 (m)
        <input type="number" id="silV1" step="0.001">
      </label>
      <label>Visina 2 (m)
        <input type="number" id="silV2" step="0.001">
      </label>
      <label>Visina 3 (m)
        <input type="number" id="silV3" step="0.001">
      </label>
    </div>

    <!-- SOKL -->
    <div class="card" id="cardSokl" style="display:none;">
      <div class="section-title">üìè Sokl ‚Äì dodaci i odbijanja</div>

      <label>Odbijanje sokla (m)
        <input type="number" id="soklMinus" step="0.001">
      </label>

      <label>Dodatno sokla (m)
        <input type="number" id="soklPlus" step="0.001">
      </label>
    </div>

    <!-- STEPENICE -->
    <div class="card" id="cardStepenice" style="display:none;">
      <div class="section-title">ü™ú Stepenice</div>
      <label>≈†irina stepenice (m)
        <input type="number" id="stepWidth" step="0.001">
      </label>

      <label>Broj stepenica
        <input type="number" id="stepCount" step="1">
      </label>

      <label>Vrsta obraƒçuna
        <select id="stepMode">
          <option value="duzni">Du≈æni metri</option>
          <option value="komada">Komada</option>
        </select>
      </label>
    </div>

    <!-- LAJSNE -->
    <div class="card" id="cardLajsne" style="display:none;">
      <div class="section-title">üîπ Lajsne (ruƒçni unos)</div>

      <label>Lajsna 1 (m)
        <input type="number" id="l1" step="0.001">
      </label>

      <label>Lajsna 2 (m)
        <input type="number" id="l2" step="0.001">
      </label>

      <label>Lajsna 3 (m)
        <input type="number" id="l3" step="0.001">
      </label>
    </div>

    <!-- GERUNG -->
    <div class="card" id="cardGerung" style="display:none;">
      <div class="section-title">üî™ Gerung (ruƒçno)</div>

      <label>Gerung 1 (m)
        <input type="number" id="g1" step="0.001">
      </label>

      <label>Gerung 2 (m)
        <input type="number" id="g2" step="0.001">
      </label>

      <label>Gerung 3 (m)
        <input type="number" id="g3" step="0.001">
      </label>
    </div>

    <!-- DODATNE MJERE -->
    <div class="card" id="cardDodatne" style="display:none;">
      <div class="section-title">‚ûï Dodatne mjere (3 polja)</div>

      <label>Mjera 1 (m¬≤ ili m)
        <input type="number" id="dm1" step="0.001">
      </label>

      <label>Mjera 2 (m¬≤ ili m)
        <input type="number" id="dm2" step="0.001">
      </label>

      <label>Mjera 3 (m¬≤ ili m)
        <input type="number" id="dm3" step="0.001">
      </label>

      <div class="section-title">Gdje se dodaje?</div>

      <label><input type="checkbox" id="dmPod"> Pod</label>
      <label><input type="checkbox" id="dmZidovi"> Zidovi</label>
      <label><input type="checkbox" id="dmHidro"> Hidro</label>
      <label><input type="checkbox" id="dmSilikon"> Silikon</label>
      <label><input type="checkbox" id="dmTraka"> Hidro traka</label>
      <label><input type="checkbox" id="dmSokl"> Sokl</label>
    </div>

    <!-- GUMB ZA IZRAƒåUN -->
    <div class="card">
      <button id="btnCalcNow">üîç Izraƒçunaj sve</button>
    </div>

    <!-- PRIKAZ REZULTATA -->
    <div class="card" id="calcResult" style="display:none;">
      <h3>üìä Rezultati obraƒçuna</h3>
      <div id="calcOutput"></div>
    </div>

  </section>
<script>
// Helper: prebacivanje izmeƒëu pogleda
function showView(viewId) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const el = document.getElementById(viewId);
  if (el) el.classList.add('active');
}

// Navigacija s poƒçetne
document.getElementById('btnOpenAutoCalc').onclick = () => showView('autoCalcView');
document.getElementById('btnOpenMeasures').onclick = () => alert("Ruƒçni modul mjera ostaje za kasnije pro≈°irenje.");
document.getElementById('btnOpenCosts').onclick = () => alert("Modul tro≈°kova je u staroj verziji ‚Äì ovdje fokus na auto obraƒçun.");
document.getElementById('btnOpenPrices').onclick = () => alert("Cjenik i backup ostaju kao u web verziji ‚Äì mo≈æe se naknadno spojiti.");

// Pomoƒána funkcija za prikaz / skrivanje kartica po kvaƒçici
function toggleCard(chkId, cardId) {
  const cb = document.getElementById(chkId);
  const card = document.getElementById(cardId);
  if (!cb || !card) return;
  cb.addEventListener('change', () => {
    card.style.display = cb.checked ? 'block' : 'none';
  });
}

// Ve≈æemo sve podsustave
toggleCard("chkHidroTus", "cardTus");
toggleCard("chkSilikon", "cardSilikon");
toggleCard("chkSokl", "cardSokl");
toggleCard("chkStepenice", "cardStepenice");
toggleCard("chkLajsne", "cardLajsne");
toggleCard("chkGerung", "cardGerung");
toggleCard("chkDodatne", "cardDodatne");

// Elementi koje ƒçesto koristimo
const dimD = document.getElementById("dimD");
const dimS = document.getElementById("dimS");
const dimV = document.getElementById("dimV");

const chkPod        = document.getElementById("chkPod");
const chkZidovi     = document.getElementById("chkZidovi");
const chkHidroPod   = document.getElementById("chkHidroPod");
const chkHidroTus   = document.getElementById("chkHidroTus");
const chkHidroTraka = document.getElementById("chkHidroTraka");
const chkSilikon    = document.getElementById("chkSilikon");
const chkSokl       = document.getElementById("chkSokl");
const chkStepenice  = document.getElementById("chkStepenice");
const chkLajsne     = document.getElementById("chkLajsne");
const chkGerung     = document.getElementById("chkGerung");
const chkDodatne    = document.getElementById("chkDodatne");

// Tu≈°
const tusD = document.getElementById("tusD");
const tusS = document.getElementById("tusS");
const tusV = document.getElementById("tusV");

// Silikon visine
const silV1 = document.getElementById("silV1");
const silV2 = document.getElementById("silV2");
const silV3 = document.getElementById("silV3");

// Sokl
const soklMinus = document.getElementById("soklMinus");
const soklPlus  = document.getElementById("soklPlus");

// Stepenice
const stepWidth = document.getElementById("stepWidth");
const stepCount = document.getElementById("stepCount");
const stepMode  = document.getElementById("stepMode");

// Lajsne
const l1 = document.getElementById("l1");
const l2 = document.getElementById("l2");
const l3 = document.getElementById("l3");

// Gerung
const g1 = document.getElementById("g1");
const g2 = document.getElementById("g2");
const g3 = document.getElementById("g3");

// Dodatne mjere
const dm1 = document.getElementById("dm1");
const dm2 = document.getElementById("dm2");
const dm3 = document.getElementById("dm3");

const dmPod     = document.getElementById("dmPod");
const dmZidovi  = document.getElementById("dmZidovi");
const dmHidro   = document.getElementById("dmHidro");
const dmSilikon = document.getElementById("dmSilikon");
const dmTraka   = document.getElementById("dmTraka");
const dmSokl    = document.getElementById("dmSokl");

// Rezultati
const calcResult  = document.getElementById("calcResult");
const calcOutput  = document.getElementById("calcOutput");
const btnCalcNow  = document.getElementById("btnCalcNow");
const btnPdf      = document.getElementById("btnExportPdfAuto");
const btnCsv      = document.getElementById("btnExportCsvAuto");

// U ovo spremamo zadnji izraƒçun da ga PDF / CSV mogu koristiti
let lastCalc = null;

/**
 * Glavna funkcija: radi obraƒçun, vraƒáa objekt i (opcionalno) ispisuje HTML.
 */
function runAutoCalc(showHtml = true) {
  // Osnovne dimenzije
  const D = parseFloat(dimD.value) || 0;
  const S = parseFloat(dimS.value) || 0;
  const V = parseFloat(dimV.value) || 0;

  let html = "<h4>Dimenzije prostorije:</h4>";
  html += `D = ${D} m<br>`;
  html += `≈† = ${S} m<br>`;
  html += `V = ${V} m<br><br>`;

  // POD
  let pod = 0;
  if (chkPod.checked) {
    pod = D * S;
    html += `<b>Pod:</b><br>D √ó ≈† = ${D} √ó ${S} = <b>${pod.toFixed(3)} m¬≤</b><br><br>`;
  }

  // ZIDOVI (bez odbijanja ‚Äì odbijanja bi i≈°la kasnije)
  let zidovi = 0;
  if (chkZidovi.checked) {
    zidovi = 2 * (D + S) * V;
    html += `<b>Zidovi:</b><br>2 √ó (D + ≈†) √ó V = 2 √ó (${D}+${S}) √ó ${V} = <b>${zidovi.toFixed(3)} m¬≤</b><br><br>`;
  }

  // HIDRO POD
  let hidroPod = 0;
  if (chkHidroPod.checked) {
    hidroPod = D * S;
    html += `<b>Hidro pod:</b><br>D √ó ≈† = ${D} √ó ${S} = <b>${hidroPod.toFixed(3)} m¬≤</b><br><br>`;
  }

  // HIDRO TU≈† ZONA
  let hidroTus = 0;
  let tusOpseg = 0;
  let td=0, ts=0, tv=0;
  if (chkHidroTus.checked) {
    td = parseFloat(tusD.value) || 0;
    ts = parseFloat(tusS.value) || 0;
    tv = parseFloat(tusV.value) || 0;

    tusOpseg = 2 * (td + ts);
    hidroTus = tusOpseg * tv;

    html += `<b>Hidro tu≈° zona:</b><br>`;
    html += `Opseg tu≈°a = 2 √ó (d+≈°) = 2√ó(${td}+${ts}) = ${tusOpseg.toFixed(3)} m<br>`;
    html += `Hidro tu≈° = opseg √ó visina = ${tusOpseg.toFixed(3)} √ó ${tv} = <b>${hidroTus.toFixed(3)} m¬≤</b><br><br>`;
  }

  // HIDRO TRAKA
  let hidroTraka = 0;
  if (chkHidroTraka.checked) {
    hidroTraka = (2 * D) + (2 * S) + (2 * V);
    html += `<b>Hidro traka:</b><br>(2√óD)+(2√ó≈†)+(2√óV) = <b>${hidroTraka.toFixed(3)} m</b><br><br>`;
  }

  // SILIKON ‚Äì vi≈°e visina
  let silikon = 0;
  let silOpseg = 0;
  let silVisineTerm = 0;
  let sv1=0,sv2=0,sv3=0;
  if (chkSilikon.checked) {
    sv1 = parseFloat(silV1.value) || 0;
    sv2 = parseFloat(silV2.value) || 0;
    sv3 = parseFloat(silV3.value) || 0;

    silOpseg = 2 * (D + S);
    silVisineTerm = 4 * (sv1 + sv2 + sv3);

    silikon = silOpseg + silVisineTerm;

    html += `<b>Silikon:</b><br>`;
    html += `2√ó(D+≈†) = ${silOpseg.toFixed(3)} m<br>`;
    html += `4√ó(v1+v2+v3) = 4√ó(${sv1}+${sv2}+${sv3}) = ${silVisineTerm.toFixed(3)} m<br>`;
    html += `Ukupno = <b>${silikon.toFixed(3)} m</b><br><br>`;
  }

  // SOKL
  let sokl = 0;
  let soklOsnovni = 0;
  let soklMinusVal = 0;
  let soklPlusVal  = 0;
  if (chkSokl.checked) {
    soklOsnovni = 2 * (D + S);
    soklMinusVal = parseFloat(soklMinus.value) || 0;
    soklPlusVal = parseFloat(soklPlus.value) || 0;

    sokl = soklOsnovni - soklMinusVal + soklPlusVal;

    html += `<b>Sokl:</b><br>`;
    html += `Osnovni opseg = 2√ó(D+≈†) = ${soklOsnovni.toFixed(3)} m<br>`;
    html += `‚àí odbijanje = ${soklMinusVal} m<br>`;
    html += `+ dodatno = ${soklPlusVal} m<br>`;
    html += `Ukupno = <b>${sokl.toFixed(3)} m</b><br><br>`;
  }

  // STEPENICE ‚Äì tvoj model: ≈°irina √ó komada
  let stepenice = 0;
  let sw=0, sc=0, stepModeVal="duzni";
  if (chkStepenice.checked) {
    sw = parseFloat(stepWidth.value) || 0;
    sc = parseInt(stepCount.value) || 0;
    stepModeVal = stepMode.value || "duzni";

    stepenice = sw * sc;

    html += `<b>Stepenice:</b><br>`;
    html += `≈†irina √ó broj = ${sw} √ó ${sc} = <b>${stepenice.toFixed(3)} ${stepModeVal === 'duzni' ? 'm' : 'kom'}</b><br><br>`;
  }

  // LAJSNE
  let lajsne = 0;
  let L1=0,L2=0,L3=0;
  if (chkLajsne.checked) {
    L1 = parseFloat(l1.value) || 0;
    L2 = parseFloat(l2.value) || 0;
    L3 = parseFloat(l3.value) || 0;
    lajsne = L1 + L2 + L3;

    html += `<b>Lajsne (ruƒçno):</b><br>`;
    html += `L1 + L2 + L3 = ${L1}+${L2}+${L3} = <b>${lajsne.toFixed(3)} m</b><br><br>`;
  }

  // GERUNG
  let gerung = 0;
  let G1=0,G2=0,G3=0;
  if (chkGerung.checked) {
    G1 = parseFloat(g1.value) || 0;
    G2 = parseFloat(g2.value) || 0;
    G3 = parseFloat(g3.value) || 0;
    gerung = G1 + G2 + G3;

    html += `<b>Gerung (ruƒçno):</b><br>`;
    html += `G1 + G2 + G3 = ${G1}+${G2}+${G3} = <b>${gerung.toFixed(3)} m</b><br><br>`;
  }

  // DODATNE MJERE
  let dm1v = parseFloat(dm1.value) || 0;
  let dm2v = parseFloat(dm2.value) || 0;
  let dm3v = parseFloat(dm3.value) || 0;
  let dmTotal = dm1v + dm2v + dm3v;

  if (chkDodatne.checked) {
    html += `<b>Dodatne mjere:</b><br>`;
    html += `Mjera 1 = ${dm1v}<br>`;
    html += `Mjera 2 = ${dm2v}<br>`;
    html += `Mjera 3 = ${dm3v}<br><br>`;
  }

  // Integracija dodatnih mjera
  if (chkDodatne.checked) {
    if (dmPod.checked)     pod        += dmTotal;
    if (dmZidovi.checked)  zidovi     += dmTotal;
    if (dmHidro.checked)   hidroPod   += dmTotal;
    if (dmSilikon.checked) silikon    += dmTotal;
    if (dmTraka.checked)   hidroTraka += dmTotal;
    if (dmSokl.checked)    sokl       += dmTotal;
  }

  // Spremanje u globalni objekt
  lastCalc = {
    D, S, V,
    flags: {
      pod: chkPod.checked,
      zidovi: chkZidovi.checked,
      hidroPod: chkHidroPod.checked,
      hidroTus: chkHidroTus.checked,
      hidroTraka: chkHidroTraka.checked,
      silikon: chkSilikon.checked,
      sokl: chkSokl.checked,
      stepenice: chkStepenice.checked,
      lajsne: chkLajsne.checked,
      gerung: chkGerung.checked,
      dodatne: chkDodatne.checked
    },
    tus: { d: td, s: ts, v: tv, opseg: tusOpseg, m2: hidroTus },
    silikonData: { v1: sv1, v2: sv2, v3: sv3, opseg: silOpseg, dodatno: silVisineTerm, ukupno: silikon },
    soklData: { osnovni: soklOsnovni, minus: soklMinusVal, plus: soklPlusVal, ukupno: sokl },
    stepeniceData: { sirina: sw, komada: sc, mode: stepModeVal, vrijednost: stepenice },
    lajsneData: { L1, L2, L3, ukupno: lajsne },
    gerungData: { G1, G2, G3, ukupno: gerung },
    dodatneData: { dm1: dm1v, dm2: dm2v, dm3: dm3v, total: dmTotal },
    results: {
      pod,
      zidovi,
      hidroPod,
      hidroTus,
      hidroUkupno: hidroPod + hidroTus,
      hidroTraka,
      silikon,
      sokl,
      stepenice,
      lajsne,
      gerung
    },
    html
  };

  if (showHtml) {
    calcOutput.innerHTML = html;
    calcResult.style.display = "block";
  }

  return lastCalc;
}

// Klik na "Izraƒçunaj"
btnCalcNow.addEventListener("click", () => {
  runAutoCalc(true);
});

// Export PDF ‚Äì graƒëevinska knjiga / dokaznica mjera (auto obraƒçun)
btnPdf.addEventListener("click", () => {
  const state = runAutoCalc(true); // osigura da imamo svje≈æe

  if (!state) {
    alert("Nema podataka za PDF. Prvo izraƒçunaj.");
    return;
  }
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) {
    alert("PDF modul (jsPDF) nije uƒçitan.");
    return;
  }

  const doc = new jsPDF();

  // Naslov
  doc.setFontSize(16);
  doc.text("KOB-Keramika ‚Äì Graƒëevinska knjiga (auto obraƒçun)", 10, 15);
  doc.setFontSize(11);
  doc.text(`Dimenzije prostorije: D=${state.D} m, ≈†=${state.S} m, V=${state.V} m`, 10, 23);

  let y = 30;
  doc.setFontSize(10);

  function writeLine(text) {
    const lines = doc.splitTextToSize(text, 190);
    lines.forEach(line => {
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      doc.text(line, 10, y);
      y += 5;
    });
  }

  // Pod
  if (state.flags.pod) {
    writeLine("POD:");
    writeLine(`  Formula: D √ó ≈† = ${state.D} √ó ${state.S}`);
    writeLine(`  Rezultat: ${state.results.pod.toFixed(3)} m¬≤`);
    y += 2;
  }

  // Zidovi
  if (state.flags.zidovi) {
    writeLine("ZIDOVI:");
    writeLine(`  Formula: 2 √ó (D + ≈†) √ó V = 2 √ó (${state.D}+${state.S}) √ó ${state.V}`);
    writeLine(`  Rezultat: ${state.results.zidovi.toFixed(3)} m¬≤`);
    y += 2;
  }

  // Hidro pod
  if (state.flags.hidroPod) {
    writeLine("HIDRO ‚Äì POD:");
    writeLine(`  Formula: D √ó ≈† = ${state.D} √ó ${state.S}`);
    writeLine(`  Rezultat: ${state.results.hidroPod.toFixed(3)} m¬≤`);
    y += 2;
  }

  // Hidro tu≈°
  if (state.flags.hidroTus) {
    writeLine("HIDRO ‚Äì TU≈† ZONA:");
    writeLine(`  Opseg tu≈°a: 2√ó(d+≈°) = 2√ó(${state.tus.d}+${state.tus.s}) = ${state.tus.opseg.toFixed(3)} m`);
    writeLine(`  Hidro tu≈°: opseg √ó visina = ${state.tus.opseg.toFixed(3)} √ó ${state.tus.v} = ${state.tus.m2.toFixed(3)} m¬≤`);
    y += 2;
  }

  // Hidro traka
  if (state.flags.hidroTraka) {
    writeLine("HIDRO TRAKA:");
    writeLine(`  Formula: (2√óD)+(2√ó≈†)+(2√óV)`);
    writeLine(`  Rezultat: ${state.results.hidroTraka.toFixed(3)} m`);
    y += 2;
  }

  // Silikon
  if (state.flags.silikon) {
    writeLine("SILIKON:");
    writeLine(`  2√ó(D+≈†) = ${state.silikonData.opseg.toFixed(3)} m`);
    writeLine(`  4√ó(v1+v2+v3) = ${state.silikonData.dodatno.toFixed(3)} m`);
    writeLine(`  Ukupno: ${state.results.silikon.toFixed(3)} m`);
    y += 2;
  }

  // Sokl
  if (state.flags.sokl) {
    writeLine("SOKL:");
    writeLine(`  Osnovni opseg: 2√ó(D+≈†) = ${state.soklData.osnovni.toFixed(3)} m`);
    writeLine(`  ‚àí odbijanje: ${state.soklData.minus} m`);
    writeLine(`  + dodatno: ${state.soklData.plus} m`);
    writeLine(`  Ukupno: ${state.results.sokl.toFixed(3)} m`);
    y += 2;
  }

  // Stepenice
  if (state.flags.stepenice) {
    writeLine("STEPENICE:");
    writeLine(`  ≈†irina √ó komada = ${state.stepeniceData.sirina} √ó ${state.stepeniceData.komada}`);
    writeLine(`  Rezultat: ${state.stepeniceData.vrijednost.toFixed(3)} ${state.stepeniceData.mode === 'duzni' ? 'm' : 'kom'}`);
    y += 2;
  }

  // Lajsne
  if (state.flags.lajsne) {
    writeLine("LAJSNE (ruƒçni unos):");
    writeLine(`  L1=${state.lajsneData.L1}, L2=${state.lajsneData.L2}, L3=${state.lajsneData.L3}`);
    writeLine(`  Ukupno: ${state.lajsneData.ukupno.toFixed(3)} m`);
    y += 2;
  }

  // Gerung
  if (state.flags.gerung) {
    writeLine("GERUNG (ruƒçni unos):");
    writeLine(`  G1=${state.gerungData.G1}, G2=${state.gerungData.G2}, G3=${state.gerungData.G3}`);
    writeLine(`  Ukupno: ${state.gerungData.ukupno.toFixed(3)} m`);
    y += 2;
  }

  // Dodatne mjere
  if (state.flags.dodatne) {
    writeLine("DODATNE MJERE:");
    writeLine(`  Mjera 1: ${state.dodatneData.dm1}`);
    writeLine(`  Mjera 2: ${state.dodatneData.dm2}`);
    writeLine(`  Mjera 3: ${state.dodatneData.dm3}`);
    writeLine(`  Ukupno dodatno: ${state.dodatneData.total}`);
    y += 2;
  }

  doc.save("kob-keramika-gradevinska-knjiga-auto.pdf");
});

// Export CSV ‚Äì za Excel
btnCsv.addEventListener("click", () => {
  const state = runAutoCalc(true);
  if (!state) {
    alert("Nema podataka za CSV. Prvo izraƒçunaj.");
    return;
  }

  const rows = [];
  const push = (naziv, vrijednost, jedinica, opis) => {
    rows.push([naziv, String(vrijednost), jedinica, opis || ""]);
  };

  push("Duljina", state.D, "m", "");
  push("≈†irina",  state.S, "m", "");
  push("Visina",  state.V, "m", "");

  if (state.flags.pod)        push("Pod",        state.results.pod.toFixed(3),        "m2", "D√ó≈†");
  if (state.flags.zidovi)     push("Zidovi",     state.results.zidovi.toFixed(3),     "m2", "2√ó(D+≈†)√óV");
  if (state.flags.hidroPod)   push("Hidro pod",  state.results.hidroPod.toFixed(3),   "m2", "D√ó≈†");
  if (state.flags.hidroTus)   push("Hidro tu≈°",  state.results.hidroTus.toFixed(3),   "m2", "opseg tu≈°a √ó visina");
  if (state.flags.hidroTraka) push("Hidro traka",state.results.hidroTraka.toFixed(3), "m",  "2D+2≈†+2V");
  if (state.flags.silikon)    push("Silikon",    state.results.silikon.toFixed(3),    "m",  "2(D+≈†)+4(v1+v2+v3)");
  if (state.flags.sokl)       push("Sokl",       state.results.sokl.toFixed(3),       "m",  "2(D+≈†)¬±korekcije");
  if (state.flags.stepenice)  push("Stepenice",  state.stepeniceData.vrijednost.toFixed(3),
                                           state.stepeniceData.mode === 'duzni' ? "m" : "kom", "≈°irina√ókom");
  if (state.flags.lajsne)     push("Lajsne",     state.lajsneData.ukupno.toFixed(3),  "m",  "ruƒçno");
  if (state.flags.gerung)     push("Gerung",     state.gerungData.ukupno.toFixed(3),  "m",  "ruƒçno");
  if (state.flags.dodatne)    push("Dodatne",    state.dodatneData.total.toFixed(3),  "",   "3 dodatna polja");

  // Pretvaranje u CSV (odvojen ; da Excel u HR radi ljep≈°e)
  const header = ["Naziv","Vrijednost","Jedinica","Opis"];
  const csv = [header].concat(rows)
    .map(row => row.map(v => `"${String(v).replace(/"/g,'""')}"`).join(";"))
    .join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "kob-keramika-auto-obracun.csv";
  document.body.appendChild(a);
   a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
