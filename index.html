<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>KOB-Keramika</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Tesseract.js za OCR iz slike -->
  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <!-- jsPDF za PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Firebase (OPCIJSKI za cloud backup ‚Äì po defaultu iskljuƒçeno) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #050505;
      --card: #121212;
      --border: #333;
      --accent: #ffffff;
      --accent-soft: #888;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #202020 0, #000 55%);
      color: #fff;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: linear-gradient(90deg, rgba(0,0,0,0.95), rgba(0,0,0,0.9));
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header .left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header img.logo {
      height: 42px;
      width: auto;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      cursor: pointer;
    }
    header .title-block {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    header .app-name { font-weight: 700; font-size: 18px; letter-spacing: 0.06em; }
    header .subtitle { font-size: 11px; color: #ccc; }
    header .tag {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 4px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #ddd;
    }

    main { padding: 12px; max-width: 900px; margin: 0 auto 32px; }
    .card {
      border-radius: 16px;
      padding: 14px 12px;
      margin-bottom: 12px;
      background: radial-gradient(circle at top left, #1c1c1c, #101010);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 14px 35px rgba(0,0,0,0.6);
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(6px); }
      to { opacity:1; transform: translateY(0); }
    }
    h3 { margin-top: 0; font-size: 16px; display:flex; align-items:center; gap:6px;}
    h3 span.emoji { font-size:18px; }

    label {
      font-size: 13px;
      display: block;
      margin-top: 8px;
      color: #ddd;
    }
    input, textarea, select, button {
      width: 100%;
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 14px;
    }
    input:focus, textarea:focus, select:focus {
      outline: 1px solid var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.15);
    }
    button {
      background: var(--accent);
      color: #000;
      font-weight: 600;
      cursor: pointer;
      border-radius: 999px;
      border: none;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.12s;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.7);
    }
    button.secondary {
      background: #181818;
      color: #fff;
      border: 1px solid var(--border);
    }
    button.ghost {
      background: transparent;
      color: #fff;
      border: 1px solid var(--border);
    }
    button:disabled { opacity: 0.35; cursor: default; box-shadow:none; transform:none; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th, td {
      border-bottom: 1px solid #262626;
      padding: 6px 4px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #151515;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .totals { margin-top: 10px; font-size: 13px; }
    .image-preview { margin-top: 8px; text-align: center; }
    .image-preview img {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid #333;
    }
    .actions-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .actions-row button { flex: 1; min-width: 120px; }
    footer {
      text-align: center;
      font-size: 11px;
      color: #777;
      padding: 8px;
      border-top: 1px solid #222;
    }
    .hint {
      font-size: 11px;
      color: #aaa;
      margin-top: 4px;
    }

    .view { display: none; }
    .view.active { display: block; }

    /* HOME big buttons */
    #homeView {
      text-align: center;
      padding-top: 24px;
    }
    #homeLogo {
      width: 180px;
      height: auto;
      margin-bottom: 20px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 18px 40px rgba(0,0,0,0.85);
    }
    .home-buttons {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .home-btn {
      border-radius:18px;
      padding:14px 12px;
      font-size:16px;
      background:#050505;
      border:1px solid rgba(255,255,255,0.2);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .home-btn span.label {
      display:flex;
      align-items:center;
      gap:8px;
    }
    .home-btn span.icon {
      font-size:20px;
    }
    .home-btn small {
      display:block;
      font-size:11px;
      color:#aaa;
    }

    .back-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .back-row h2 {
      margin:0;
      font-size:15px;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .pill-nav {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .pill-nav button {
      flex:1;
      font-size:12px;
      padding:6px 8px;
    }
    .pill-nav button.active {
      background:#fff;
      color:#000;
    }

    .badge {
      display:inline-block;
      border-radius:999px;
      padding:2px 8px;
      font-size:10px;
      border:1px solid #444;
      color:#ccc;
      margin-left:4px;
    }

    .measure-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(135px, 1fr));
      gap:8px 10px;
      margin-top:8px;
    }

    .measure-table-container {
      max-height: 260px;
      overflow:auto;
      margin-top:8px;
      border-radius:8px;
      border:1px solid #262626;
      background:#101010;
      padding:4px;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <img src="logo.png" alt="KOB-Keramika logo" class="logo" id="headerLogo" />
      <div class="title-block">
        <span class="app-name">KOB-Keramika</span>
        <span class="subtitle">Interni alat za tro≈°kove i mjere</span>
      </div>
    </div>
    <div class="tag">INTERNI ALAT</div>
  </header>

  <main>
    <!-- HOME VIEW -->
    <section id="homeView" class="view active">
      <div class="card">
        <img src="logo.png" id="homeLogo" alt="KOB-Keramika logo" />
        <h3><span class="emoji">üëã</span> Odaberi ≈°to ≈æeli≈° raditi</h3>
        <div class="home-buttons">
          <button class="home-btn" id="btnHomeCosts">
            <span class="label"><span class="icon">üí∞</span> TRO≈†KOVI</span>
            <small>Unos raƒçuna, tro≈°kova po radniku i gradili≈°tu</small>
          </button>
          <button class="home-btn" id="btnHomeMeasures">
            <span class="label"><span class="icon">üìê</span> MJERE &amp; GRAƒêEVINSKA KNJIGA</span>
            <small>Mjerenje zidova, podova, sokla... + Graƒëevinska knjiga (PDF)</small>
          </button>
          <button class="home-btn" id="btnHomePrices">
            <span class="label"><span class="icon">üí∂</span> CJENIK RADOVA</span>
            <small>Jediniƒçne cijene (globalno i po gradili≈°tu)</small>
          </button>
        </div>
        <p class="hint" style="margin-top:12px;">
          Savjet: u mobilnom Chromeu odaberi ‚ÄúDodaj na poƒçetni zaslon‚Äù za do≈æivljaj kao prava aplikacija.
        </p>
      </div>
    </section>

    <!-- TRO≈†KOVI VIEW -->
    <section id="costsView" class="view">
      <div class="card">
        <div class="back-row">
          <h2><span>üí∞</span> Tro≈°kovi</h2>
          <button class="ghost" id="btnBackFromCosts">‚Üê Poƒçetna</button>
        </div>
        <p class="hint">Unos i praƒáenje tro≈°kova po radniku i gradili≈°tu. Ovo je odvojeno od graƒëevinske knjige.</p>
      </div>

      <section class="card">
        <h3><span class="emoji">‚ûï</span> Unos tro≈°ka</h3>
        <label>Radnik
          <input type="text" id="workerInput" placeholder="Ime radnika" />
        </label>
        <label>Gradili≈°te
          <input type="text" id="siteInput" placeholder="Naziv gradili≈°ta / projekta" />
        </label>
        <label>Iznos (‚Ç¨)
          <input type="number" step="0.01" id="amountInput" placeholder="0.00" />
        </label>
        <div class="hint">Ako uƒçita≈° sliku raƒçuna, aplikacija ƒáe poku≈°ati automatski proƒçitati iznos (OCR).</div>
        <label>Opis tro≈°ka
          <textarea id="descInput" rows="2" placeholder="Opis"></textarea>
        </label>

        <label>Dokument (kamera ili galerija)
          <input type="file" id="imageInput" accept="image/*" capture="environment" />
        </label>

        <div class="image-preview" id="imagePreview" style="display:none;">
          <p>Zadnji uƒçitani dokument:</p>
          <img id="previewImg" src="" alt="Skenirani dokument" />
        </div>

        <button id="addExpenseBtn">Spremi tro≈°ak</button>
      </section>

      <section class="card">
        <h3><span class="emoji">üìÇ</span> Filtriranje tro≈°kova, PDF i Excel</h3>
        <label>Filter po radniku
          <select id="workerFilter">
            <option value="">Svi radnici</option>
          </select>
        </label>
        <label>Filter po gradili≈°tu
          <select id="siteFilter">
            <option value="">Sva gradili≈°ta</option>
          </select>
        </label>

        <div class="actions-row">
          <button id="exportCsvBtn">CSV (Excel ‚Äì tro≈°kovi)</button>
          <button id="exportPdfBtn" class="secondary">PDF (trenutni prikaz tro≈°kova)</button>
          <button class="ghost" id="printBtn">Print / PDF</button>
        </div>

        <div class="totals" id="selectedWorkerTotal"></div>
      </section>

      <section class="card">
        <h3><span class="emoji">üìã</span> Popis tro≈°kova</h3>
        <div class="pill-nav">
          <button id="btnShowAll" class="secondary active">Svi zapisi</button>
          <button id="btnShowWorker" class="secondary">Samo odabran radnik</button>
        </div>
        <div id="expensesContainer" style="margin-top:8px;"></div>
        <div class="totals" id="totalsContainer"></div>
      </section>

      <section class="card">
        <h3><span class="emoji">üë∑</span> Sa≈æetak po radniku</h3>
        <div id="workersSummary"></div>
        <p class="hint">Dodirni ‚ÄúPrika≈æi‚Äù za filtrirani prikaz tro≈°kova tog radnika.</p>
      </section>
    </section>

    <!-- MJERE VIEW -->
    <section id="measuresView" class="view">
      <div class="card">
        <div class="back-row">
          <h2><span>üìê</span> Mjere &amp; Graƒëevinska knjiga</h2>
          <button class="ghost" id="btnBackFromMeasures">‚Üê Poƒçetna</button>
        </div>
        <p class="hint">Sve vezano za mjerenje ploha, mjerne situacije i generiranje graƒëevinske knjige (bez tro≈°kova).</p>
      </div>

      <!-- MJERENJE PRO -->
      <section class="card">
        <h3><span class="emoji">üìè</span> Mjerenje PRO po gradili≈°tu i prostoriji</h3>
        <label>Gradili≈°te
          <input type="text" id="measureSiteInput" placeholder="npr. Stan Perkoviƒá" />
        </label>
        <label>Prostorija
          <input type="text" id="measureRoomInput" placeholder="npr. Kupaonica, Kuhinja, Hodnik..." />
        </label>

        <label>Vrsta mjere
          <select id="measureTypeSelect">
            <option value="zid_m2">Zid (m¬≤)</option>
            <option value="pod_m2">Pod (m¬≤)</option>
            <option value="sokl_m">Sokl (m)</option>
            <option value="hidro_m2">Hidroizolacija (m¬≤)</option>
            <option value="hidro_traka_m">Hidroizolacijska traka (m)</option>
            <option value="gerung_m">Gerung (m)</option>
            <option value="lajsne_m">Lajsne (m)</option>
            <option value="stepenice_m">Stepenice (m)</option>
          </select>
        </label>

        <div class="measure-grid">
          <div>
            <label>≈†irina (m)
              <input type="number" step="0.001" id="measureWidthInput" placeholder="npr. 1.25" />
            </label>
          </div>
          <div>
            <label>Visina (m)
              <input type="number" step="0.001" id="measureHeightInput" placeholder="npr. 2.40" />
            </label>
          </div>
          <div>
            <label>Du≈æina (m)
              <input type="number" step="0.001" id="measureLengthInput" placeholder="za du≈æne metre" />
            </label>
          </div>
          <div>
            <label>Direktan iznos (m / m¬≤)
              <input type="number" step="0.001" id="measureQtyInput" placeholder="ako veƒá zna≈° koliƒçinu" />
            </label>
          </div>
          <div style="grid-column:1/-1;">
            <label>Napomena (npr. zid iznad kade, pod kupaonice...)
              <input type="text" id="measureNoteInput" placeholder="Opcionalno" />
            </label>
          </div>
        </div>

        <div class="actions-row">
          <button id="btnAddMeasure">‚ûï Dodaj plohu</button>
          <button id="btnClearMeasureFields" class="ghost">Oƒçisti polja</button>
        </div>

        <div class="actions-row" style="margin-top:6px;">
          <button id="btnExportMeasuresCsv" class="secondary">CSV mjere (dokaznica)</button>
          <button id="btnExportMeasuresPdf" class="secondary">PDF mjere (dokaznica)</button>
        </div>

        <div class="measure-table-container" id="measureCurrentTable"></div>
        <div class="totals" id="measuresSummary" style="margin-top:10px;"></div>
        <p class="hint">
          Mjere se organiziraju po <strong>gradili≈°tu</strong> i <strong>prostoriji</strong>.
          Mo≈æe≈° unositi pojedine plohe (≈°irina √ó visina ili du≈æni metar, ili direktan iznos). Sve se automatski zbraja.
        </p>
      </section>

      <!-- GRAƒêEVINSKA KNJIGA -->
      <section class="card">
        <h3><span class="emoji">üìò</span> Graƒëevinska knjiga (PDF)</h3>
        <label>Gradili≈°te (za graƒëevinsku knjigu)
          <input type="text" id="gbSiteInput" placeholder="Ako je prazno, uzet ƒáe se isto kao u mjerenjima" />
        </label>
        <label>Izvoƒëaƒç radova
          <input type="text" id="gbContractorInput" placeholder="npr. KOB-Keramika d.o.o." />
        </label>
        <label>Investitor
          <input type="text" id="gbInvestorInput" placeholder="npr. Ime investitora (opcijski)" />
        </label>
        <div class="measure-grid">
          <div>
            <label>Period od (datum)
              <input type="date" id="gbFromDateInput" />
            </label>
          </div>
          <div>
            <label>Period do (datum)
              <input type="date" id="gbToDateInput" />
            </label>
          </div>
        </div>
        <div class="actions-row">
          <button id="btnExportGbPdf">Generiraj Graƒëevinsku knjigu (PDF)</button>
        </div>
        <p class="hint">
          Graƒëevinska knjiga se automatski generira za odabrano gradili≈°te:<br>
          ‚Äì koristi <strong>mjere</strong> (po prostoriji i vrsti) i <strong>cijene iz cjenika</strong>.<br>
          Tro≈°kovi (raƒçuni) su odvojeni i ne ulaze u graƒëevinsku knjigu.
        </p>
      </section>
    </section>

    <!-- CJENIK VIEW -->
    <section id="pricesView" class="view">
      <div class="card">
        <div class="back-row">
          <h2><span>üí∂</span> Cjenik radova</h2>
          <button class="ghost" id="btnBackFromPrices">‚Üê Poƒçetna</button>
        </div>
        <p class="hint">Globalne i posebne cijene po gradili≈°tu. Koriste se u Graƒëevinskoj knjizi.</p>
      </div>

      <section class="card">
        <h3><span class="emoji">üí∂</span> Globalni cjenik</h3>
        <p class="hint">Vrijedi za sva gradili≈°ta, osim ako za neko ne upi≈°e≈° posebne cijene.</p>
        <div class="measure-grid">
          <div><label>Zid (‚Ç¨/m¬≤) <input type="number" step="0.01" id="priceGlobal_zid_m2" /></label></div>
          <div><label>Pod (‚Ç¨/m¬≤) <input type="number" step="0.01" id="priceGlobal_pod_m2" /></label></div>
          <div><label>Sokl (‚Ç¨/m) <input type="number" step="0.01" id="priceGlobal_sokl_m" /></label></div>
          <div><label>Hidro (‚Ç¨/m¬≤) <input type="number" step="0.01" id="priceGlobal_hidro_m2" /></label></div>
          <div><label>Hidro traka (‚Ç¨/m) <input type="number" step="0.01" id="priceGlobal_hidro_traka_m" /></label></div>
          <div><label>Gerung (‚Ç¨/m) <input type="number" step="0.01" id="priceGlobal_gerung_m" /></label></div>
          <div><label>Lajsne (‚Ç¨/m) <input type="number" step="0.01" id="priceGlobal_lajsne_m" /></label></div>
          <div><label>Stepenice (‚Ç¨/m) <input type="number" step="0.01" id="priceGlobal_stepenice_m" /></label></div>
        </div>
        <div class="actions-row">
          <button id="btnSavePriceGlobal">Spremi globalni cjenik</button>
        </div>
      </section>

      <section class="card">
        <h3><span class="emoji">üìç</span> Cjenik po gradili≈°tu</h3>
        <p class="hint">Ako treba drugaƒçiji obraƒçun za odreƒëeno gradili≈°te.</p>
        <label>Gradili≈°te
          <input type="text" id="priceSiteSiteInput" placeholder="npr. Stan Perkoviƒá" />
        </label>
        <div class="measure-grid">
          <div><label>Zid (‚Ç¨/m¬≤) <input type="number" step="0.01" id="priceSite_zid_m2" /></label></div>
          <div><label>Pod (‚Ç¨/m¬≤) <input type="number" step="0.01" id="priceSite_pod_m2" /></label></div>
          <div><label>Sokl (‚Ç¨/m) <input type="number" step="0.01" id="priceSite_sokl_m" /></label></div>
          <div><label>Hidro (‚Ç¨/m¬≤) <input type="number" step="0.01" id="priceSite_hidro_m2" /></label></div>
          <div><label>Hidro traka (‚Ç¨/m) <input type="number" step="0.01" id="priceSite_hidro_traka_m" /></label></div>
          <div><label>Gerung (‚Ç¨/m) <input type="number" step="0.01" id="priceSite_gerung_m" /></label></div>
          <div><label>Lajsne (‚Ç¨/m) <input type="number" step="0.01" id="priceSite_lajsne_m" /></label></div>
          <div><label>Stepenice (‚Ç¨/m) <input type="number" step="0.01" id="priceSite_stepenice_m" /></label></div>
        </div>
        <div class="actions-row">
          <button id="btnSavePriceSite" class="secondary">Spremi cjenik za gradili≈°te</button>
          <button id="btnClearPriceSite" class="ghost">Obri≈°i posebni cjenik za gradili≈°te</button>
        </div>
      </section>

      <section class="card">
        <h3><span class="emoji">‚òÅÔ∏è</span> Cloud backup / sync <span class="badge">OPCIJSKI</span></h3>
        <label>Sync kod (npr. naziv firme ili ‚Äúkob-produkcija‚Äù)
          <input type="text" id="syncCodeInput" placeholder="npr. kob-keramika-team" />
        </label>
        <div class="actions-row">
          <button id="btnUploadBackup" class="secondary">Spremi u cloud</button>
          <button id="btnDownloadBackup" class="ghost">Uƒçitaj iz clouda</button>
        </div>
        <p class="hint">
          Cloud sync koristi Firebase Firestore i <strong>nije aktivan</strong> dok ne upi≈°e≈° svoje Firebase podatke u kod.
          Trenutno sve radi lokalno i sigurno na ovom ureƒëaju.
        </p>
      </section>
    </section>

    <!-- (radniƒçki view vi≈°e nije poseban ekran, samo kartica gore) -->
  </main>

  <footer>
    KOB-Keramika ‚Äî lokalna PWA aplikacija (tro≈°kovi, mjere, graƒëevinska knjiga, cjenik).
  </footer>

  <script>
    // Kljuƒçevi za lokalnu pohranu
    const STORAGE_KEY = 'kob_keramika_expenses_v5';
    const MEASURES_KEY = 'kob_keramika_measures_v2';
    const PRICELIST_KEY = 'kob_keramika_pricelist_v1';

    // Tipovi mjera
    const MEASURE_TYPES = {
      zid_m2: { label: 'Zid', unit: 'm¬≤', kind: 'area' },
      pod_m2: { label: 'Pod', unit: 'm¬≤', kind: 'area' },
      sokl_m: { label: 'Sokl', unit: 'm', kind: 'length' },
      hidro_m2: { label: 'Hidroizolacija', unit: 'm¬≤', kind: 'area' },
      hidro_traka_m: { label: 'Hidro traka', unit: 'm', kind: 'length' },
      gerung_m: { label: 'Gerung', unit: 'm', kind: 'length' },
      lajsne_m: { label: 'Lajsne', unit: 'm', kind: 'length' },
      stepenice_m: { label: 'Stepenice', unit: 'm', kind: 'length' }
    };

    function loadExpenses() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error('Load error', e);
        return [];
      }
    }
    function saveExpenses(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function loadMeasures() {
      try {
        const raw = localStorage.getItem(MEASURES_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) {
        console.error('Measures load error', e);
        return {};
      }
    }
    function saveMeasures(m) {
      localStorage.setItem(MEASURES_KEY, JSON.stringify(m));
    }

    function loadPricelist() {
      try {
        const raw = localStorage.getItem(PRICELIST_KEY);
        if (!raw) return { global:{}, perSite:{} };
        const obj = JSON.parse(raw);
        if (!obj.global) obj.global = {};
        if (!obj.perSite) obj.perSite = {};
        return obj;
      } catch (e) {
        console.error('Pricelist load error', e);
        return { global:{}, perSite:{} };
      }
    }
    function savePricelist(p) {
      localStorage.setItem(PRICELIST_KEY, JSON.stringify(p));
    }

    let expenses = loadExpenses();
    let measures = loadMeasures(); // { [site]: { [room]: [ {...} ] } }
    let pricelist = loadPricelist();

    // logo za PDF (dataURL)
    let logoDataUrl = null;
    (function loadLogoForPdf() {
      const img = new Image();
      img.src = 'logo.png';
      img.crossOrigin = 'Anonymous';
      img.onload = () => {
        try {
          const canvas = document.createElement('canvas');
          const scale = 0.4;
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          logoDataUrl = canvas.toDataURL('image/png');
        } catch (e) {
          console.warn('Logo toDataURL error', e);
        }
      };
    })();

    function getPriceForType(site, type) {
      const g = pricelist.global || {};
      const ps = (pricelist.perSite && pricelist.perSite[site]) || {};
      if (ps[type] != null && !isNaN(ps[type])) return ps[type];
      if (g[type] != null && !isNaN(g[type])) return g[type];
      return null;
    }

    // -------------------------------------------------------
    // POGLEDI & NAVIGACIJA
    // -------------------------------------------------------
    const homeView = document.getElementById('homeView');
    const costsView = document.getElementById('costsView');
    const measuresView = document.getElementById('measuresView');
    const pricesView = document.getElementById('pricesView');

    const views = [homeView, costsView, measuresView, pricesView];

    const headerLogo = document.getElementById('headerLogo');
    const btnHomeCosts = document.getElementById('btnHomeCosts');
    const btnHomeMeasures = document.getElementById('btnHomeMeasures');
    const btnHomePrices = document.getElementById('btnHomePrices');
    const btnBackFromCosts = document.getElementById('btnBackFromCosts');
    const btnBackFromMeasures = document.getElementById('btnBackFromMeasures');
    const btnBackFromPrices = document.getElementById('btnBackFromPrices');

    function showView(id) {
      views.forEach(v => v.classList.remove('active'));
      const el = document.getElementById(id);
      if (el) el.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'instant' });
    }

    headerLogo.addEventListener('click', () => showView('homeView'));
    btnHomeCosts.addEventListener('click', () => showView('costsView'));
    btnHomeMeasures.addEventListener('click', () => showView('measuresView'));
    btnHomePrices.addEventListener('click', () => showView('pricesView'));
    btnBackFromCosts.addEventListener('click', () => showView('homeView'));
    btnBackFromMeasures.addEventListener('click', () => showView('homeView'));
    btnBackFromPrices.addEventListener('click', () => showView('homeView'));

    // -------------------------------------------------------
    // ELEMENTI TRO≈†KOVA
    // -------------------------------------------------------
    const workerInput = document.getElementById('workerInput');
    const siteInput = document.getElementById('siteInput');
    const amountInput = document.getElementById('amountInput');
    const descInput = document.getElementById('descInput');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const addExpenseBtn = document.getElementById('addExpenseBtn');
    const expensesContainer = document.getElementById('expensesContainer');
    const totalsContainer = document.getElementById('totalsContainer');
    const selectedWorkerTotal = document.getElementById('selectedWorkerTotal');
    const workerFilter = document.getElementById('workerFilter');
    const siteFilter = document.getElementById('siteFilter');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const printBtn = document.getElementById('printBtn');
    const btnShowAll = document.getElementById('btnShowAll');
    const btnShowWorker = document.getElementById('btnShowWorker');
    const syncCodeInput = document.getElementById('syncCodeInput');
    const btnUploadBackup = document.getElementById('btnUploadBackup');
    const btnDownloadBackup = document.getElementById('btnDownloadBackup');
    const workersSummary = document.getElementById('workersSummary');

    let latestImageDataUrl = null;
    let listMode = 'all';

    btnShowAll.addEventListener('click', () => {
      listMode = 'all';
      btnShowAll.classList.add('active');
      btnShowWorker.classList.remove('active');
      renderAll();
    });
    btnShowWorker.addEventListener('click', () => {
      listMode = 'worker';
      btnShowWorker.classList.add('active');
      btnShowAll.classList.remove('active');
      renderAll();
    });

    // -------------------------------------------------------
    // ELEMENTI MJERENJA PRO
    // -------------------------------------------------------
    const measureSiteInput = document.getElementById('measureSiteInput');
    const measureRoomInput = document.getElementById('measureRoomInput');
    const measureTypeSelect = document.getElementById('measureTypeSelect');
    const measureWidthInput = document.getElementById('measureWidthInput');
    const measureHeightInput = document.getElementById('measureHeightInput');
    const measureLengthInput = document.getElementById('measureLengthInput');
    const measureQtyInput = document.getElementById('measureQtyInput');
    const measureNoteInput = document.getElementById('measureNoteInput');
    const btnAddMeasure = document.getElementById('btnAddMeasure');
    const btnClearMeasureFields = document.getElementById('btnClearMeasureFields');
    const btnExportMeasuresCsv = document.getElementById('btnExportMeasuresCsv');
    const btnExportMeasuresPdf = document.getElementById('btnExportMeasuresPdf');
    const measureCurrentTable = document.getElementById('measureCurrentTable');
    const measuresSummary = document.getElementById('measuresSummary');

    // -------------------------------------------------------
    // ELEMENTI CJENIKA
    // -------------------------------------------------------
    const priceGlobalInputs = {
      zid_m2: document.getElementById('priceGlobal_zid_m2'),
      pod_m2: document.getElementById('priceGlobal_pod_m2'),
      sokl_m: document.getElementById('priceGlobal_sokl_m'),
      hidro_m2: document.getElementById('priceGlobal_hidro_m2'),
      hidro_traka_m: document.getElementById('priceGlobal_hidro_traka_m'),
      gerung_m: document.getElementById('priceGlobal_gerung_m'),
      lajsne_m: document.getElementById('priceGlobal_lajsne_m'),
      stepenice_m: document.getElementById('priceGlobal_stepenice_m')
    };
    const priceSiteSiteInput = document.getElementById('priceSiteSiteInput');
    const priceSiteInputs = {
      zid_m2: document.getElementById('priceSite_zid_m2'),
      pod_m2: document.getElementById('priceSite_pod_m2'),
      sokl_m: document.getElementById('priceSite_sokl_m'),
      hidro_m2: document.getElementById('priceSite_hidro_m2'),
      hidro_traka_m: document.getElementById('priceSite_hidro_traka_m'),
      gerung_m: document.getElementById('priceSite_gerung_m'),
      lajsne_m: document.getElementById('priceSite_lajsne_m'),
      stepenice_m: document.getElementById('priceSite_stepenice_m')
    };
    const btnSavePriceGlobal = document.getElementById('btnSavePriceGlobal');
    const btnSavePriceSite = document.getElementById('btnSavePriceSite');
    const btnClearPriceSite = document.getElementById('btnClearPriceSite');

    // -------------------------------------------------------
    // ELEMENTI GRAƒêEVINSKE KNJIGE
    // -------------------------------------------------------
    const gbSiteInput = document.getElementById('gbSiteInput');
    const gbContractorInput = document.getElementById('gbContractorInput');
    const gbInvestorInput = document.getElementById('gbInvestorInput');
    const gbFromDateInput = document.getElementById('gbFromDateInput');
    const gbToDateInput = document.getElementById('gbToDateInput');
    const btnExportGbPdf = document.getElementById('btnExportGbPdf');

    // veza mjerenja -> gbSite & priceSite
    measureSiteInput.addEventListener('input', () => {
      if (!gbSiteInput.value.trim()) gbSiteInput.value = measureSiteInput.value;
      if (!priceSiteSiteInput.value.trim()) priceSiteSiteInput.value = measureSiteInput.value;
      renderPriceSiteFields();
    });

    priceSiteSiteInput.addEventListener('change', renderPriceSiteFields);
    priceSiteSiteInput.addEventListener('input', renderPriceSiteFields);

    // -------------------------------------------------------
    // OCR ZA IZNOS
    // -------------------------------------------------------
    function smartExtractAmount(text) {
      if (!text) return null;
      const lower = text.toLowerCase();
      const lines = lower.split(/\r?\n/);

      function findAmountInLine(line) {
        const numRegex = /([0-9]+(?:[.,][0-9]{1,2}))/g;
        let m, max = null;
        while ((m = numRegex.exec(line)) !== null) {
          const v = parseFloat(m[1].replace(',', '.'));
          if (!isNaN(v) && v > 0 && v <= 100000 && (max === null || v > max)) {
            max = v;
          }
        }
        return max;
      }

      const keywords = ['ukupno', 'za plaƒáanje', 'za platiti', 'total', 'gesamt', 'sveukupno'];
      for (const line of lines) {
        if (keywords.some(k => line.includes(k))) {
          const found = findAmountInLine(line);
          if (found !== null) return found.toString();
        }
      }

      const euroRegex = /(eur|euro|‚Ç¨)\s*([0-9]+(?:[.,][0-9]{1,2})?)/g;
      let match, best = null;
      while ((match = euroRegex.exec(lower)) !== null) {
        const val = parseFloat(match[2].replace(',', '.'));
        if (!isNaN(val) && (best === null || val > best)) best = val;
      }
      if (best !== null) return best.toString();

      let globalMax = null;
      for (const line of lines) {
        const val = findAmountInLine(line);
        if (val !== null && (globalMax === null || val > globalMax)) {
          globalMax = val;
        }
      }
      return globalMax !== null ? globalMax.toString() : null;
    }

    imageInput.addEventListener('change', () => {
      const file = imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (evt) => {
        latestImageDataUrl = evt.target.result;
        previewImg.src = latestImageDataUrl;
        imagePreview.style.display = 'block';

        if (window.Tesseract) {
          try {
            const res = await Tesseract.recognize(latestImageDataUrl, 'eng', { logger: m => console.log(m) });
            const amountStr = smartExtractAmount(res.data.text);
            if (amountStr) amountInput.value = amountStr;
          } catch (e) {
            console.warn('OCR error', e);
          }
        }
      };
      reader.readAsDataURL(file);
    });

    // -------------------------------------------------------
    // DODAVANJE TRO≈†KA
    // -------------------------------------------------------
    addExpenseBtn.addEventListener('click', () => {
      const worker = workerInput.value.trim();
      const site = siteInput.value.trim();
      const amount = parseFloat((amountInput.value || '0').replace(',', '.'));
      const desc = descInput.value.trim();

      if (!worker || isNaN(amount)) {
        alert('Unesi ime radnika i ispravan iznos.');
        return;
      }

      const exp = {
        id: Date.now(),
        worker,
        site,
        amount,
        desc,
        image: latestImageDataUrl || null,
        date: new Date().toISOString()
      };
      expenses.push(exp);
      saveExpenses(expenses);

      workerInput.value = '';
      siteInput.value = '';
      amountInput.value = '';
      descInput.value = '';
      renderAll();
    });

    // -------------------------------------------------------
    // MJERENJE PRO ‚Äì DODAVANJE PLOHE
    // -------------------------------------------------------
    btnAddMeasure.addEventListener('click', () => {
      const site = measureSiteInput.value.trim();
      const room = measureRoomInput.value.trim();
      const type = measureTypeSelect.value;

      if (!site || !room) {
        alert('Upi≈°i naziv gradili≈°ta i prostorije.');
        return;
      }
      const meta = MEASURE_TYPES[type];
      if (!meta) {
        alert('Odaberi tip mjere.');
        return;
      }

      const direct = parseFloat((measureQtyInput.value || '0').replace(',', '.'));
      const w = parseFloat((measureWidthInput.value || '0').replace(',', '.'));
      const h = parseFloat((measureHeightInput.value || '0').replace(',', '.'));
      const L = parseFloat((measureLengthInput.value || '0').replace(',', '.'));

      let qty = null;

      if (!isNaN(direct) && direct > 0) {
        qty = direct;
      } else if (meta.kind === 'area') {
        if (!isNaN(w) && w > 0 && !isNaN(h) && h > 0) qty = w * h;
      } else if (meta.kind === 'length') {
        if (!isNaN(L) && L > 0) qty = L;
      }

      if (qty === null) {
        alert('Unesi dimenzije ili direktnu koliƒçinu.');
        return;
      }

      if (!measures[site]) measures[site] = {};
      if (!measures[site][room]) measures[site][room] = [];
      measures[site][room].push({
        id: Date.now(),
        type,
        qty,
        width: !isNaN(w) && w > 0 ? w : null,
        height: !isNaN(h) && h > 0 ? h : null,
        length: !isNaN(L) && L > 0 ? L : null,
        note: measureNoteInput.value.trim() || '',
        ts: new Date().toISOString()
      });
      saveMeasures(measures);

      renderMeasuresCurrent();
      renderMeasuresSummary();
    });

    btnClearMeasureFields.addEventListener('click', () => {
      measureWidthInput.value = '';
      measureHeightInput.value = '';
      measureLengthInput.value = '';
      measureQtyInput.value = '';
      measureNoteInput.value = '';
    });

    // -------------------------------------------------------
    // CJENIK ‚Äì RENDER I SPREMANJE
    // -------------------------------------------------------
    function renderPriceGlobalFields() {
      Object.keys(priceGlobalInputs).forEach(t => {
        const val = pricelist.global[t];
        priceGlobalInputs[t].value = (val != null && !isNaN(val)) ? val : '';
      });
    }

    function renderPriceSiteFields() {
      const site = priceSiteSiteInput.value.trim();
      const sitePrices = (pricelist.perSite && pricelist.perSite[site]) || {};
      Object.keys(priceSiteInputs).forEach(t => {
        const val = sitePrices[t];
        priceSiteInputs[t].value = (val != null && !isNaN(val)) ? val : '';
      });
    }

    btnSavePriceGlobal.addEventListener('click', () => {
      if (!pricelist.global) pricelist.global = {};
      Object.keys(priceGlobalInputs).forEach(t => {
        const v = parseFloat(priceGlobalInputs[t].value || 'NaN');
        pricelist.global[t] = isNaN(v) ? null : v;
      });
      savePricelist(pricelist);
      alert('Globalni cjenik spremljen.');
    });

    btnSavePriceSite.addEventListener('click', () => {
      const site = priceSiteSiteInput.value.trim();
      if (!site) {
        alert('Upi≈°i naziv gradili≈°ta za posebni cjenik.');
        return;
      }
      if (!pricelist.perSite) pricelist.perSite = {};
      const obj = {};
      Object.keys(priceSiteInputs).forEach(t => {
        const v = parseFloat(priceSiteInputs[t].value || 'NaN');
        obj[t] = isNaN(v) ? null : v;
      });
      pricelist.perSite[site] = obj;
      savePricelist(pricelist);
      alert('Cjenik za gradili≈°te spremljen.');
    });

    btnClearPriceSite.addEventListener('click', () => {
      const site = priceSiteSiteInput.value.trim();
      if (!site) {
        alert('Upi≈°i naziv gradili≈°ta.');
        return;
      }
      if (pricelist.perSite && pricelist.perSite[site]) {
        delete pricelist.perSite[site];
        savePricelist(pricelist);
        renderPriceSiteFields();
        alert('Posebni cjenik za gradili≈°te obrisan (koristit ƒáe se globalni).');
      } else {
        alert('Za to gradili≈°te nema posebnog cjenika.');
      }
    });

    // -------------------------------------------------------
    // RENDER MJERA ZA AKTUALNO GRADILI≈†TE/PROSTORIJU
    // -------------------------------------------------------
    function renderMeasuresCurrent() {
      const site = measureSiteInput.value.trim();
      const room = measureRoomInput.value.trim();
      if (!site || !room || !measures[site] || !measures[site][room] || !measures[site][room].length) {
        measureCurrentTable.innerHTML = '<p>Nema unesenih ploha za odabrano gradili≈°te/prostoriju.</p>';
        return;
      }
      const list = measures[site][room].slice().sort((a,b) => a.ts.localeCompare(b.ts));
      let html = '<table><thead><tr><th>Vrsta</th><th>Dimenzije</th><th>Koliƒçina</th><th>Napomena</th></tr></thead><tbody>';
      list.forEach(m => {
        const meta = MEASURE_TYPES[m.type] || { label: m.type, unit: '' };
        let dim = '';
        if (m.width && m.height) dim = (m.width + '√ó' + m.height + ' m');
        else if (m.length) dim = m.length + ' m';
        html += '<tr>' +
          '<td>' + meta.label + '</td>' +
          '<td>' + dim + '</td>' +
          '<td>' + m.qty.toFixed(3) + ' ' + meta.unit + '</td>' +
          '<td>' + (m.note || '') + '</td>' +
          '</tr>';
      });
      html += '</tbody></table>';
      measureCurrentTable.innerHTML = html;
    }

    measureSiteInput.addEventListener('change', () => {
      renderMeasuresCurrent();
      renderMeasuresSummary();
    });
    measureRoomInput.addEventListener('change', () => {
      renderMeasuresCurrent();
    });

    // -------------------------------------------------------
    // SA≈ΩETAK MJERA PO GRADILI≈†TU
    // -------------------------------------------------------
    function renderMeasuresSummary() {
      const site = measureSiteInput.value.trim();
      if (!site || !measures[site]) {
        const keys = Object.keys(measures);
        if (!keys.length) {
          measuresSummary.innerHTML = '<p>Nema spremljenih mjerenja.</p>';
          return;
        }
        let html = '<strong>Postoje mjerenja za gradili≈°ta:</strong><br>' + keys.join(', ');
        measuresSummary.innerHTML = html;
        return;
      }

      const rooms = measures[site];
      const totalByType = {};
      Object.keys(rooms).forEach(room => {
        rooms[room].forEach(m => {
          if (!totalByType[m.type]) totalByType[m.type] = 0;
          totalByType[m.type] += m.qty;
        });
      });

      let html = '<strong>Sa≈æetak mjera za gradili≈°te: ' + site + '</strong><br>';
      Object.keys(rooms).sort().forEach(room => {
        html += '<div style="margin-top:6px;"><u>Prostorija: ' + room + '</u><br>';
        const localByType = {};
        rooms[room].forEach(m => {
          if (!localByType[m.type]) localByType[m.type] = 0;
          localByType[m.type] += m.qty;
        });
        Object.keys(localByType).forEach(t => {
          const meta = MEASURE_TYPES[t] || { label: t, unit: '' };
          html += meta.label + ': ' + localByType[t].toFixed(3) + ' ' + meta.unit + '<br>';
        });
        html += '</div>';
      });

      html += '<div style="margin-top:8px;"><strong>Ukupno za gradili≈°te:</strong><br>';
      Object.keys(totalByType).forEach(t => {
        const meta = MEASURE_TYPES[t] || { label: t, unit: '' };
        html += meta.label + ': ' + totalByType[t].toFixed(3) + ' ' + meta.unit + '<br>';
      });
      html += '</div>';

      measuresSummary.innerHTML = html;
    }

    // -------------------------------------------------------
    // RENDER TRO≈†KOVA I SA≈ΩETAKA
    // -------------------------------------------------------
    function renderAll() {
      const workers = [...new Set(expenses.map(e => e.worker))].sort();
      const currentWorker = workerFilter.value;
      workerFilter.innerHTML = '<option value="">Svi radnici</option>';
      workers.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.textContent = w;
        if (w === currentWorker) opt.selected = true;
        workerFilter.appendChild(opt);
      });

      const sites = [...new Set(expenses.map(e => e.site).filter(s => s))].sort();
      const currentSite = siteFilter.value;
      siteFilter.innerHTML = '<option value="">Sva gradili≈°ta</option>';
      sites.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if (s === currentSite) opt.selected = true;
        siteFilter.appendChild(opt);
      });

      const filterWorker = workerFilter.value;
      const filterSite = siteFilter.value;

      let filtered = expenses.slice();
      if (filterWorker) filtered = filtered.filter(e => e.worker === filterWorker);
      if (filterSite) filtered = filtered.filter(e => e.site === filterSite);
      if (listMode === 'worker' && filterWorker) {
        filtered = filtered.filter(e => e.worker === filterWorker);
      }
      filtered.sort((a,b) => b.date.localeCompare(a.date));

      if (!filtered.length) {
        expensesContainer.innerHTML = '<p>Nema upisanih tro≈°kova.</p>';
      } else {
        let html = '<div style="max-height:320px;overflow:auto;"><table><thead><tr>' +
          '<th>Datum</th><th>Radnik</th><th>Gradili≈°te</th><th>Iznos</th><th>Opis</th></tr></thead><tbody>';
        filtered.forEach(e => {
          const d = new Date(e.date);
          const ds = d.toLocaleDateString('hr-HR') + ' ' +
            d.toLocaleTimeString('hr-HR', { hour: '2-digit', minute: '2-digit' });
          html += '<tr>' +
            '<td>' + ds + '</td>' +
            '<td>' + e.worker + '</td>' +
            '<td>' + (e.site || '') + '</td>' +
            '<td>' + e.amount.toFixed(2) + '</td>' +
            '<td>' + (e.desc || '') + '</td>' +
            '</tr>';
        });
        html += '</tbody></table></div>';
        expensesContainer.innerHTML = html;
      }

      const totals = {};
      expenses.forEach(e => {
        totals[e.worker] = (totals[e.worker] || 0) + e.amount;
      });
      if (!Object.keys(totals).length) {
        totalsContainer.innerHTML = '';
      } else {
        let tHtml = '<strong>Ukupno po radniku (svi tro≈°kovi):</strong><br>';
        Object.keys(totals).forEach(w => {
          tHtml += w + ': ' + totals[w].toFixed(2) + ' ‚Ç¨<br>';
        });
        totalsContainer.innerHTML = tHtml;
      }

      if (filterWorker && filtered.length) {
        const sumSel = filtered.reduce((s,e) => s + e.amount, 0);
        selectedWorkerTotal.innerHTML =
          '<strong>Ukupno za radnika ' + filterWorker +
          (filterSite ? ' na ' + filterSite : '') +
          ' (trenutni prikaz):</strong> ' +
          sumSel.toFixed(2) + ' ‚Ç¨';
      } else {
        selectedWorkerTotal.innerHTML = '';
      }

      renderWorkersSummary();
      renderMeasuresSummary();
      renderMeasuresCurrent();
      renderPriceGlobalFields();
      renderPriceSiteFields();
    }

    workerFilter.addEventListener('change', () => {
      if (workerFilter.value) listMode = 'worker';
      renderAll();
    });
    siteFilter.addEventListener('change', renderAll);

    // -------------------------------------------------------
    // SA≈ΩETAK PO RADNIKU
    // -------------------------------------------------------
    function renderWorkersSummary() {
      if (!expenses.length) {
        workersSummary.innerHTML = '<p>Nema podataka.</p>';
        return;
      }
      const agg = {};
      expenses.forEach(e => {
        if (!agg[e.worker]) agg[e.worker] = { total: 0, count: 0 };
        agg[e.worker].total += e.amount;
        agg[e.worker].count += 1;
      });
      let html = '<table><thead><tr><th>Radnik</th><th>Broj tro≈°kova</th><th>Ukupno</th><th></th></tr></thead><tbody>';
      Object.keys(agg).forEach(w => {
        const info = agg[w];
        html += '<tr>' +
          '<td>' + w + '</td>' +
          '<td>' + info.count + '</td>' +
          '<td>' + info.total.toFixed(2) + ' ‚Ç¨</td>' +
          '<td><button data-worker="' + w + '" class="btnShowWorker">Prika≈æi</button></td>' +
          '</tr>';
      });
      html += '</tbody></table>';
      workersSummary.innerHTML = html;

      workersSummary.querySelectorAll('.btnShowWorker').forEach(btn => {
        btn.addEventListener('click', () => {
          const w = btn.getAttribute('data-worker');
          workerFilter.value = w;
          listMode = 'worker';
          btnShowWorker.classList.add('active');
          btnShowAll.classList.remove('active');
          renderAll();
          showView('costsView');
        });
      });
    }

    // -------------------------------------------------------
    // EXPORT TRO≈†KOVA CSV & PDF
    // -------------------------------------------------------
    exportCsvBtn.addEventListener('click', () => {
      if (!expenses.length) {
        alert('Nema tro≈°kova za export.');
        return;
      }
      const rows = [['datum', 'radnik', 'gradiliste', 'iznos', 'opis']];
      expenses.forEach(e => {
        rows.push([
          e.date,
          e.worker,
          e.site || '',
          e.amount.toString().replace('.', ','),
          e.desc || ''
        ]);
      });
      const csvContent = rows
        .map(row => row.map(val => '"' + String(val || '').replace(/"/g,'""') + '"').join(';'))
        .join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kob_keramika_troskovi.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    exportPdfBtn.addEventListener('click', () => {
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert('PDF modul nije uƒçitan.');
        return;
      }
      const filterWorker = workerFilter.value;
      const filterSite = siteFilter.value;
      let list = expenses.slice();
      if (filterWorker) list = list.filter(e => e.worker === filterWorker);
      if (filterSite) list = list.filter(e => e.site === filterSite);
      if (!list.length) {
        alert('Nema tro≈°kova za generiranje PDF-a.');
        return;
      }
      const doc = new jsPDF();
      doc.setFontSize(14);
      let title = 'Izvje≈°taj ‚Äì tro≈°kovi';
      if (filterWorker) title += ' za ' + filterWorker;
      if (filterSite) title += ' (' + filterSite + ')';
      doc.text(title, 10, 16);
      doc.setFontSize(10);
      let y = 24;
      list.forEach(e => {
        const d = new Date(e.date);
        const ds = d.toLocaleDateString('hr-HR');
        const line = `${ds} | ${e.worker} | ${e.site || ''} | ${e.amount.toFixed(2)} ‚Ç¨ | ${e.desc || ''}`;
        const split = doc.splitTextToSize(line, 190);
        if (y + split.length * 5 > 280) {
          doc.addPage();
          y = 20;
        }
        split.forEach(l => {
          doc.text(l, 10, y);
          y += 5;
        });
      });
      doc.save('kob_keramika_izvjestaj_troskovi.pdf');
    });

    printBtn.addEventListener('click', () => window.print());

    // -------------------------------------------------------
    // EXPORT MJERA CSV & PDF (MJERNA DOKAZNICA)
    // -------------------------------------------------------
    btnExportMeasuresCsv.addEventListener('click', () => {
      const site = measureSiteInput.value.trim();
      if (!site) {
        alert('Za CSV export mjera upi≈°i gradili≈°te.');
        return;
      }
      if (!measures[site]) {
        alert('Nema mjera za ovo gradili≈°te.');
        return;
      }

      const rows = [['gradiliste','prostorija','vrsta','sirina','visina','duzina','kolicina','jedinica','napomena','vrijeme']];
      Object.keys(measures[site]).forEach(room => {
        measures[site][room].forEach(m => {
          const meta = MEASURE_TYPES[m.type] || { label:m.type, unit:'' };
          rows.push([
            site,
            room,
            meta.label,
            m.width != null ? m.width : '',
            m.height != null ? m.height : '',
            m.length != null ? m.length : '',
            m.qty.toFixed(3),
            meta.unit,
            m.note || '',
            m.ts
          ]);
        });
      });

      const csvContent = rows
        .map(row => row.map(val => '"' + String(val || '').replace(/"/g,'""') + '"').join(';'))
        .join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kob_keramika_mjere_' + site.replace(/\s+/g,'_') + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    btnExportMeasuresPdf.addEventListener('click', () => {
      const site = measureSiteInput.value.trim();
      if (!site) {
        alert('Za PDF mjerne knjige upi≈°i gradili≈°te.');
        return;
      }
      if (!measures[site]) {
        alert('Nema mjera za ovo gradili≈°te.');
        return;
      }
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert('PDF modul nije uƒçitan.');
        return;
      }

      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text('KOB-Keramika ‚Äì Mjerna dokaznica', 10, 16);
      doc.setFontSize(11);
      doc.text('Gradili≈°te: ' + site, 10, 24);
      doc.setFontSize(10);
      let y = 32;

      const rooms = measures[site];
      Object.keys(rooms).sort().forEach(room => {
        if (y > 260) { doc.addPage(); y = 20; }
        doc.setFontSize(11);
        doc.text('Prostorija: ' + room, 10, y);
        y += 4;
        doc.setFontSize(9);

        const localByType = {};
        rooms[room].forEach(m => {
          if (!localByType[m.type]) localByType[m.type] = 0;
          localByType[m.type] += m.qty;
        });

        Object.keys(localByType).forEach(t => {
          if (y > 270) { doc.addPage(); y = 20; }
          const meta = MEASURE_TYPES[t] || {label:t, unit:''};
          doc.text('- ' + meta.label + ': ' + localByType[t].toFixed(3) + ' ' + meta.unit, 12, y);
          y += 4;
        });
        y += 2;
      });

      const pageCount = doc.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        if (logoDataUrl) doc.addImage(logoDataUrl, 'PNG', 10, 4, 20, 10);
        doc.setFontSize(8);
        doc.text('Stranica ' + i + '/' + pageCount, 105, 290, { align:'center' });
      }

      doc.save('kob_keramika_mjerne_dokaznice_' + site.replace(/\s+/g,'_') + '.pdf');
    });

    // -------------------------------------------------------
    // GRAƒêEVINSKA KNJIGA ‚Äì PDF (SAMO MJERE + CIJENE)
    // -------------------------------------------------------
    btnExportGbPdf.addEventListener('click', () => {
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert('PDF modul nije uƒçitan.');
        return;
      }
      let site = gbSiteInput.value.trim();
      if (!site) site = measureSiteInput.value.trim();
      if (!site) {
        alert('Za graƒëevinsku knjigu upi≈°i gradili≈°te (ili u mjerenjima ili ovdje).');
        return;
      }
      if (!measures[site]) {
        alert('Nema mjera za ovo gradili≈°te.');
        return;
      }

      const contractor = gbContractorInput.value.trim();
      const investor = gbInvestorInput.value.trim();
      const fromDateStr = gbFromDateInput.value;
      const toDateStr = gbToDateInput.value;

      let fromTs = null;
      let toTs = null;
      if (fromDateStr) {
        const d = new Date(fromDateStr + 'T00:00:00');
        if (!isNaN(d.getTime())) fromTs = d.getTime();
      }
      if (toDateStr) {
        const d = new Date(toDateStr + 'T23:59:59');
        if (!isNaN(d.getTime())) toTs = d.getTime();
      }

      const doc = new jsPDF();

      // Naslovna
      doc.setFontSize(16);
      doc.text('KOB-Keramika ‚Äì Graƒëevinska knjiga', 10, 20);
      doc.setFontSize(12);
      doc.text('Gradili≈°te: ' + site, 10, 30);
      let y = 38;
      if (contractor) {
        doc.text('Izvoƒëaƒç: ' + contractor, 10, y);
        y += 8;
      }
      if (investor) {
        doc.text('Investitor: ' + investor, 10, y);
        y += 8;
      }
      if (fromTs || toTs) {
        const fromText = fromTs ? new Date(fromTs).toLocaleDateString('hr-HR') : '';
        const toText = toTs ? new Date(toTs).toLocaleDateString('hr-HR') : '';
        doc.text('Period: ' + (fromText || '...') + ' - ' + (toText || '...'), 10, y);
        y += 8;
      }

      doc.setFontSize(11);
      doc.text('Dokument generiran iz interne aplikacije KOB-Keramika (mjere + obraƒçun).', 10, y);

      // Stranica 2 ‚Äì Mjerne situacije s cijenama
      doc.addPage();
      y = 20;
      doc.setFontSize(14);
      doc.text('1. Mjerne situacije (mjere i cijene)', 10, y);
      y += 8;
      doc.setFontSize(9);

      const rooms = measures[site];
      const totalByType = {};
      const totalValueByType = {};

      Object.keys(rooms).sort().forEach(room => {
        if (y > 260) { doc.addPage(); y = 20; }
        doc.setFontSize(11);
        doc.text('Prostorija: ' + room, 10, y);
        y += 5;
        doc.setFontSize(8);

        doc.text('Vrsta', 10, y);
        doc.text('Koliƒçina', 55, y);
        doc.text('Jed.', 80, y);
        doc.text('Jed. cijena', 100, y);
        doc.text('Ukupno', 140, y);
        y += 4;

        const localByType = {};
        const localValueByType = {};

        rooms[room].forEach(m => {
          if (!localByType[m.type]) localByType[m.type] = 0;
          localByType[m.type] += m.qty;

          const price = getPriceForType(site, m.type);
          const value = price != null ? price * m.qty : 0;

          if (!localValueByType[m.type]) localValueByType[m.type] = 0;
          localValueByType[m.type] += value;

          if (!totalByType[m.type]) totalByType[m.type] = 0;
          totalByType[m.type] += m.qty;
          if (!totalValueByType[m.type]) totalValueByType[m.type] = 0;
          totalValueByType[m.type] += value;
        });

        Object.keys(localByType).forEach(t => {
          if (y > 270) { doc.addPage(); y = 20; }
          const meta = MEASURE_TYPES[t] || { label: t, unit: '' };
          const qty = localByType[t];
          const price = getPriceForType(site, t);
          const val = localValueByType[t] || 0;

          doc.text(meta.label, 10, y);
          doc.text(qty.toFixed(3), 55, y);
          doc.text(meta.unit, 80, y);
          doc.text(price != null ? price.toFixed(2) + ' ‚Ç¨' : '-', 100, y);
          doc.text(val ? val.toFixed(2) + ' ‚Ç¨' : '-', 140, y);
          y += 4;
        });

        y += 3;
      });

      // Ukupno po vrsti radova
      if (Object.keys(totalByType).length) {
        if (y > 260) { doc.addPage(); y = 20; }
        doc.setFontSize(11);
        doc.text('Ukupno po vrsti radova za gradili≈°te:', 10, y);
        y += 5;
        doc.setFontSize(8);
        doc.text('Vrsta', 10, y);
        doc.text('Koliƒçina', 55, y);
        doc.text('Jed.', 80, y);
        doc.text('Jed. cijena', 100, y);
        doc.text('Ukupno', 140, y);
        y += 4;

        let grandTotal = 0;
        Object.keys(totalByType).forEach(t => {
          if (y > 270) { doc.addPage(); y = 20; }
          const meta = MEASURE_TYPES[t] || { label: t, unit: '' };
          const qty = totalByType[t];
          const price = getPriceForType(site, t);
          const val = totalValueByType[t] || 0;
          grandTotal += val;

          doc.text(meta.label, 10, y);
          doc.text(qty.toFixed(3), 55, y);
          doc.text(meta.unit, 80, y);
          doc.text(price != null ? price.toFixed(2) + ' ‚Ç¨' : '-', 100, y);
          doc.text(val ? val.toFixed(2) + ' ‚Ç¨' : '-', 140, y);
          y += 4;
        });

        if (y > 270) { doc.addPage(); y = 20; }
        doc.setFontSize(11);
        doc.text('Ukupna vrijednost radova: ' + grandTotal.toFixed(2) + ' ‚Ç¨', 10, y + 6);
      }

      // Potpisne linije
      doc.addPage();
      y = 40;
      doc.setFontSize(12);
      doc.text('2. Potpisi', 10, 20);
      doc.setFontSize(11);
      doc.text('Izvoƒëaƒç radova: _______________________________', 10, y);
      y += 20;
      doc.text('Investitor:       _______________________________', 10, y);
      y += 20;
      doc.text('Struƒçni nadzor:  _______________________________', 10, y);

      const pageCount = doc.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        if (logoDataUrl) doc.addImage(logoDataUrl, 'PNG', 10, 4, 20, 10);
        doc.setFontSize(8);
        doc.text('Stranica ' + i + '/' + pageCount, 105, 290, { align:'center' });
      }

      doc.save('kob_keramika_gradevinska_knjiga_' + site.replace(/\s+/g,'_') + '.pdf');
    });

    // -------------------------------------------------------
    // CLOUD BACKUP (FIREBASE ‚Äì OPCIJSKI)
    // -------------------------------------------------------
    const USE_FIREBASE = false; // postavi na true nakon ≈°to doda≈° svoj firebaseConfig
    let db = null;

    if (USE_FIREBASE && window.firebase) {
      const firebaseConfig = {
        // apiKey: "...",
        // authDomain: "...",
        // projectId: "...",
        // storageBucket: "...",
        // messagingSenderId: "...",
        // appId: "..."
      };
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    }

    btnUploadBackup.addEventListener('click', async () => {
      const code = syncCodeInput.value.trim();
      if (!code) {
        alert('Upi≈°i sync kod.');
        return;
      }
      if (!USE_FIREBASE || !db) {
        alert('Cloud sync nije konfiguriran. Trenutno sve radi lokalno. Kad bude≈° htio pravi cloud, javit ƒáe≈° da proƒëemo Firebase konfiguraciju.');
        return;
      }
      try {
        await db.collection('kobKeramikaBackups').doc(code).set({
          data: expenses,
          measures: measures,
          pricelist: pricelist,
          ts: Date.now()
        });
        alert('Backup spremljen u cloud.');
      } catch (e) {
        console.error(e);
        alert('Gre≈°ka pri spremanju backupa.');
      }
    });

    btnDownloadBackup.addEventListener('click', async () => {
      const code = syncCodeInput.value.trim();
      if (!code) {
        alert('Upi≈°i sync kod.');
        return;
      }
      if (!USE_FIREBASE || !db) {
        alert('Cloud sync nije konfiguriran. Trenutno sve radi lokalno. Kad bude≈° htio pravi cloud, javit ƒáe≈° da proƒëemo Firebase konfiguraciju.');
        return;
      }
      try {
        const snap = await db.collection('kobKeramikaBackups').doc(code).get();
        if (!snap.exists) {
          alert('Nije pronaƒëen backup za taj sync kod.');
          return;
        }
        const data = snap.data();
        expenses = data.data || [];
        measures = data.measures || {};
        pricelist = data.pricelist || {global:{},perSite:{}};
        saveExpenses(expenses);
        saveMeasures(measures);
        savePricelist(pricelist);
        renderAll();
        alert('Backup uƒçitan.');
      } catch (e) {
        console.error(e);
        alert('Gre≈°ka pri uƒçitavanju backupa.');
      }
    });

  if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("/kob-keramika-web./service-worker.js")
    .then(() => console.log("SW registered"))
    .catch((err) => console.warn("SW failed", err));
}  // inicijalni render
    renderAll();
  </script>
</body>
</html>

