<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>KOB-Keramika ‚Äì Pro obraƒçun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA manifest (ako ga koristi≈°) -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- jsPDF za PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <style>
    :root {
      --bg: #050505;
      --card: #121212;
      --border: #333;
      --accent: #ffffff;
      --accent-soft: #888;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI";
      background: radial-gradient(circle at top, #202020 0, #000 55%);
      color: #fff;
    }

    header {
      position: sticky;
      top: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    header .left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header img.logo {
      height: 42px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
    }

    main {
      padding: 12px;
      max-width: 1100px;
      margin: 0 auto 40px auto;
    }

    .card {
      border-radius: 16px;
      padding: 14px 12px;
      margin-bottom: 12px;
      background: radial-gradient(circle at top left, #1c1c1c, #101010);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .view { display: none; }
    .view.active { display: block; }

    h2 { margin-top: 0; }

    label {
      font-size: 13px;
      display: block;
      margin-top: 8px;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 3px;
      background: #000;
      color: #fff;
      border: 1px solid #333;
      border-radius: 8px;
      font-size: 13px;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 12px;
      background: #fff;
      color: #000;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }

    button.secondary {
      background: #222;
      color: #fff;
      border: 1px solid #444;
    }

    .btn-small {
      width: auto;
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      margin-top: 4px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 13px;
    }

    .checkbox-row input {
      width: auto;
      margin-top: 0;
    }

    .section-title {
      margin-top: 4px;
      font-size: 15px;
      font-weight: 700;
      border-bottom: 1px solid #333;
      padding-bottom: 4px;
      margin-bottom: 6px;
    }

    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .layout-split {
      display: block;
    }

    @media (min-width: 900px) {
      .layout-split {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 12px;
      }
    }

    .openings-header {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .opening-card {
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #141414;
      border: 1px solid #333;
      font-size: 12px;
    }

    .opening-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .opening-meta {
      opacity: 0.85;
    }

    .opening-actions {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #444;
      margin-right: 4px;
      margin-top: 2px;
    }

    #calcOutput {
      font-size: 13px;
      line-height: 1.35;
    }

    .dm-row {
      display: grid;
      grid-template-columns: 1.5fr 1fr 0.7fr auto;
      gap: 6px;
      margin-top: 6px;
      align-items: center;
    }

    .dm-row button {
      width: auto;
      padding: 4px 8px;
      font-size: 11px;
      margin-top: 0;
    }

    .height-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px;
      margin-top: 6px;
      align-items: center;
    }

    .height-row button {
      width: auto;
      padding: 4px 8px;
      font-size: 11px;
      margin-top: 0;
    }

    .archive-list-item {
      border-bottom: 1px solid #333;
      padding: 8px 0;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .archive-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #444;
      font-size: 11px;
      margin-right: 4px;
    }

    table.basic {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    table.basic th, table.basic td {
      border-bottom: 1px solid #333;
      padding: 4px;
      text-align: left;
    }

    table.basic th:nth-child(2),
    table.basic td:nth-child(2) {
      text-align: right;
    }

    .centered {
      max-width: 420px;
      margin: 30px auto;
    }

    .fileRow {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #333;
      font-size: 13px;
    }
/* HOME HERO */

    .home-hero {
      text-align: center;
      padding: 32px 16px 20px;
    }

    .home-hero-logo {
      width: 210px;
      max-width: 70%;
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 18px 45px rgba(0,0,0,0.8);
      margin-bottom: 18px;
    }

    .home-hero-title {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 0.06em;
    }

    .home-hero-subtitle {
      font-size: 13px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .home-menu-card {
      border-radius: 18px;
      padding: 16px 14px 18px;
      margin: 0 8px 20px;
      background: radial-gradient(circle at top left,#1a1a1a,#0b0b0b);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 12px 35px rgba(0,0,0,0.7);
    }

    .home-menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    .home-menu-buttons button {
      margin-top: 0;
    }

    .home-menu-section-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.85;
      margin: 14px 0 6px;
    }
.extra-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto auto;
      gap: 6px;
      margin-top: 6px;
      align-items: center;
      font-size: 12px;
    }
    .extra-row button {
      width: auto;
      padding: 4px 6px;
      font-size: 11px;
      margin-top: 0;
    }
  </style>
</head>
<body>

<header>
  <div class="left">
    <img src="logo.png" class="logo" alt="Logo KOB-Keramika">
    <div>
      <div style="font-weight:bold;">KOB-Keramika</div>
      <div style="font-size:12px;opacity:0.8">Pro obraƒçun keramiƒçarskih radova</div>
    </div>
  </div>
  <div style="font-size:11px;text-align:right">
    <div id="userBadge">Nije prijavljen</div>
    <button style="width:auto;padding:4px 8px;font-size:11px;margin-top:4px"
            onclick="logoutUser()">Odjava</button>
  </div>
</header>

<main>

  <!-- LOGIN VIEW -->
  <section id="loginView" class="view active">
    <div class="card centered">
      <h2>Prijava u KOB-Keramika</h2>
      <label>E-mail
        <input type="email" id="loginEmail" placeholder="you@example.com">
      </label>
      <label>Lozinka
        <input type="password" id="loginPass" placeholder="******">
      </label>
      <button onclick="loginUser()">üîê Prijava</button>
      <button onclick="registerUser()" class="secondary">‚ûï Registracija</button>
      <p style="font-size:11px;opacity:0.7;margin-top:6px;">
        Pristup je interni. Svaki korisnik ima svoj cjenik i svoje Cloud datoteke.
      </p>
    </div>
  </section>
<!-- HOME VIEW -->
  <section id="homeView" class="view">

    <div class="home-hero">
      <img src="logo.png" alt="KOB-Keramika logo" class="home-hero-logo">
      <div class="home-hero-title">KOB-KERAMIKA</div>
      <div class="home-hero-subtitle">Interni alat za obraƒçun keramiƒçarskih radova</div>
    </div>

    <div class="home-menu-card">
      <div class="home-menu-buttons">
        <!-- GRAƒêEVINSKA KNJIGA / MJERE -->
        <div class="home-menu-section">
          <div class="home-menu-section-title">Obraƒçun keramiƒçarskih radova</div>
          <button id="btnOpenAutoCalc">üìê Automatski obraƒçun prostorije</button>
          <button id="btnOpenMeasures">‚úèÔ∏è Ruƒçni unos mjera (u pripremi)</button>
          <button id="btnOpenBook">üìö Graƒëevinska knjiga (PDF)</button>
        </div>

        <!-- TRO≈†KOVI PO RADNIKU ‚Äì ODVOJENO OD KNJIGE -->
        <div class="home-menu-section">
          <div class="home-menu-section-title">Financije</div>
          <button id="btnOpenCosts">üí∞ Tro≈°kovi po radniku</button>
          <button id="btnOpenPrices">üí∂ Cjenik</button>
        </div>

        <!-- CLOUD / ARHIVA / ODJAVA -->
        <div class="home-menu-section">
          <div class="home-menu-section-title">Cloud i korisnici</div>
          <button id="btnOpenArchive">üìÇ Arhiva obraƒçuna (Cloud)</button>
          <button id="btnLogout" class="secondary">üö™ Odjava</button>
        </div>
      </div>
    </div>

  </section>

  <!-- BRZI IZRAƒåUN PO KVADRATURI -->
  <section id="quickCalcView" class="view">
    <div class="card">
      <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
      <h2>üìè Brzi izraƒçun po kvadraturi</h2>
      <p style="font-size:13px;opacity:0.8;">
        Jednostavan izraƒçun iznosa na temelju kvadrature ili du≈ænih metara, nevezano za graƒëevinsku knjigu.
      </p>
      <label>Opis radova
        <input id="qcOpis" placeholder="npr. 60x120 zid ‚Äì kupaonica 1">
      </label>
      <div class="two-col">
        <label>Koliƒçina
          <input id="qcKolicina" placeholder="npr. 12,50">
        </label>
        <label>Jedinica (m2, m, kom)
          <input id="qcJedinica" placeholder="m2">
        </label>
      </div>
      <label>Jediniƒçna cijena (‚Ç¨)
        <input id="qcCijena" placeholder="npr. 18,50">
      </label>
      <button onclick="runQuickCalc()">Izraƒçunaj</button>
      <div id="qcRezultat" style="margin-top:10px;font-size:13px;"></div>
    </div>
  </section>

  <!-- AUTOMATSKI OBRAƒåUN PROSTORIJE -->
  <section id="autoCalcView" class="view">

    <div class="card">
      <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
      <h2>üìê Automatski obraƒçun prostorije</h2>
      <p style="font-size:13px;opacity:0.8;">
        Dimenzije prostorije + otvori ‚Üí automatski obraƒçun poda, zidova, hidroizolacije, traka, silikona, sokla,
        stepenica, lajsni, gerunga i dodatnih mjera. Na kraju se generira profesionalna graƒëevinska knjiga (PDF),
        CSV za Excel i sve se mo≈æe spremiti u Cloud.
      </p>
    </div>

    <!-- PODACI O GRADILI≈†TU -->
    <div class="card">
      <div class="section-title">üèó Podaci o gradili≈°tu</div>
      <label>Gradili≈°te
        <input type="text" id="siteName" placeholder="npr. Stan Novak ‚Äì Maksimir">
      </label>
      <label>Prostorija
        <input type="text" id="roomName" placeholder="npr. Kupaonica 1">
      </label>
      <div class="two-col">
        <label>Situcija / redni broj
          <input type="text" id="situationNo" placeholder="npr. Situacija 1">
        </label>
        <label>Investitor
          <input type="text" id="investorName" placeholder="npr. Novak Ivan">
        </label>
      </div>
      <label>Napomena (opcionalno)
        <textarea id="gkNapomena" placeholder="npr. Lijepljenje na ravnu podlogu, fuga 2mm, bijeli silikon..."></textarea>
      </label>
    </div>

    <!-- FORMAT PLOƒåICE -->
    <div class="card">
      <div class="section-title">üß± Format ploƒçice (obavezno)</div>
      <label>Odaberi format
        <select id="tileFormatSelect">
          <option value="">-- Odaberi format --</option>
          <!-- mali -->
          <option value="10x10">10 √ó 10 cm</option>
          <option value="15x15">15 √ó 15 cm</option>
          <option value="20x20">20 √ó 20 cm</option>
          <option value="20x25">20 √ó 25 cm</option>
          <option value="20x30">20 √ó 30 cm</option>
          <option value="25x33">25 √ó 33 cm</option>
          <option value="25x40">25 √ó 40 cm</option>
          <option value="25x50">25 √ó 50 cm</option>
          <!-- srednji -->
          <option value="30x30">30 √ó 30 cm</option>
          <option value="30x45">30 √ó 45 cm</option>
          <option value="30x60">30 √ó 60 cm</option>
          <option value="40x40">40 √ó 40 cm</option>
          <option value="45x45">45 √ó 45 cm</option>
          <option value="50x50">50 √ó 50 cm</option>
          <option value="50x100">50 √ó 100 cm</option>
          <!-- veliki -->
          <option value="60x60">60 √ó 60 cm</option>
          <option value="60x120">60 √ó 120 cm</option>
          <option value="75x75">75 √ó 75 cm</option>
          <option value="80x80">80 √ó 80 cm</option>
          <option value="90x90">90 √ó 90 cm</option>
          <option value="100x100">100 √ó 100 cm</option>
          <!-- XXL -->
          <option value="100x300">100 √ó 300 cm</option>
          <option value="120x240">120 √ó 240 cm</option>
          <option value="120x260">120 √ó 260 cm</option>
          <option value="120x270">120 √ó 270 cm</option>
          <option value="120x280">120 √ó 280 cm</option>
          <option value="120x300">120 √ó 300 cm</option>
          <option value="160x320">160 √ó 320 cm</option>
          <option value="162x324">162 √ó 324 cm</option>
          <!-- ruƒçni -->
          <option value="custom">Ruƒçni unos</option>
        </select>
      </label>
      <div id="tileCustomFields" style="display:none;">
        <div class="two-col">
          <label>≈†irina ploƒçice (cm)
            <input type="text" id="tileW" placeholder="npr. 60">
          </label>
          <label>Duljina ploƒçice (cm)
            <input type="text" id="tileH" placeholder="npr. 120">
          </label>
        </div>
      </div>
      <p style="font-size:11px;opacity:0.7;margin-top:4px;">
        Bez odabranog formata ploƒçice obraƒçun se neƒáe pokrenuti.
      </p>
    </div>

    <div class="layout-split">

      <!-- LIJEVA STRANA ‚Äì UNOS -->
      <div>

        <div class="card">
          <div class="section-title">üìè Osnovne dimenzije prostorije</div>

          <label>Duljina D (m)
            <input type="text" id="dimD" placeholder="npr. 4,20">
          </label>

          <label>≈†irina ≈† (m)
            <input type="text" id="dimS" placeholder="npr. 3,10">
          </label>

          <label>Visina V (m)
            <input type="text" id="dimV" placeholder="npr. 2,65">
          </label>
        </div>
<div class="card">
  <div class="section-title">‚ûï Dodatne dimenzije prostorije</div>
  <p style="font-size:12px;opacity:0.8;">
    Ovdje upisuje≈° dodatne dijelove prostorije (npr. uvuƒçeni dio, pro≈°irenje, ni≈°a u podu‚Ä¶).
    Svaki red ima dodatnu du≈æinu (d), ≈°irinu (≈°) i visinu (v).
    Primjenjuje se prema pravilima:
    <br>‚Ä¢ Pod: ¬± (≈° + d)
    <br>‚Ä¢ Zidovi: + (2√ód + ≈°) √ó v
    <br>‚Ä¢ Hidro pod: isto kao pod
    <br>‚Ä¢ Hidro traka: + (2√ód + ≈°)
    <br>‚Ä¢ Silikon: + (2√ód + ≈°) + 2√óv
  </p>

  <div id="extraDimsContainer"></div>

  <button type="button" class="btn-small secondary" id="btnAddExtraDim">
    ‚ûï Dodaj dodatne dimenzije
  </button>
</div>
        <div class="card">
          <div class="section-title">‚òë ≈†to se raƒçuna?</div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkPod">
            <label for="chkPod">Pod (m¬≤)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkZidovi">
            <label for="chkZidovi">Zidovi (bruto ‚Äì vrata se odbijaju)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkHidroPod">
            <label for="chkHidroPod">Hidroizolacija ‚Äì pod</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkHidroTus">
            <label for="chkHidroTus">Hidroizolacija ‚Äì tu≈° zona</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkHidroTraka">
            <label for="chkHidroTraka">Hidro traka (pod + prozor + ni≈°a)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkSilikon">
            <label for="chkSilikon">Silikon (bez vrata)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkSokl">
            <label for="chkSokl">Sokl</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkStepenice">
            <label for="chkStepenice">Stepenice</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkLajsne">
            <label for="chkLajsne">Lajsne</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkGerung">
            <label for="chkGerung">Gerung</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkDodatne">
            <label for="chkDodatne">Dodatne mjere (+/‚àí)</label>
          </div>
        </div>

        <!-- Tu≈° zona -->
        <div class="card" id="cardTus" style="display:none;">
          <div class="section-title">üöø Tu≈° zona</div>
          <div class="two-col">
            <label>Duljina tu≈°a d (m)
              <input type="text" id="tusD" placeholder="npr. 0,90">
            </label>
            <label>≈†irina tu≈°a ≈° (m)
              <input type="text" id="tusS" placeholder="npr. 1,45">
            </label>
          </div>
          <label>Visina tu≈°a v (m) ‚Äì po defaultu glavna visina
            <input type="text" id="tusV" placeholder="prazno = visina prostorije">
          </label>
          <p style="font-size:11px;opacity:0.7;margin-top:4px;">
            Hidro tu≈° = (2√ód + ≈°) √ó v
          </p>
        </div>

        <!-- Silikon ‚Äì vi≈°estruke visine -->
        <div class="card" id="cardSilikon" style="display:none;">
          <div class="section-title">üßº Silikon</div>
          <p style="font-size:12px;opacity:0.8;">
            Formula: (2√óD + 2√ó≈† + 4√óV) + ‚àë(dodatne visine) + rubovi svih otvora osim vrata.
          </p>
          <div id="silHeightsContainer"></div>
          <button type="button" class="btn-small secondary" id="btnAddHeight">‚ûï Dodaj visinu</button>
        </div>

        <!-- Sokl -->
        <div class="card" id="cardSokl" style="display:none;">
          <div class="section-title">üìè Sokl ‚Äì korekcije</div>
          <label>Odbijanje sokla (m)
            <input type="text" id="soklMinus" placeholder="0">
          </label>
          <label>Dodatno sokla (m)
            <input type="text" id="soklPlus" placeholder="0">
          </label>
          <p style="font-size:11px;opacity:0.7;margin-top:4px;">
            Sokl = 2√ó(D+≈†) ‚àí odbijanje + dodatno
          </p>
        </div>

        <!-- Stepenice -->
        <div class="card" id="cardStepenice" style="display:none;">
          <div class="section-title">ü™ú Stepenice</div>
          <label>≈†irina stepenice (m)
            <input type="text" id="stepWidth" placeholder="npr. 1,00">
          </label>
          <label>Broj stepenica (kom)
            <input type="text" id="stepCount" placeholder="npr. 5">
          </label>
          <label>Vrsta obraƒçuna
            <select id="stepMode">
              <option value="duzni">Du≈æni metri (≈† √ó kom)</option>
              <option value="komada">Broj komada</option>
            </select>
          </label>
        </div>

        <!-- Lajsne -->
        <div class="card" id="cardLajsne" style="display:none;">
          <div class="section-title">üîπ Lajsne</div>
          <p style="font-size:12px;opacity:0.8;">
            Ukupno lajsni = ruƒçni metri + rubovi oznaƒçenih elemenata.
          </p>
          <label>Lajsna 1 (m)
            <input type="text" id="l1" placeholder="0">
          </label>
          <label>Lajsna 2 (m)
            <input type="text" id="l2" placeholder="0">
          </label>
          <label>Lajsna 3 (m)
            <input type="text" id="l3" placeholder="0">
          </label>
          <div class="section-title">Lajsne na elementima</div>
          <div class="checkbox-row"><input type="checkbox" id="lProzor"><label for="lProzor">Prozori</label></div>
          <div class="checkbox-row"><input type="checkbox" id="lNisa"><label for="lNisa">Ni≈°e</label></div>
          <div class="checkbox-row"><input type="checkbox" id="lGeberit"><label for="lGeberit">Geberit</label></div>
          <div class="checkbox-row"><input type="checkbox" id="lVert"><label for="lVert">Vertikale</label></div>
        </div>

        <!-- Gerung -->
        <div class="card" id="cardGerung" style="display:none;">
          <div class="section-title">üî™ Gerung</div>
          <p style="font-size:12px;opacity:0.8;">
            Ukupno gerunga = ruƒçni metri + rubovi oznaƒçenih elemenata.
          </p>
          <label>Gerung 1 (m)
            <input type="text" id="g1" placeholder="0">
          </label>
          <label>Gerung 2 (m)
            <input type="text" id="g2" placeholder="0">
          </label>
          <label>Gerung 3 (m)
            <input type="text" id="g3" placeholder="0">
          </label>
          <div class="section-title">Gerung na elementima</div>
          <div class="checkbox-row"><input type="checkbox" id="gProzor"><label for="gProzor">Prozori</label></div>
          <div class="checkbox-row"><input type="checkbox" id="gNisa"><label for="gNisa">Ni≈°e</label></div>
          <div class="checkbox-row"><input type="checkbox" id="gGeberit"><label for="gGeberit">Geberit</label></div>
          <div class="checkbox-row"><input type="checkbox" id="gVert"><label for="gVert">Vertikale</label></div>
        </div>

        <!-- Dodatne mjere -->
        <div class="card" id="cardDodatne" style="display:none;">
          <div class="section-title">‚ûï‚ûñ Dodatne mjere</div>
          <p style="font-size:12px;opacity:0.8;">
            Mo≈æe≈° dodati do 10 polja kao + ili ‚àí mjera. Ukupno se zatim dodaje/oduzima od oznaƒçenih kategorija.
          </p>
          <div id="dmContainer"></div>
          <button type="button" class="btn-small secondary" id="btnAddDmRow">‚ûï Dodaj mjeru</button>

          <div class="section-title">Gdje se primjenjuje?</div>
          <div class="checkbox-row"><input type="checkbox" id="dmPod"><label for="dmPod">Pod</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmZidovi"><label for="dmZidovi">Zidovi</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmHidro"><label for="dmHidro">Hidro pod</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmSil"><label for="dmSil">Silikon</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmTraka"><label for="dmTraka">Hidro traka</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmSokl"><label for="dmSokl">Sokl</label></div>
        </div>
// =========================
//  DODATNE DIMENZIJE PROSTORIJE
// =========================

const extraDimsContainer = document.getElementById("extraDimsContainer");
const btnAddExtraDim = document.getElementById("btnAddExtraDim");

function addExtraDimRow(dVal = "", sVal = "", vVal = "", signVal = "+") {
  const row = document.createElement("div");
  row.className = "extra-row";
  row.innerHTML = `
    <input type="text" class="exD" placeholder="d (m)" value="${dVal}">
    <input type="text" class="exS" placeholder="≈° (m)" value="${sVal}">
    <input type="text" class="exV" placeholder="v (m)" value="${vVal}">
    <select class="exSign">
      <option value="+" ${signVal==="+"?"selected":""}>+</option>
      <option value="-" ${signVal==="-"?"selected":""}>‚àí</option>
    </select>
    <button type="button" class="secondary">‚úï</button>
  `;
  const btn = row.querySelector("button");
  btn.onclick = () => row.remove();
  extraDimsContainer.appendChild(row);
}

if (btnAddExtraDim) {
  btnAddExtraDim.addEventListener("click", () => {
    addExtraDimRow();
  });
}
        <!-- Gumbi za izraƒçun -->
        <div class="card">
          <button id="btnCalcNow">üîç Izraƒçunaj sve</button>
          <button id="btnExportPdfAuto" class="secondary">üìÑ PDF ‚Äì graƒëevinska knjiga</button>
          <button id="btnExportCsvAuto" class="secondary">üìë CSV ‚Äì Excel export</button>
          <button id="btnSaveCloud" class="secondary">‚òÅÔ∏è Spremi obraƒçun + PDF u Cloud</button>
        </div>

      </div>

      <!-- DESNA STRANA ‚Äì OTVORI + REZULTATI -->
      <div>

        <!-- Otvori kao kartice -->
        <div class="card">
          <div class="section-title">üß± Otvori (vrata, prozori, ni≈°e, geberit, vertikale)</div>
          <p style="font-size:12px;opacity:0.8;">
            Vrata se odbijaju od zidova ali ne ulaze u silikon. Prozori i ni≈°e ulaze u hidro traku i silikon.
            Geberit i vertikale slu≈æe za lajsne i gerung.
          </p>
          <div class="openings-header">
            <button id="btnAddDoor"     class="btn-small">‚ûï Vrata</button>
            <button id="btnAddWindow"   class="btn-small">‚ûï Prozor</button>
            <button id="btnAddNiche"    class="btn-small">‚ûï Ni≈°a</button>
            <button id="btnAddGeberit"  class="btn-small">‚ûï Geberit</button>
            <button id="btnAddVert"     class="btn-small">‚ûï Vertikala</button>
            <button id="btnAddCustom"   class="btn-small">‚ûï Custom otvor</button>
          </div>
          <div id="openingsList"></div>
        </div>

        <!-- Rezultati -->
        <div class="card" id="calcResult" style="display:none;">
          <h3>üìä Rezultati obraƒçuna</h3>
          <div id="calcOutput"></div>
        </div>

      </div>

    </div>
  </section>

  <!-- CJENIK -->
  <section id="pricesView" class="view">
    <div class="card">
      <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
      <h2>üí∂ Cjenik keramiƒçarskih radova</h2>
      <p style="font-size:13px;opacity:0.8;">
        Ovdje unosi≈° cijene po stavkama. Preporuƒçeni nazivi (ako ≈æeli≈° da se automatski povuku u graƒëevinsku knjigu):
        <br>Pod, Zidovi, Hidro pod, Hidro tu≈°, Hidro traka, Silikon, Sokl, Stepenice m, Stepenice kom, Lajsne, Gerung.
      </p>
    </div>

    <div class="card">
      <label>Naziv stavke
        <input id="cjenikNaziv" placeholder="npr. Pod, Zidovi, Hidro pod...">
      </label>
      <label>Cijena (‚Ç¨ po jedinici)
        <input id="cjenikCijena" placeholder="npr. 18,50">
      </label>
      <button onclick="addPriceItem()">‚ûï Dodaj u cjenik</button>
      <button onclick="savePricelistToCloud()" class="secondary">‚òÅ Spremi cjenik u Cloud</button>
    </div>

    <div class="card">
      <h3>Pregled cjenika</h3>
      <table class="basic">
        <thead>
          <tr>
            <th>Naziv stavke</th>
            <th>Cijena (‚Ç¨)</th>
          </tr>
        </thead>
        <tbody id="cjenikBody">
        </tbody>
      </table>
    </div>
  </section>

  <!-- ARHIVA OBRAƒåUNA (FIRESTORE + PDF URL) -->
  <section id="archiveView" class="view">
    <div class="card">
      <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
      <h2>üìÇ Arhiva obraƒçuna (Cloud)</h2>
      <p style="font-size:12px;opacity:0.8;">
        Popis svih spremljenih obraƒçuna. Svi prijavljeni korisnici vide sve zapise.
      </p>
    </div>
    <div class="card">
      <div id="archiveList"></div>
    </div>
  </section>

  <!-- CLOUD DATOTEKE (STORAGE LIST) -->
  <section id="cloudView" class="view">
    <div class="card">
      <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
      <h2>‚òÅ Cloud datoteke</h2>
      <p style="font-size:12px;opacity:0.8;">
        Datoteke (PDF/CSV) spremljene u Storage za trenutnog korisnika.
      </p>
      <button onclick="renderCloudFiles()" class="secondary" style="width:auto;">üîÑ Osvje≈æi</button>
    </div>
    <div class="card" id="cloudFileList">
      Uƒçitavanje...
    </div>
  </section>

</main>

<script>
// =========================
//  FIREBASE INIT
// =========================
const firebaseConfig = {
  apiKey: "AIzaSyDIuDJqFE3G2yk98WPwGHkc6xomWXUdu3o",
  authDomain: "kob-keramika.firebaseapp.com",
  projectId: "kob-keramika",
  storageBucket: "kob-keramika.appspot.com",
  messagingSenderId: "604488601212",
  appId: "1:604488601212:web:70552af260d9e5a283c3f9",
  measurementId: "G-KDTBSP3H39"
};

firebase.initializeApp(firebaseConfig);

const auth    = firebase.auth();
const db      = firebase.firestore();
const storage = firebase.storage();

let CURRENT_USER = null;
let state = {
  pricelist: {},
  lastCalc: null
};

auth.onAuthStateChanged(user => {
  CURRENT_USER = user;
  renderUserBadge();
  if (user) {
    showView('homeView');
    loadPricelist().then(p => { state.pricelist = p || {}; renderPricelistUI(); });
    loadArchive();
    renderCloudFiles();
  } else {
    showView('loginView');
  }
});

function renderUserBadge() {
  const badge = document.getElementById('userBadge');
  if (!badge) return;
  if (!CURRENT_USER) badge.textContent = "Nije prijavljen";
  else badge.textContent = CURRENT_USER.email;
}

// =========================
//  POMOƒÜNE FUNKCIJE
// =========================
function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}

function parseNum(val) {
  if (val === undefined || val === null) return 0;
  let s = String(val).trim().replace(',', '.');
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

function parseIntSafe(val) {
  if (val === undefined || val === null) return 0;
  let s = String(val).trim().replace(',', '.');
  const n = parseInt(s, 10);
  return isNaN(n) ? 0 : n;
}

function formatHr(n, dec = 3) {
  if (typeof n !== "number" || isNaN(n)) n = 0;
  return n.toFixed(dec).replace('.', ',');
}

// =========================
//  AUTH ‚Äì LOGIN / REGISTER / LOGOUT
// =========================
async function loginUser() {
  const email = document.getElementById("loginEmail").value.trim();
  const pass  = document.getElementById("loginPass").value;
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    alert("Prijava uspje≈°na.");
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri prijavi: " + e.message);
  }
}

async function registerUser() {
  const email = document.getElementById("loginEmail").value.trim();
  const pass  = document.getElementById("loginPass").value;
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    const uid  = cred.user.uid;

    await db.collection("users").doc(uid).set({
      email: email,
      createdAt: Date.now(),
      cjenik: {}
    }, { merge: true });

    alert("Registracija uspje≈°na.");
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri registraciji: " + e.message);
  }
}

function logoutUser() {
  auth.signOut().catch(e => console.error(e));
}

function requireAuth() {
  if (!CURRENT_USER) {
    alert("Prijavite se za kori≈°tenje aplikacije.");
    showView('loginView');
    return false;
  }
  return true;
}

// =========================
//  VEZANJE CHECKBOXA NA KARTICE
// =========================
function bindToggle(chkId, cardId) {
  const chk = document.getElementById(chkId);
  const card = document.getElementById(cardId);
  if (!chk || !card) return;
  chk.addEventListener('change', () => {
    card.style.display = chk.checked ? 'block' : 'none';
  });
}
bindToggle('chkHidroTus', 'cardTus');
bindToggle('chkSilikon', 'cardSilikon');
bindToggle('chkSokl', 'cardSokl');
bindToggle('chkStepenice', 'cardStepenice');
bindToggle('chkLajsne', 'cardLajsne');
bindToggle('chkGerung', 'cardGerung');
bindToggle('chkDodatne', 'cardDodatne');

// FORMAT PLOƒåICA ruƒçni
const tileSelect = document.getElementById('tileFormatSelect');
const tileCustomFields = document.getElementById('tileCustomFields');
tileSelect.addEventListener('change', () => {
  tileCustomFields.style.display = (tileSelect.value === 'custom') ? 'block' : 'none';
});

// DINAMIƒåNE VISINE ZA SILIKON
const silContainer = document.getElementById('silHeightsContainer');
const btnAddHeight = document.getElementById('btnAddHeight');

function addHeightRow(initialValue = "") {
  const row = document.createElement('div');
  row.className = 'height-row';
  row.innerHTML = `
    <input type="text" class="silHeightVal" placeholder="npr. 2,10" value="${initialValue}">
    <button type="button" class="secondary">‚úï</button>
  `;
  const btn = row.querySelector('button');
  btn.onclick = () => row.remove();
  silContainer.appendChild(row);
}
btnAddHeight.addEventListener('click', () => {
  if (silContainer.querySelectorAll('.height-row').length >= 10) {
    alert("Maksimalno 10 visina.");
    return;
  }
  addHeightRow();
});

// DINAMIƒåNE DODATNE MJERE
const dmContainer = document.getElementById('dmContainer');
const btnAddDmRow = document.getElementById('btnAddDmRow');

function addDmRow() {
  if (dmContainer.querySelectorAll('.dm-row').length >= 10) {
    alert("Maksimalno 10 dodatnih mjera.");
    return;
  }
  const row = document.createElement('div');
  row.className = 'dm-row';
  row.innerHTML = `
    <input type="text" class="dmName" placeholder="Naziv (npr. dodatni zid)">
    <input type="text" class="dmVal" placeholder="vrijednost">
    <select class="dmSign">
      <option value="+">+</option>
      <option value="-">‚àí</option>
    </select>
    <button type="button" class="secondary">‚úï</button>
  `;
  row.querySelector('button').onclick = () => row.remove();
  dmContainer.appendChild(row);
}
btnAddDmRow.addEventListener('click', addDmRow);

// OTVORI
let openings = [];

function newId() {
  return 'o_' + Math.random().toString(36).substr(2, 9);
}

function openingArea(o) {
  // Povr≈°ina se koristi uglavnom za zidove (odbitak vrata).
  // Za geberit i vertikal je manje bitna, ali ostavljamo w√óh.
  return (o.w || 0) * (o.h || 0) * (o.count || 1);
}

function openingPerim(o) {
  const count = o.count || 1;
  if (o.type === "geberit") {
    // Geberit: 2√óvisina + ≈°irina
    return ((2 * (o.h || 0)) + (o.w || 0)) * count;
  }
  if (o.type === "vert") {
    // Vertikala: samo visina
    return (o.h || 0) * count;
  }
  // Vrata, prozor, ni≈°a i ostalo: klasiƒçni obod
  return 2 * ((o.w || 0) + (o.h || 0)) * count;
}

function addOpening(type) {
  let label;
  if (type === 'vrata') label = 'Vrata';
  else if (type === 'prozor') label = 'Prozor';
  else if (type === 'geberit') label = 'Geberit';
  else if (type === 'nisa') label = 'Ni≈°a';
  else if (type === 'vert') label = 'Vertikala';
  else label = prompt("Naziv otvora:", "Custom otvor") || "Custom otvor";

  const w = parseNum(prompt(label + " - ≈°irina (m):", "0,9"));
  const h = parseNum(prompt(label + " - visina (m):", "2,0"));
  const c = parseIntSafe(prompt(label + " - komada:", "1"));

  if (!w || !h || !c) {
    alert("Nije unesena puna dimenzija ‚Äì otvor je preskoƒçen.");
    return;
  }

  const subtract = (type === 'vrata'); // samo vrata odbijaju zidove

  openings.push({ id: newId(), type, label, w, h, count: c, subtract });
  renderOpenings();
}

function deleteOpening(id) {
  openings = openings.filter(o => o.id !== id);
  renderOpenings();
}

function renderOpenings() {
  const list = document.getElementById('openingsList');
  if (!list) return;
  if (!openings.length) {
    list.innerHTML = '<p style="font-size:12px;opacity:0.7;">Nema unesenih otvora.</p>';
    return;
  }
  let html = '';
  openings.forEach(o => {
    const perim = openingPerim(o);
    const area = openingArea(o);
    html += `
      <div class="opening-card">
        <div class="opening-title">${o.label}</div>
        <div class="opening-meta">
          Tip: ${o.type}<br>
          ≈†=${formatHr(o.w)} m, V=${formatHr(o.h)} m, kom=${o.count}<br>
          Povr≈°ina: ${formatHr(area)} m¬≤<br>
          Obod (rubovi): ${formatHr(perim)} m
        </div>
        <div style="margin-top:4px;">
          <span class="tag">${o.subtract ? "Odbija zidove: DA" : "Odbija zidove: NE"}</span>
          <span class="tag">Za silikon: ${o.type === 'vrata' ? 'NE' : 'DA'}</span>
          <span class="tag">Za hidro traku: ${(o.type === 'prozor' || o.type === 'nisa') ? 'DA' : 'NE'}</span>
        </div>
        <div class="opening-actions">
          <button class="btn-small secondary" onclick="deleteOpening('${o.id}')">üóë Obri≈°i</button>
        </div>
      </div>
    `;
  });
  list.innerHTML = html;
}

document.getElementById('btnAddDoor').onclick    = () => addOpening('vrata');
document.getElementById('btnAddWindow').onclick  = () => addOpening('prozor');
document.getElementById('btnAddGeberit').onclick = () => addOpening('geberit');
document.getElementById('btnAddNiche').onclick   = () => addOpening('nisa');
document.getElementById('btnAddVert').onclick    = () => addOpening('vert');
document.getElementById('btnAddCustom').onclick  = () => addOpening('custom');

// QUICK CALC
function runQuickCalc() {
  const opis = document.getElementById('qcOpis').value.trim() || "Radovi";
  const kol  = parseNum(document.getElementById('qcKolicina').value);
  const jm   = document.getElementById('qcJedinica').value.trim() || "m2";
  const cij  = parseNum(document.getElementById('qcCijena').value);
  const out  = document.getElementById('qcRezultat');

  if (!kol || !cij) {
    out.innerHTML = "<span style='color:#f66'>Unesi koliƒçinu i cijenu.</span>";
    return;
  }
  const iznos = kol * cij;
  out.innerHTML = `
    <b>${opis}</b><br>
    Koliƒçina: ${formatHr(kol, 3)} ${jm}<br>
    Jediniƒçna cijena: ${formatHr(cij, 2)} ‚Ç¨<br>
    <b>Ukupno: ${formatHr(iznos, 2)} ‚Ç¨</b>
  `;
}

// CJENIK
async function loadPricelist() {
  if (!CURRENT_USER) return {};
  const snap = await db.collection("users").doc(CURRENT_USER.uid).get();
  if (!snap.exists) return {};
  return snap.data().cjenik || {};
}

async function savePricelistToCloud() {
  if (!CURRENT_USER) {
    alert("Prijavite se da bi se cjenik spremio.");
    return;
  }
  try {
    await db.collection("users").doc(CURRENT_USER.uid).set({
      cjenik: state.pricelist,
      email: CURRENT_USER.email,
      updatedAt: Date.now()
    }, { merge: true });
    alert("Cjenik spremljen u Cloud.");
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri spremanju cjenika: " + e.message);
  }
}

function renderPricelistUI() {
  const tbody = document.getElementById("cjenikBody");
  if (!tbody) return;
  tbody.innerHTML = "";

  const entries = Object.entries(state.pricelist || {});
  if (!entries.length) {
    tbody.innerHTML = "<tr><td colspan='2'>Nema stavki u cjeniku.</td></tr>";
    return;
  }

  entries.forEach(([naziv, cijena]) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${naziv}</td>
      <td style="text-align:right;">${Number(cijena).toFixed(2)} ‚Ç¨</td>
    `;
    tbody.appendChild(tr);
  });
}

function addPriceItem() {
  const nameEl  = document.getElementById("cjenikNaziv");
  const priceEl = document.getElementById("cjenikCijena");
  const naziv   = nameEl.value.trim();
  let cijena    = priceEl.value.trim().replace(",", ".");

  if (!naziv || !cijena) {
    alert("Unesi naziv i cijenu.");
    return;
  }
  cijena = parseFloat(cijena);
  if (isNaN(cijena)) {
    alert("Cijena nije ispravna.");
    return;
  }
  if (!state.pricelist) state.pricelist = {};
  state.pricelist[naziv] = cijena;
  nameEl.value = "";
  priceEl.value = "";
  renderPricelistUI();
}

function getPrice(key) {
  if (!state.pricelist) return 0;
  return Number(state.pricelist[key] || 0);
}

// GLAVNI IZRAƒåUN
document.getElementById('btnCalcNow').addEventListener('click', () => {
  runAutoCalc(true);
});

function runAutoCalc(showHtml = true) {
  const D = parseNum(document.getElementById('dimD').value);
  const S = parseNum(document.getElementById('dimS').value);
  const V = parseNum(document.getElementById('dimV').value);

  // =========================
  //  DODATNE DIMENZIJE ‚Äì PRIPREMA
  // =========================
  const extraRows = extraDimsContainer
    ? extraDimsContainer.querySelectorAll(".extra-row")
    : [];
  const extraDimDetails = []; // za prikaz u PDF-u kasnije

  let extraPod = 0;      // ¬± (≈° + d)
  let extraHidroPod = 0; // isto kao pod
  let extraZid = 0;      // + (2√ód + ≈°) √ó v
  let extraTraka = 0;    // + (2√ód + ≈°)
  let extraSilikon = 0;  // + (2√ód + ≈°) + 2√óv

  extraRows.forEach((row, idx) => {
    const dE = parseNum(row.querySelector(".exD")?.value);
    const sE = parseNum(row.querySelector(".exS")?.value);
    const vE = parseNum(row.querySelector(".exV")?.value);
    const sign = (row.querySelector(".exSign")?.value === "-") ? -1 : 1;

    // Pod i hidro pod: ¬± (≈° + d)
    const deltaPod = sign * (sE + dE);

    // Zid: + (2√ód + ≈°) √ó v
    const deltaZid = (2 * dE + sE) * vE * sign;

    // Traka: + (2√ód + ≈°)
    const deltaTraka = (2 * dE + sE) * sign;

    // Silikon: + (2√ód + ≈°) + 2√óv
    const deltaSilikon = ((2 * dE + sE) + 2 * vE) * sign;

    extraPod      += deltaPod;
    extraHidroPod += deltaPod;
    extraZid      += deltaZid;
    extraTraka    += deltaTraka;
    extraSilikon  += deltaSilikon;

    extraDimDetails.push({
      index: idx + 1,
      d: dE,
      s: sE,
      v: vE,
      sign,
      deltaPod,
      deltaZid,
      deltaTraka,
      deltaSilikon
    });
  });
  const tf = document.getElementById('tileFormatSelect').value;
  if (!tf) {
    alert("Molimo odaberi format ploƒçice.");
    return null;
  }
  let tileFormat = { label: "", wcm: 0, hcm: 0 };
  if (tf === 'custom') {
    const tw = parseNum(document.getElementById('tileW').value);
    const th = parseNum(document.getElementById('tileH').value);
    if (!tw || !th) {
      alert("Kod ruƒçnog formata upi≈°i ≈°irinu i duljinu ploƒçice.");
      return null;
    }
    tileFormat.wcm = tw;
    tileFormat.hcm = th;
    tileFormat.label = `${tw} √ó ${th} cm`;
  } else {
    const parts = tf.split('x');
    const tw = parseNum(parts[0]);
    const th = parseNum(parts[1]);
    tileFormat.wcm = tw;
    tileFormat.hcm = th;
    tileFormat.label = `${tw} √ó ${th} cm`;
  }

  const meta = {
    siteName: document.getElementById('siteName').value || "",
    roomName: document.getElementById('roomName').value || "",
    situationNo: document.getElementById('situationNo').value || "",
    investorName: document.getElementById('investorName').value || "",
    note: document.getElementById('gkNapomena').value || "",
    tileFormat
  };

  const chkPod        = document.getElementById('chkPod').checked;
  const chkZidovi     = document.getElementById('chkZidovi').checked;
  const chkHidroPod   = document.getElementById('chkHidroPod').checked;
  const chkHidroTus   = document.getElementById('chkHidroTus').checked;
  const chkHidroTraka = document.getElementById('chkHidroTraka').checked;
  const chkSilikon    = document.getElementById('chkSilikon').checked;
  const chkSokl       = document.getElementById('chkSokl').checked;
  const chkStepenice  = document.getElementById('chkStepenice').checked;
  const chkLajsne     = document.getElementById('chkLajsne').checked;
  const chkGerung     = document.getElementById('chkGerung').checked;
  const chkDodatne    = document.getElementById('chkDodatne').checked;

  let html = `<h4>Dimenzije prostorije:</h4>
    D = ${formatHr(D)} m<br>
    ≈† = ${formatHr(S)} m<br>
    V = ${formatHr(V)} m<br>
    Format ploƒçice: <b>${meta.tileFormat.label}</b><br><br>`;

  const results = {};
  const prices  = {};

  // POD
  if (chkPod) {
    const podOsnovno = D * S;
    const pod = podOsnovno + extraPod;
    results.pod = pod;
    results.podData = { osnovno: podOsnovno, extra: extraPod };

    html += `<b>Pod:</b><br>`;
    html += `Osnovno: D √ó ≈† = ${formatHr(D)} √ó ${formatHr(S)} = ${formatHr(podOsnovno)} m¬≤<br>`;
    if (extraPod !== 0) {
      html += `Dodatne dimenzije: ${extraPod > 0 ? "+" : ""}${formatHr(extraPod)} m¬≤<br>`;
    }
    html += `Ukupno pod = <b>${formatHr(pod)} m¬≤</b><br><br>`;

    prices.pod = { qty: pod, unit: "m2" };
  }

  // ZIDOVI
  if (chkZidovi) {
    const zidoviBruto = 2 * (D * V) + 2 * (S * V);

    let areaVrata = 0;
    openings.forEach(o => {
      if (o.type === "vrata" && o.subtract) {
        areaVrata += openingArea(o);
      }
    });

    const zidoviNakonVrata = zidoviBruto - areaVrata;
    const zidoviNeto = zidoviNakonVrata + extraZid;

    results.zidoviBruto = zidoviBruto;
    results.zidoviNakonVrata = zidoviNakonVrata;
    results.zidoviNeto = zidoviNeto;
    results.odbitakVrata = areaVrata;
    results.extraZid = extraZid;

    html += `<b>Zidovi:</b><br>`;
    html += `Bruto: 2(D√óV) + 2(≈†√óV) = 2(${formatHr(D)}√ó${formatHr(V)}) + 2(${formatHr(S)}√ó${formatHr(V)}) = ${formatHr(zidoviBruto)} m¬≤<br>`;
    html += `Odbitak vrata: ${formatHr(areaVrata)} m¬≤ ‚áí nakon vrata: ${formatHr(zidoviNakonVrata)} m¬≤<br>`;
    if (extraZid !== 0) {
      html += `Dodatne dimenzije: ${extraZid > 0 ? "+" : ""}${formatHr(extraZid)} m¬≤<br>`;
    }
    html += `Neto zidovi = <b>${formatHr(zidoviNeto)} m¬≤</b><br><br>`;

    prices.zidovi = { qty: zidoviNeto, unit: "m2" 
    };
    
    

  // HIDRO POD
if (chkHidroPod) {
    const hidroOsnovno = D * S;
    const hidroPod = hidroOsnovno + extraHidroPod;

    results.hidroPod = hidroPod;
    results.hidroPodData = { osnovno: hidroOsnovno, extra: extraHidroPod };

    html += `<b>Hidro ‚Äì pod:</b><br>`;
    html += `Osnovno: D √ó ≈† = ${formatHr(D)} √ó ${formatHr(S)} = ${formatHr(hidroOsnovno)} m¬≤<br>`;
    if (extraHidroPod !== 0) {
      html += `Dodatne dimenzije: ${extraHidroPod > 0 ? "+" : ""}${formatHr(extraHidroPod)} m¬≤<br>`;
    }
    html += `Ukupno hidro pod = <b>${formatHr(hidroPod)} m¬≤</b><br><br>`;

    prices.hidroPod = { qty: hidroPod, unit: "m2" };
}

  // HIDRO TU≈†
  if (chkHidroTus) {
    const td = parseNum(document.getElementById('tusD').value);
    const ts = parseNum(document.getElementById('tusS').value);
    let tv = parseNum(document.getElementById('tusV').value);
    if (!tv) tv = V;
    const opsegTus = 2 * td + ts;
    const hidroTus = opsegTus * tv;
    results.hidroTus = hidroTus;
    results.tus = { td, ts, tv, opseg: opsegTus };

    html += `<b>Hidro ‚Äì tu≈° zona:</b><br>`;
    html += `Opseg tu≈°a = 2√ód + ≈° = 2√ó${formatHr(td)} + ${formatHr(ts)} = ${formatHr(opsegTus)} m<br>`;
    html += `Hidro tu≈° = opseg √ó visina = ${formatHr(opsegTus)} √ó ${formatHr(tv)} = <b>${formatHr(hidroTus)} m¬≤</b><br><br>`;

    prices.hidroTus = { qty: hidroTus, unit: "m2" };
  }

  // HIDRO TRAKA
  if (chkHidroTraka) {
    const base = 2 * D + 2 * S + 2 * V;
    let perimProzoriNise = 0;

    openings.forEach(o => {
      if (o.type === "prozor" || o.type === "nisa") {
        perimProzoriNise += openingPerim(o);
      }
    });

    const hidroTraka = base + perimProzoriNise + extraTraka;

    results.hidroTraka = hidroTraka;
    results.hidroTrakaData = {
      base,
      perimProzoriNise,
      extraTraka
    };

    html += `<b>Hidro traka:</b><br>`;
    html += `Osnovno: 2D + 2≈† + 2V = 2√ó${formatHr(D)} + 2√ó${formatHr(S)} + 2√ó${formatHr(V)} = ${formatHr(base)} m<br>`;
    html += `Rub prozora i ni≈°a: ${formatHr(perimProzoriNise)} m<br>`;
    if (extraTraka !== 0) {
      html += `Dodatne dimenzije: ${extraTraka > 0 ? "+" : ""}${formatHr(extraTraka)} m<br>`;
    }
    html += `Ukupno hidro traka = <b>${formatHr(hidroTraka)} m</b><br><br>`;

    prices.hidroTraka = { qty: hidroTraka, unit: "m" };
  }
  ;
    const hidroTraka = base + perimProzoriNise;
    results.hidroTraka = hidroTraka;
    results.hidroTrakaData = { base, perimProzoriNise };

    html += `<b>Hidro traka:</b><br>`;
    html += `Osnovno = 2√óD + 2√ó≈† + 2√óV = 2√ó${formatHr(D)} + 2√ó${formatHr(S)} + 2√ó${formatHr(V)} = ${formatHr(base)} m<br>`;
    html += `Rub prozora i ni≈°a = ${formatHr(perimProzoriNise)} m<br>`;
    html += `Ukupno hidro traka = <b>${formatHr(hidroTraka)} m</b><br><br>`;

    prices.hidroTraka = { qty: hidroTraka, unit: "m" };
  }

  // RUBOVI OTVORA ZA SILIKON (bez vrata)
  let perimSilOpenings = 0;
  openings.forEach(o => {
    if (o.type !== 'vrata') perimSilOpenings += openingPerim(o);
  });

  // SILIKON
if (chkSilikon) {
    const base = 2 * D + 2 * S + 4 * V;

    let extraHeights = 0;
    const heightInputs = silContainer.querySelectorAll('.silHeightVal');
    heightInputs.forEach(inp => {
      extraHeights += parseNum(inp.value);
    });

    const silikon = base + extraHeights + perimSilOpenings + extraSilikon;

    results.silikon = silikon;
    results.silikonData = {
      base,
      extraHeights,
      perimSilOpenings,
      extraSilikon
    };

    html += `<b>Silikon:</b><br>`;
    html += `Osnovni opseg: 2D + 2≈† + 4V = 2√ó${formatHr(D)} + 2√ó${formatHr(S)} + 4√ó${formatHr(V)} = ${formatHr(base)} m<br>`;
    html += `Zbroj dodatnih visina: ${formatHr(extraHeights)} m<br>`;
    html += `Rubovi otvora (bez vrata): ${formatHr(perimSilOpenings)} m<br>`;
    if (extraSilikon !== 0) {
      html += `Dodatne dimenzije: ${extraSilikon > 0 ? "+" : ""}${formatHr(extraSilikon)} m<br>`;
    }
    html += `Ukupno silikon = <b>${formatHr(silikon)} m</b><br><br>`;

    prices.silikon = { qty: silikon, unit: "m" };
;




  // SOKL
  if (chkSokl) {
    const osnovni = 2 * (D + S);
    const minus = parseNum(document.getElementById('soklMinus').value);
    const plus  = parseNum(document.getElementById('soklPlus').value);
    const sokl = osnovni - minus + plus;
    results.sokl = sokl;
    results.soklData = { osnovni, minus, plus };

    html += `<b>Sokl:</b><br>`;
    html += `Osnovni opseg = 2√ó(D+≈†) = 2√ó(${formatHr(D)}+${formatHr(S)}) = ${formatHr(osnovni)} m<br>`;
    html += `‚àí odbijanje = ${formatHr(minus)} m<br>`;
    html += `+ dodatno = ${formatHr(plus)} m<br>`;
    html += `Ukupno sokl = <b>${formatHr(sokl)} m</b><br><br>`;

    prices.sokl = { qty: sokl, unit: "m" };
  }

  // STEPENICE
  if (chkStepenice) {
    const sw = parseNum(document.getElementById('stepWidth').value);
    const sc = parseIntSafe(document.getElementById('stepCount').value);
    const mode = document.getElementById('stepMode').value || 'duzni';
    const stepeniceVal = sw * sc;
    results.stepenice = { vrijednost: stepeniceVal, mode, sw, sc };

    html += `<b>Stepenice:</b><br>`;
    html += `≈†irina √ó komada = ${formatHr(sw)} √ó ${sc} = <b>${formatHr(stepeniceVal)} ${mode === 'duzni' ? 'm' : 'kom'}</b><br><br>`;

    if (mode === 'duzni') {
      prices.stepeniceM = { qty: stepeniceVal, unit: "m" };
    } else {
      prices.stepeniceKom = { qty: sc, unit: "kom" };
    }
  }

  // LAJSNE
  if (chkLajsne) {
    const L1 = parseNum(document.getElementById('l1').value);
    const L2 = parseNum(document.getElementById('l2').value);
    const L3 = parseNum(document.getElementById('l3').value);
    const baseL = L1 + L2 + L3;

    const lProzor = document.getElementById('lProzor').checked;
    const lNisa   = document.getElementById('lNisa').checked;
    const lGeb    = document.getElementById('lGeberit').checked;
    const lVert   = document.getElementById('lVert').checked;

    let perimLajsne = 0;
    openings.forEach(o => {
      if (o.type === 'prozor' && lProzor) perimLajsne += openingPerim(o);
      if (o.type === 'nisa'   && lNisa)   perimLajsne += openingPerim(o);
      if (o.type === 'geberit'&& lGeb)    perimLajsne += openingPerim(o);
      if (o.type === 'vert'   && lVert)   perimLajsne += openingPerim(o);
    });

    const lajsne = baseL + perimLajsne;
    results.lajsne = lajsne;
    results.lajsneData = { baseL, perimLajsne };

    html += `<b>Lajsne:</b><br>`;
    html += `Ruƒçno = ${formatHr(baseL)} m<br>`;
    html += `Rubovi prozor/ni≈°a/geberit/vertikale (prema kvaƒçicama) = ${formatHr(perimLajsne)} m<br>`;
    html += `Ukupno lajsne = <b>${formatHr(lajsne)} m</b><br><br>`;

    prices.lajsne = { qty: lajsne, unit: "m" };
  }

  // GERUNG
  if (chkGerung) {
    const G1 = parseNum(document.getElementById('g1').value);
    const G2 = parseNum(document.getElementById('g2').value);
    const G3 = parseNum(document.getElementById('g3').value);
    const baseG = G1 + G2 + G3;

    const gProzor = document.getElementById('gProzor').checked;
    const gNisa   = document.getElementById('gNisa').checked;
    const gGeb    = document.getElementById('gGeberit').checked;
    const gVert   = document.getElementById('gVert').checked;

    let perimGerung = 0;
    openings.forEach(o => {
      if (o.type === 'prozor' && gProzor) perimGerung += openingPerim(o);
      if (o.type === 'nisa'   && gNisa)   perimGerung += openingPerim(o);
      if (o.type === 'geberit'&& gGeb)    perimGerung += openingPerim(o);
      if (o.type === 'vert'   && gVert)   perimGerung += openingPerim(o);
    });

    const gerung = baseG + perimGerung;
    results.gerung = gerung;
    results.gerungData = { baseG, perimGerung };

    html += `<b>Gerung:</b><br>`;
    html += `Ruƒçno = ${formatHr(baseG)} m<br>`;
    html += `Rubovi prozor/ni≈°a/geberit/vertikale (prema kvaƒçicama) = ${formatHr(perimGerung)} m<br>`;
    html += `Ukupno gerung = <b>${formatHr(gerung)} m</b><br><br>`;

    prices.gerung = { qty: gerung, unit: "m" };
  }

  // DODATNE MJERE
  let dmTotal = 0;
  let dmRowsData = [];
  if (chkDodatne) {
    const rows = dmContainer.querySelectorAll('.dm-row');
    rows.forEach(row => {
      const name = row.querySelector('.dmName').value || '';
      const val = parseNum(row.querySelector('.dmVal').value);
      const sign = row.querySelector('.dmSign').value;
      const signedVal = sign === '-' ? -val : val;
      dmTotal += signedVal;
      dmRowsData.push({ name, val, sign, signedVal });
    ;

    // DODATNE MJERE (+/-)
  const dmPod  = document.getElementById('dmPod').checked;
  const dmZid  = document.getElementById('dmZid').checked;
  const dmHid  = document.getElementById('dmHid').checked;
  const dmSil  = document.getElementById('dmSil').checked;
  const dmTrak = document.getElementById('dmTraka').checked;
  const dmSok  = document.getElementById('dmSok').checked;

  html += `<b>Dodatne mjere (+/-):</b><br>`;

  if (!dmRowsData.length) {
    html += `Nema unesenih dodatnih mjera.<br><br>`;
  } else {
    dmRowsData.forEach((r, idx) => {
      html += `${idx + 1}. ${r.name || 'Mjera'}: ${r.sign}${formatHr(r.val)} m ‚Üí ${r.targetLabel}<br>`;
    });
    html += `Ukupno dodatne mjere = <b>${formatHr(dmTotal)} m</b><br><br>`;
  }

  if (dmTotal !== 0) {
    if (dmPod  && results.pod        != null) results.pod        += dmTotal;
    if (dmZid  && results.zidoviNeto != null) results.zidoviNeto += dmTotal;
    if (dmHid  && results.hidroPod   != null) results.hidroPod   += dmTotal;
    if (dmSil  && results.silikon    != null) results.silikon    += dmTotal;
    if (dmTrak && results.hidroTraka != null) results.hidroTraka += dmTotal;
    if (dmSok  && results.sokl       != null) results.sokl       += dmTotal;
  }

  results.dm = { total: dmTotal, rows: dmRowsData };
  }

  state.lastCalc = {
    D, S, V,
    meta,
    openings: JSON.parse(JSON.stringify(openings)),
    results,
    prices
  };

  if (showHtml) {
    document.getElementById('calcOutput').innerHTML = html;
    document.getElementById('calcResult').style.display = 'block';
  }

  return state.lastCalc;
}

// PDF ‚Äì GRAƒêEVINSKA KNJIGA (tablica + obrazlo≈æenje)
function buildPdfDocument(data) {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) {
    alert("PDF modul nije uƒçitan.");
    return null;
  }
  const doc = new jsPDF();
  let y = 15;

  function newPage() {
    doc.addPage();
    y = 15;
  }

  function writeLine(text, extra = 0) {
    const lines = doc.splitTextToSize(text, 190);
    lines.forEach(line => {
      if (y > 280) newPage();
      doc.text(line, 10, y);
      y += 5;
    });
    y += extra;
  }

  const m = data.meta;
  const r = data.results;
  const today = new Date();
  const dStr = `${String(today.getDate()).padStart(2,'0')}.${String(today.getMonth()+1).padStart(2,'0')}.${today.getFullYear()}.`;

  // HEADER
  doc.setFontSize(14);
  doc.text("KOB-Keramika ‚Äì Graƒëevinska knjiga (keramiƒçarski radovi)", 10, y);
  y += 8;

  doc.setFontSize(11);
  writeLine(`Gradili≈°te: ${m.siteName || "-"}`);
  writeLine(`Prostorija: ${m.roomName || "-"}`);
  writeLine(`Situacija: ${m.situationNo || "-"}`);
  writeLine(`Investitor: ${m.investorName || "-"}`);
  writeLine(`Format ploƒçice: ${m.tileFormat.label}`);
  writeLine(`Datum: ${dStr}`, 4);

  if (m.note) {
    writeLine(`Napomena: ${m.note}`, 4);
  }

  // GLAVNA TABLICA STAVKI (Rbr, Opis, JM, Koliƒçina, Jed. cijena, Iznos)
  const stavke = [];
  function addStavka(rbr, opis, keyRez, defJm, priceKey) {
    const item = data.results[keyRez];
    if (item == null) return;
    let kolicina;
    if (typeof item === 'object' && item.vrijednost != null) {
      kolicina = item.vrijednost;
    } else {
      kolicina = item;
    }
    const jm = defJm;
    const cijena = getPrice(priceKey);
    const iznos  = cijena * kolicina;
    stavke.push({
      rbr,
      opis,
      jm,
      qty: kolicina,
      cijena,
      iznos
    });
  }

  addStavka(1, "Pod ‚Äì oblaganje keramiƒçkim ploƒçicama",      "pod",        "m2",  "Pod");
  addStavka(2, "Zidovi ‚Äì oblaganje keramiƒçkim ploƒçicama",   "zidoviNeto", "m2",  "Zidovi");
  addStavka(3, "Hidroizolacija ‚Äì pod",                      "hidroPod",   "m2",  "Hidro pod");
  addStavka(4, "Hidroizolacija ‚Äì tu≈° zona",                 "hidroTus",   "m2",  "Hidro tu≈°");
  addStavka(5, "Hidro traka",                               "hidroTraka", "m",   "Hidro traka");
  addStavka(6, "Silikon",                                   "silikon",    "m",   "Silikon");
  addStavka(7, "Sokl",                                      "sokl",       "m",   "Sokl");

  if (r.stepenice) {
    const jm = (r.stepenice.mode === 'duzni') ? 'm' : 'kom';
    const keyPrice = (r.stepenice.mode === 'duzni') ? 'Stepenice m' : 'Stepenice kom';
    const kolicina = r.stepenice.vrijednost;
    const cijena   = getPrice(keyPrice);
    const iznos    = cijena * kolicina;
    stavke.push({
      rbr: stavke.length+1,
      opis: "Stepenice",
      jm,
      qty: kolicina,
      cijena,
      iznos
    });
  }

  addStavka(stavke.length+1, "Lajsne", "lajsne", "m", "Lajsne");
  addStavka(stavke.length+1, "Gerung", "gerung", "m", "Gerung");

  let ukupnoIznos = 0;
  stavke.forEach(s => ukupnoIznos += s.iznos || 0);

  doc.setFontSize(12);
  writeLine("Tablica ‚Äì keramiƒçarski radovi", 2);

  function drawHeaderRow() {
    if (y > 270) newPage();
    doc.setFontSize(10);
    doc.text("Rbr", 10, y);
    doc.text("Opis radova", 22, y);
    doc.text("JM", 100, y);
    doc.text("Koliƒçina", 115, y);
    doc.text("Jed. cijena", 140, y);
    doc.text("Iznos", 170, y);
    y += 5;
  }

  drawHeaderRow();
  doc.setFontSize(10);
  stavke.forEach((s, idx) => {
    if (y > 280) {
      newPage();
      drawHeaderRow();
    }
    doc.text(String(idx+1), 10, y);
    doc.text(s.opis, 22, y);
    doc.text(s.jm, 100, y);
    doc.text(formatHr(s.qty, 3), 115, y, { align:"right" });
    doc.text(formatHr(s.cijena, 2), 150, y, { align:"right" });
    doc.text(formatHr(s.iznos, 2), 190, y, { align:"right" });
    y += 5;
  });

  if (stavke.length) {
    y += 4;
    if (y > 280) newPage();
    doc.setFontSize(11);
    doc.text("UKUPNO:", 140, y);
    doc.text(formatHr(ukupnoIznos, 2) + " ‚Ç¨", 190, y, { align:"right" });
    y += 8;
  }

  // OBRAZLO≈ΩENJE MJERA ‚Äì po sekcijama
  doc.setFontSize(12);
  writeLine("Obrazlo≈æenje mjera", 4);
  doc.setFontSize(11);

  // 1. Dimenzije
  writeLine(`1. Osnovne dimenzije: D=${formatHr(data.D)} m, ≈†=${formatHr(data.S)} m, V=${formatHr(data.V)} m`, 2);

  // 2. Pod
  if (r.pod != null) {
    writeLine("2. Pod:", 1);
    writeLine(`   Povr≈°ina poda: D√ó≈† = ${formatHr(data.D)} √ó ${formatHr(data.S)} = ${formatHr(r.pod)} m¬≤`, 3);
  }

  // 3. Zidovi
  if (r.zidoviNeto != null) {
    writeLine("3. Zidovi:", 1);
    writeLine(`   Bruto zidovi: 2(D√óV) + 2(≈†√óV) = 2(${formatHr(data.D)}√ó${formatHr(data.V)}) + 2(${formatHr(data.S)}√ó${formatHr(data.V)}) = ${formatHr(r.zidoviBruto)} m¬≤`);
    writeLine(`   Odbitak vrata: ${formatHr(r.odbitakVrata || 0)} m¬≤`);
    writeLine(`   Neto zidovi: ${formatHr(r.zidoviNeto)} m¬≤`, 3);
  }

  // 4. Hidro pod
  if (r.hidroPod != null) {
    writeLine("4. Hidroizolacija ‚Äì pod:", 1);
    writeLine(`   D√ó≈† = ${formatHr(data.D)} √ó ${formatHr(data.S)} = ${formatHr(r.hidroPod)} m¬≤`, 3);
  }

  // 5. Hidro tu≈°
  if (r.hidroTus != null && r.tus) {
    writeLine("5. Hidroizolacija ‚Äì tu≈° zona:", 1);
    const t = r.tus;
    writeLine(`   Opseg tu≈°a: 2d + ≈° = 2√ó${formatHr(t.td)} + ${formatHr(t.ts)} = ${formatHr(t.opseg)} m`);
    writeLine(`   Povr≈°ina tu≈°a: (2d + ≈°)√óv = ${formatHr(t.opseg)} √ó ${formatHr(t.tv)} = ${formatHr(r.hidroTus)} m¬≤`, 3);
  }

  // 6. Hidro traka
  if (r.hidroTraka != null && r.hidroTrakaData) {
    const dH = r.hidroTrakaData;
    writeLine("6. Hidro traka:", 1);
    writeLine(`   Osnovno: 2D + 2≈† + 2V = 2√ó${formatHr(data.D)} + 2√ó${formatHr(data.S)} + 2√ó${formatHr(data.V)} = ${formatHr(dH.base)} m`);
    writeLine(`   Rub prozora i ni≈°a: ‚àë obod = ${formatHr(dH.perimProzoriNise)} m`);
    writeLine(`   Ukupno hidro traka: ${formatHr(r.hidroTraka)} m`, 3);
  }

  // 7. Silikon
  if (r.silikon != null && r.silikonData) {
    const dS = r.silikonData;
    writeLine("7. Silikon:", 1);
    writeLine(`   Osnovni opseg: 2D + 2≈† + 4V = 2√ó${formatHr(data.D)} + 2√ó${formatHr(data.S)} + 4√ó${formatHr(data.V)} = ${formatHr(dS.base)} m`);
    writeLine(`   Dodatne visine: ‚àë = ${formatHr(dS.extraHeights)} m`);
    writeLine(`   Rubovi otvora (bez vrata): ‚àë obod = ${formatHr(dS.perimSilOpenings)} m`);
    writeLine(`   Ukupno silikon: ${formatHr(r.silikon)} m`, 3);
  }

  // 8. Sokl
  if (r.sokl != null && r.soklData) {
    const dSo = r.soklData;
    writeLine("8. Sokl:", 1);
    writeLine(`   Osnovni opseg: 2(D+≈†) = 2(${formatHr(data.D)}+${formatHr(data.S)}) = ${formatHr(dSo.osnovni)} m`);
    writeLine(`   Odbijanje: -${formatHr(dSo.minus)} m`);
    writeLine(`   Dodatno: +${formatHr(dSo.plus)} m`);
    writeLine(`   Ukupno sokl: ${formatHr(r.sokl)} m`, 3);
  }

  // 9. Stepenice
  if (r.stepenice != null) {
    const st = r.stepenice;
    writeLine("9. Stepenice:", 1);
    writeLine(`   ≈† √ó kom = ${formatHr(st.sw)} √ó ${st.sc} = ${formatHr(st.vrijednost)} ${st.mode === 'duzni' ? 'm' : 'kom'}`, 3);
  }

  // 10. Lajsne
  if (r.lajsne != null && r.lajsneData) {
    const dL = r.lajsneData;
    writeLine("10. Lajsne:", 1);
    writeLine(`   Ruƒçno: ${formatHr(dL.baseL)} m`);
    writeLine(`   Rubovi elemenata: ${formatHr(dL.perimLajsne)} m`);
    writeLine(`   Ukupno lajsne: ${formatHr(r.lajsne)} m`, 3);
  }

  // 11. Gerung
  if (r.gerung != null && r.gerungData) {
    const dG = r.gerungData;
    writeLine("11. Gerung:", 1);
    writeLine(`   Ruƒçno: ${formatHr(dG.baseG)} m`);
    writeLine(`   Rubovi elemenata: ${formatHr(dG.perimGerung)} m`);
    writeLine(`   Ukupno gerung: ${formatHr(r.gerung)} m`, 3);
  }

  // 12. Dodatne mjere
  if (r.dm && r.dm.rows && r.dm.rows.length) {
    writeLine("12. Dodatne mjere:", 1);
    r.dm.rows.forEach((row, idx) => {
      writeLine(`   ${idx+1}. ${row.name || 'Mjera'}: ${row.sign}${formatHr(row.val)} ‚áí ${formatHr(row.signedVal)}`);
    });
    writeLine(`   Ukupno dodatne mjere: ${formatHr(r.dm.total)}`, 3);
  }

  // 13. Otvori
  if (data.openings && data.openings.length) {
    writeLine("13. Otvori ‚Äì specifikacija", 2);
    data.openings.forEach(o => {
      writeLine(`   - ${o.label}: tip=${o.type}, ≈†=${formatHr(o.w)} m, V=${formatHr(o.h)} m, kom=${o.count}, pov=${formatHr(openingArea(o))} m¬≤, obod=${formatHr(openingPerim(o))} m, odbija zidove=${o.subtract ? 'DA':'NE'}`);
    });
  }

  if (y > 270) newPage();
  writeLine("Napomena: Izraƒçun je izraƒëen kao interna graƒëevinska knjiga za keramiƒçarske radove KOB-Keramika.", 0);

  return doc;
}

// PDF DOWNLOAD
document.getElementById('btnExportPdfAuto').addEventListener('click', () => {
  const data = runAutoCalc(true);
  if (!data) return;
  const doc = buildPdfDocument(data);
  if (!doc) return;
  const m = data.meta;
  const today = new Date();
  const dStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
  const safeSite = (m.siteName || "gradiliste").replace(/\s+/g,'_');
  const safeRoom = (m.roomName || "prostorija").replace(/\s+/g,'_');
  const filename = `GK_${safeSite}_${safeRoom}_${dStr}.pdf`;
  doc.save(filename);

  // upload u Cloud (Storage) ako je user prijavljen
  if (CURRENT_USER) {
    const blob = doc.output('blob');
    const file = new File([blob], filename, { type: "application/pdf" });
    uploadFileToCloud(file, filename).catch(console.error);
  }
});

// CSV EXPORT
document.getElementById('btnExportCsvAuto').addEventListener('click', () => {
  const data = runAutoCalc(true);
  if (!data) return;
  const r = data.results;
  const rows = [];
  const push = (name, val, unit, desc, tip) => {
    rows.push([name, formatHr(val), unit, desc, tip]);
  };

  push("Duljina", data.D, "m", "Unesena mjera", "osnovno");
  push("≈†irina", data.S, "m", "Unesena mjera", "osnovno");
  push("Visina", data.V, "m", "Unesena mjera", "osnovno");
  push("Format ploƒçice", data.meta.tileFormat.label, "", "Format", "info");

  if (r.pod != null)        push("Pod", r.pod, "m2", "D√ó≈†", "povr≈°ina");
  if (r.zidoviNeto != null) push("Zidovi neto", r.zidoviNeto, "m2", "Bruto - vrata", "povr≈°ina");
  if (r.hidroPod != null)   push("Hidro pod", r.hidroPod, "m2", "", "povr≈°ina");
  if (r.hidroTus != null)   push("Hidro tu≈° zona", r.hidroTus, "m2", "(2d+≈°)√óv", "povr≈°ina");
  if (r.hidroTraka != null) push("Hidro traka", r.hidroTraka, "m", "", "du≈æni");
  if (r.silikon != null)    push("Silikon", r.silikon, "m", "", "du≈æni");
  if (r.sokl != null)       push("Sokl", r.sokl, "m", "", "du≈æni");
  if (r.stepenice != null)  push("Stepenice", r.stepenice.vrijednost, (r.stepenice.mode === 'duzni' ? "m" : "kom"), "", r.stepenice.mode === 'duzni' ? "du≈æni" : "kom");
  if (r.lajsne != null)     push("Lajsne", r.lajsne, "m", "", "du≈æni");
  if (r.gerung != null)     push("Gerung", r.gerung, "m", "", "du≈æni");

  if (data.openings && data.openings.length) {
    data.openings.forEach(o => {
      push(
        `Otvor - ${o.label}`,
        openingArea(o),
        "m2",
        `tip=${o.type}, ≈†=${formatHr(o.w)}, V=${formatHr(o.h)}, kom=${o.count}, odbija=${o.subtract?'DA':'NE'}`,
        "otvor"
      );
    });
  }

  const header = ["Naziv","Vrijednost","Jedinica","Opis","Tip"];
  const csv = [header].concat(rows)
    .map(row => row.map(v => `"${String(v).replace(/"/g,'""')}"`).join(";"))
    .join("\n");

  const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const filename = "kob-keramika-auto-obracun.csv";
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  if (CURRENT_USER) {
    const file = new File([blob], filename, { type: "text/csv;charset=utf-8" });
    uploadFileToCloud(file, filename).catch(console.error);
  }
});

// CLOUD STORAGE ‚Äì datoteke (users/{uid}/sve_datoteke)
async function uploadFileToCloud(file, filename) {
  if (!CURRENT_USER) return null;
  const safeName = filename.replace(/[^\w.\-]+/g, "_");
  const path = `users/${CURRENT_USER.uid}/sve_datoteke/${Date.now()}_${safeName}`;
  const ref  = storage.ref(path);
  await ref.put(file);
  const url = await ref.getDownloadURL();
  return { path, url };
}

async function listCloudFiles() {
  if (!CURRENT_USER) return [];
  const basePath = `users/${CURRENT_USER.uid}/sve_datoteke`;
  const baseRef  = storage.ref(basePath);
  const res = await baseRef.listAll();
  const files = [];
  for (const item of res.items) {
    const url = await item.getDownloadURL();
    files.push({ name: item.name, fullPath: item.fullPath, url });
  }
  files.sort((a,b) => a.name.localeCompare(b.name));
  return files;
}

async function deleteCloudFile(fullPath) {
  const ref = storage.ref(fullPath);
  await ref.delete();
}

async function renderCloudFiles() {
  if (!CURRENT_USER) return;
  const holder = document.getElementById("cloudFileList");
  if (!holder) return;
  holder.innerHTML = "Uƒçitavanje...";
  try {
    const files = await listCloudFiles();
    if (!files.length) {
      holder.innerHTML = "<p>Nema spremljenih datoteka.</p>";
      return;
    }
    holder.innerHTML = "";
    files.forEach(f => {
      const row = document.createElement("div");
      row.className = "fileRow";
      row.innerHTML = `
        <div style="word-break:break-all;">${f.name}</div>
        <div style="display:flex;gap:6px;">
          <button style="width:auto;padding:4px 8px;font-size:12px" onclick="window.open('${f.url}','_blank')">üì•</button>
          <button style="width:auto;padding:4px 8px;font-size:12px;background:#b00020;color:#fff"
                  onclick="if(confirm('Obrisati datoteku?')) deleteCloudFile('${f.fullPath}').then(renderCloudFiles)">üóë</button>
        </div>
      `;
      holder.appendChild(row);
    });
  } catch (e) {
    console.error(e);
    holder.innerHTML = "<p>Gre≈°ka pri uƒçitavanju datoteka.</p>";
  }
}

// ARHIVA OBRAƒåUNA (FIRESTORE 'obracuni' + PDF URL)
document.getElementById('btnSaveCloud').addEventListener('click', async () => {
  if (!CURRENT_USER) {
    alert("Mora≈° biti prijavljen za spremanje u Cloud.");
    return;
  }
  const data = runAutoCalc(true);
  if (!data) return;

  try {
    const docRef = await db.collection('obracuni').add({
      userId: CURRENT_USER.uid,
      userEmail: CURRENT_USER.email || null,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      meta: data.meta,
      D: data.D,
      S: data.S,
      V: data.V,
      openings: data.openings,
      results: data.results,
      prices: data.prices || {}
    });

    const pdfDoc = buildPdfDocument(data);
    const blob = pdfDoc.output('blob');
    const filePath = `pdfs/${docRef.id}.pdf`;
    const storageRef = storage.ref().child(filePath);
    await storageRef.put(blob);
    const pdfURL = await storageRef.getDownloadURL();
    await docRef.update({ pdfURL, pdfPath: filePath });

    alert("Obraƒçun i PDF spremljeni u Cloud.");
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri spremanju u Cloud: " + e.message);
  }
});

async function loadArchive() {
  const list = document.getElementById('archiveList');
  if (!list) return;
  list.innerHTML = "Uƒçitavanje...";
  try {
    const snap = await db.collection('obracuni').orderBy('createdAt', 'desc').limit(50).get();
    if (snap.empty) {
      list.innerHTML = "<p style='font-size:12px;opacity:0.7;'>Nema spremljenih obraƒçuna.</p>";
      return;
    }
    let html = "";
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const id = docSnap.id;
      const m = d.meta || {};
      const created = d.createdAt ? d.createdAt.toDate() : null;
      const dateStr = created
        ? `${String(created.getDate()).padStart(2,'0')}.${String(created.getMonth()+1).padStart(2,'0')}.${created.getFullYear()}.`
        : "-";
      html += `
        <div class="archive-list-item">
          <div><b>${m.siteName || 'Bez naziva'}</b> ‚Äì ${m.roomName || ''}</div>
          <div style="font-size:12px;opacity:0.8;">
            Situacija: ${m.situationNo || '-'} ‚Ä¢ Investitor: ${m.investorName || '-'} ‚Ä¢ Format: ${m.tileFormat ? m.tileFormat.label : '-'}
          </div>
          <div style="font-size:11px;opacity:0.7;">
            Datum: ${dateStr} ‚Ä¢ ID: ${id} ‚Ä¢ Korisnik: ${d.userEmail || d.userId || '-'}
          </div>
          <div class="archive-actions">
            ${d.pdfURL ? `<a class="btn-small" style="text-decoration:none;background:#fff;color:#000;border-radius:8px;padding:4px 8px;" href="${d.pdfURL}" target="_blank">üìÑ PDF</a>` : ""}
            <button class="btn-small secondary" onclick="reloadFromCloud('${id}')">üîç Otvori u kalkulatoru</button>
            <button class="btn-small secondary" onclick="deleteCloudRecord('${id}')">üóë Obri≈°i</button>
          </div>
        </div>
      `;
    });
    list.innerHTML = html;
  } catch (e) {
    console.error(e);
    list.innerHTML = "<p style='color:#f66;font-size:12px;'>Gre≈°ka pri ƒçitanju Cloud arhive.</p>";
  }
}

async function reloadFromCloud(id) {
  try {
    const docSnap = await db.collection('obracuni').doc(id).get();
    if (!docSnap.exists) {
      alert("Dokument ne postoji.");
      return;
    }
    const d = docSnap.data();
    const m = d.meta || {};
    document.getElementById('siteName').value = m.siteName || "";
    document.getElementById('roomName').value = m.roomName || "";
    document.getElementById('situationNo').value = m.situationNo || "";
    document.getElementById('investorName').value = m.investorName || "";
    document.getElementById('gkNapomena').value = m.note || "";

    if (m.tileFormat && m.tileFormat.wcm && m.tileFormat.hcm) {
      const val = `${m.tileFormat.wcm}x${m.tileFormat.hcm}`;
      const select = document.getElementById('tileFormatSelect');
      if ([...select.options].some(o => o.value === val)) {
        select.value = val;
        tileCustomFields.style.display = 'none';
      } else {
        select.value = 'custom';
        tileCustomFields.style.display = 'block';
        document.getElementById('tileW').value = m.tileFormat.wcm;
        document.getElementById('tileH').value = m.tileFormat.hcm;
      }
    }

    document.getElementById('dimD').value = String(d.D).replace('.', ',');
    document.getElementById('dimS').value = String(d.S).replace('.', ',');
    document.getElementById('dimV').value = String(d.V).replace('.', ',');

    openings = d.openings || [];
    renderOpenings();

    showView('autoCalcView');
    runAutoCalc(true);
    alert("Obraƒçun uƒçitan iz Clouda.");
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri uƒçitavanju iz Clouda: " + e.message);
  }
}

async function deleteCloudRecord(id) {
  if (!confirm("Stvarno obrisati ovaj obraƒçun i njegov PDF?")) return;
  try {
    const docSnap = await db.collection('obracuni').doc(id).get();
    if (docSnap.exists) {
      const d = docSnap.data();
      if (d.pdfPath) {
        try {
          await storage.ref().child(d.pdfPath).delete();
        } catch (e) {
          console.warn("Ne mogu obrisati PDF iz Storage-a:", e.message);
        }
      }
    }
    await db.collection('obracuni').doc(id).delete();
    alert("Obraƒçun obrisan.");
    loadArchive();
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri brisanju: " + e.message);
  }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {

  // HOME VIEW button handlers
  const btns = [
    ["btnOpenAutoCalc",   "autoCalcView"],
    ["btnOpenMeasures",   "measuresView"],
    ["btnOpenCosts",      "costsView"],
    ["btnOpenPrices",     "pricesView"],
    ["btnOpenArchive",    "cloudView"],
    ["btnOpenBook",       "bookView"]  // ako ga jo≈° nema≈°, samo ignorira
  ];

  btns.forEach(([btnId, view]) => {
    const b = document.getElementById(btnId);
    if (!b) return;
    b.addEventListener("click", () => {
      if (typeof requireAuth === "function" && !requireAuth()) return;
      showView(view);
    });
  });

});
</script>
</body>
</html>
