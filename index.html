<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KOB-Keramika ‚Äì Pro obraƒçun</title>

<style>
  body {
    margin:0;
    padding:0;
    font-family: Arial, sans-serif;
    background:#202020;
    color:#f2f2f2;
  }
  header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 14px;
    background:#111;
    border-bottom:1px solid #333;
  }
  header .left {
    display:flex;
    align-items:center;
    gap:10px;
  }
  .logo {
    width:40px;
    height:40px;
  }
  main {
    padding:12px;
  }

  /* Cards */
  .card {
    background:#2a2a2a;
    padding:12px;
    border-radius:8px;
    margin-bottom:15px;
    border:1px solid #3b3b3b;
  }

  /* Buttons */
  button {
    width:100%;
    padding:10px;
    border:none;
    border-radius:6px;
    background:#3c82f6;
    color:white;
    font-size:14px;
    margin-top:8px;
    cursor:pointer;
  }
  button.secondary {
    background:#444;
  }
  button.btn-small {
    width:auto;
    padding:4px 8px;
    font-size:12px;
    margin:0;
  }

  .section-title {
    margin-top:8px;
    font-weight:bold;
    font-size:14px;
  }

  .checkbox-row {
    display:flex;
    gap:6px;
    align-items:center;
    margin-top:4px;
  }

  input[type="number"], input[type="text"], select {
    width:100%;
    padding:8px;
    background:#333;
    border:1px solid #444;
    border-radius:6px;
    color:white;
    margin-top:4px;
  }

  /* Otvori */
  .openings-header {
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-bottom:8px;
  }

  .open-item {
    border:1px solid #444;
    padding:6px;
    border-radius:6px;
    margin-bottom:6px;
  }

  /* Rezultati */
  #calcOutput {
    font-size: 13px;
    line-height:1.35;
  }

  /* Multi-room lista */
  #roomsList {
    font-size:13px;
  }

  /* DM rows */
  .dm-row {
    display:grid;
    grid-template-columns:1.3fr 1fr 1fr auto;
    gap:6px;
    margin-top:6px;
  }

</style>
</head>

<body>

<header>
  <div class="left">
    <img src="logo.png" class="logo" alt="Logo">
    <div>
      <div style="font-weight:bold">KOB-Keramika</div>
      <div style="font-size:12px;opacity:0.8;">Pro obraƒçun prostorije</div>
    </div>
  </div>
  <div id="userInfo" style="font-size:12px;opacity:0.7;">Nije prijavljen</div>
</header>

<main>

<!-- -------------------- HOME VIEW --------------------- -->
<section id="homeView" class="view" style="display:block;">
  <div class="card">
    <h2>Odaberi modul</h2>
    <button onclick="showView('autoCalcView')">üìê Automatski obraƒçun</button>
    <button onclick="showView('tileCalculatorView')" class="secondary">üî¢ Kalkulator ploƒçica</button>
    <button onclick="showView('archiveView')" class="secondary">üìÇ Arhiva</button>
    <button onclick="logout()" class="secondary">üö™ Odjava</button>
  </div>
</section>
<!-- ----------------------------------------------------- -->
<!-- AUTOMATSKI OBRAƒåUN PROSTORIJE                         -->
<!-- ----------------------------------------------------- -->

<section id="autoCalcView" class="view" style="display:none;">

  <div class="card">
    <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
    <h2>üìê Automatski obraƒçun</h2>
  </div>

  <!-- META PODACI -->
  <div class="card">
    <div class="section-title">üìå Podaci o gradili≈°tu</div>

    <label>Naziv gradili≈°ta</label>
    <input type="text" id="siteName" placeholder="npr. Stan Rude≈°">

    <label>Naziv prostorije</label>
    <input type="text" id="roomName" placeholder="npr. Kupaona 1">

    <label>Situacija broj</label>
    <input type="text" id="situationNo" placeholder="npr. 1">

    <label>Investitor</label>
    <input type="text" id="investorName" placeholder="npr. Marko Markiƒá">
  </div>


  <!-- DIMENZIJE PROSTORIJE -->
  <div class="card">
    <div class="section-title">üìè Dimenzije prostorije (m)</div>

    <label>Du≈æina</label>
    <input type="number" id="dimD" step="0.01" placeholder="npr. 3.20">

    <label>≈†irina</label>
    <input type="number" id="dimS" step="0.01" placeholder="npr. 2.40">

    <label>Visina</label>
    <input type="number" id="dimV" step="0.01" placeholder="npr. 2.60">
  </div>


  <!-- TU≈† ZONA -->
  <div class="card">
    <div class="section-title">üöø Tu≈° zona</div>
    <label>≈†irina (m)</label>
    <input type="number" id="tusS" step="0.01">

    <label>Du≈æina (m)</label>
    <input type="number" id="tusD" step="0.01">

    <label>Visina (m)</label>
    <input type="number" id="tusV" step="0.01">

    <div class="checkbox-row">
      <input type="checkbox" id="chkTus">
      <label for="chkTus">Obraƒçunati tu≈° zonu</label>
    </div>
  </div>


  <!-- FORMAT PLOƒåICA -->
  <div class="card">
    <div class="section-title">üß± Format ploƒçica</div>

    <label>Format</label>
    <select id="tileFormatSelect">
      <option value="">Odaberi</option>
      <option value="20x20">20√ó20</option>
      <option value="30x60">30√ó60</option>
      <option value="60x60">60√ó60</option>
      <option value="60x120">60√ó120</option>
      <option value="120x120">120√ó120</option>
      <option value="custom">Prilagoƒëeno</option>
    </select>

    <div id="tileCustomFields" style="display:none; margin-top:10px;">
      <label>≈†irina ploƒçice (cm)</label>
      <input type="number" id="tileW">

      <label>Visina ploƒçice (cm)</label>
      <input type="number" id="tileH">
    </div>
  </div>


  <!-- STEPENICE -->
  <div class="card">
    <div class="section-title">ü™ú Stepenice</div>

    <div class="checkbox-row">
      <input type="checkbox" id="chkStepenice">
      <label for="chkStepenice">Ukljuƒçiti stepenice</label>
    </div>

    <div id="stepeniceBox" style="display:none; margin-top:10px;">
      <label>Odaberi naƒçin obrade</label>
      <select id="stepType">
        <option value="duzni">Po du≈ænom metru</option>
        <option value="komad">Po komadu</option>
      </select>

      <div id="stepDuzinaBox" style="margin-top:10px;">
        <label>≈†irina stepenice (m)</label>
        <input type="number" id="stepWidth" step="0.01">

        <label>Broj stepenica</label>
        <input type="number" id="stepCount">
      </div>
    </div>
  </div>


  <!-- HIDRO / SOKL / SILIKON -->
  <div class="card">

    <div class="checkbox-row">
      <input type="checkbox" id="chkHidroPod">
      <label for="chkHidroPod">Hidroizolacija poda</label>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="chkHidroTus">
      <label for="chkHidroTus">Hidro tu≈° zona</label>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="chkHidroTraka">
      <label for="chkHidroTraka">Hidro traka</label>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="chkSokl">
      <label for="chkSokl">Sokl</label>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="chkSilikon">
      <label for="chkSilikon">Silikon</label>
    </div>

    <label style="margin-top:10px;">Du≈æina minus sokl (m)</label>
    <input type="number" id="soklMinus" step="0.01">

    <label>Dodatni sokl (m)</label>
    <input type="number" id="soklPlus" step="0.01">
  </div>


  <!-- DODATNE MJERE -->
  <div class="card">
    <div class="section-title">‚ûï Dodatne mjere</div>
    <div id="dmContainer"></div>

    <button class="btn-small secondary" id="btnAddDmRow">‚ûï Dodaj mjeru</button>

    <div class="section-title" style="margin-top:10px;">Gdje se primjenjuje?</div>

    <div class="checkbox-row">
      <input type="checkbox" id="dmPod"><label for="dmPod">Pod</label>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="dmZidovi"><label for="dmZidovi">Zidovi</label>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="dmHidro"><label for="dmHidro">Hidro pod</label>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="dmSil"><label for="dmSil">Silikon</label>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="dmTraka"><label for="dmTraka">Hidro traka</label>
    </div>

    <div class="checkbox-row">
      <input type="checkbox" id="dmSokl"><label for="dmSokl">Sokl</label>
    </div>
  </div>


  <!-- GUMBI ZA IZRAƒåUN -->
  <div class="card">
    <button id="btnCalcNow">üîç Izraƒçunaj sve</button>
    <button id="btnExportPdfAuto" class="secondary">üìÑ PDF ‚Äì graƒëevinska knjiga</button>
    <button id="btnExportCsvAuto" class="secondary">üìë CSV ‚Äì Excel export</button>
    <button id="btnSaveCloud" class="secondary">‚òÅÔ∏è Spremi u Cloud (podatci + PDF)</button>
  </div>


  <!-- MULTI ROOM ‚Äì DODAVANJE PROSTORIJA -->
  <div class="card">
    <h3>üèóÔ∏è Prostorije u ovom gradili≈°tu</h3>

    <button id="btnAddRoom" class="secondary">‚ûï Dodaj ovu prostoriju u gradili≈°te</button>

    <div id="roomsList" style="margin-top:10px;">
      <i style="opacity:0.7;font-size:12px;">Nema dodanih prostorija.</i>
    </div>

    <button id="btnExportPdfMulti" class="secondary" style="margin-top:10px;">
      üìÑ PDF ‚Äì graƒëevinska knjiga (vi≈°e prostorija)
    </button>
  </div>
  <!-- DESNA STRANA ‚Äì OTVORI + REZULTATI -->
  <div>

    <!-- OTVORI -->
    <div class="card">
      <div class="section-title">üß± Otvori (vrata, prozori, ni≈°e, geberit, vertikale)</div>
      <p style="font-size:12px;opacity:0.8;">
        Vrata se odbijaju od zidova, ali ne ulaze u silikon.<br>
        Prozori i ni≈°e ulaze u hidro traku i silikon.<br>
        Geberit i vertikale slu≈æe za lajsne i gerung.
      </p>

      <div class="openings-header">
        <button id="btnAddDoor"     class="btn-small">‚ûï Vrata</button>
        <button id="btnAddWindow"   class="btn-small">‚ûï Prozor</button>
        <button id="btnAddNiche"    class="btn-small">‚ûï Ni≈°a</button>
        <button id="btnAddGeberit"  class="btn-small">‚ûï Geberit</button>
        <button id="btnAddVert"     class="btn-small">‚ûï Vertikala</button>
        <button id="btnAddCustom"   class="btn-small">‚ûï Custom otvor</button>
      </div>

      <div id="openingsList"></div>
    </div>


    <!-- REZULTATI -->
    <div class="card" id="calcResult" style="display:none;">
      <h3>üìä Rezultati obraƒçuna</h3>
      <div id="calcOutput"></div>
    </div>

  </div>

</section>
<!-- KRAJ autoCalcView -->


<!-- ----------------------------------------------------- -->
<!-- ARHIVA ‚Äì Cloud view                                   -->
<!-- ----------------------------------------------------- -->

<section id="archiveView" class="view" style="display:none;">
  <div class="card">
    <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
    <h2>üìÇ Arhiva obraƒçuna (Cloud)</h2>
    <p style="font-size:12px;opacity:0.8;">
      Popis svih spremljenih obraƒçuna. Svi prijavljeni korisnici vide sve zapise.
    </p>
  </div>

  <div class="card">
    <div id="archiveList"></div>
  </div>
</section>

</main>

<script>
  /* ==========================================================
   GLOBALNE VARIJABLE & HELPERI
   ========================================================== */

let openings = [];
let silLines = [];
let DM_ROWS = [];

let state = {
  lastCalc: null,
  prices: {}
};

function num(id) {
  const v = parseFloat(String(document.getElementById(id).value).replace(",", "."));
  return isNaN(v) ? 0 : v;
}
function bool(id) {
  return document.getElementById(id).checked;
}
function formatHr(v, dec = 2) {
  if (typeof v !== "number") return v;
  return v.toFixed(dec).replace(".", ",");
}

/* ==========================================================
   OTVORI ‚Äì RENDER + HELPERI
   ========================================================== */

function openingArea(o) {
  return (o.w * o.h) * (o.count || 1);
}
function openingPerim(o) {
  return ((o.w * 2) + (o.h * 2)) * (o.count || 1);
}

function renderOpenings() {
  const cont = document.getElementById("openingsList");
  if (!cont) return;
  cont.innerHTML = "";

  if (!openings.length) {
    cont.innerHTML = `<i style="opacity:0.7;font-size:12px;">Nema dodanih otvora.</i>`;
    return;
  }

  openings.forEach((o, i) => {
    const div = document.createElement("div");
    div.className = "open-item";
    div.innerHTML = `
      <b>${o.label}</b><br>
      ≈†irina: ${formatHr(o.w)} m<br>
      Visina: ${formatHr(o.h)} m<br>
      Kom: ${o.count}<br>
      Oduzeti od zidova: ${o.subtract ? "DA" : "NE"}<br>
      <button class="btn-small secondary" onclick="removeOpening(${i})">üóë Ukloni</button>
    `;
    cont.appendChild(div);
  });
}

function addOpening(type, label, subtract) {
  const w = prompt("≈†irina (m):", "0.90");
  const h = prompt("Visina (m):", "2.00");
  const c = prompt("Broj komada:", "1");

  const W = parseFloat(w.replace(",", ".")) || 0;
  const H = parseFloat(h.replace(",", ".")) || 0;
  const C = parseInt(c) || 1;

  openings.push({
    type,
    label,
    w: W,
    h: H,
    count: C,
    subtract
  });
  renderOpenings();
}

function removeOpening(idx) {
  openings.splice(idx, 1);
  renderOpenings();
}

/* ==========================================================
   EVENTI ZA OTVORE
   ========================================================== */

document.getElementById("btnAddDoor").onclick    = () => addOpening("door", "Vrata", true);
document.getElementById("btnAddWindow").onclick  = () => addOpening("window", "Prozor", false);
document.getElementById("btnAddNiche").onclick   = () => addOpening("niche", "Ni≈°a", false);
document.getElementById("btnAddGeberit").onclick = () => addOpening("geberit", "Geberit", false);
document.getElementById("btnAddVert").onclick    = () => addOpening("vert", "Vertikala", false);
document.getElementById("btnAddCustom").onclick  = () => addOpening("custom", "Custom otvor", false);

/* ==========================================================
   DODATNE MJERE (DM)
   ========================================================== */

function renderDM() {
  const cont = document.getElementById("dmContainer");
  cont.innerHTML = "";

  if (!DM_ROWS.length) {
    cont.innerHTML = `<i style="opacity:0.7;font-size:12px;">Nema dodatnih mjera.</i>`;
    return;
  }

  DM_ROWS.forEach((dm, idx) => {
    const row = document.createElement("div");
    row.className = "dm-row";
    row.innerHTML = `
      <input type="text"     value="${dm.name}" onchange="dmChange(${idx}, 'name', this.value)">
      <input type="number"   step="0.01" value="${dm.val}" onchange="dmChange(${idx}, 'val', this.value)">
      <select onchange="dmChange(${idx}, 'sign', this.value)">
        <option value="+">+</option>
        <option value="-">-</option>
      </select>
      <button class="btn-small secondary" onclick="removeDM(${idx})">üóë</button>
    `;
    row.querySelector("select").value = dm.sign;
    cont.appendChild(row);
  });
}

function addDM() {
  DM_ROWS.push({ name: "Mjera", val: 0, sign: "+" });
  renderDM();
}

function dmChange(idx, key, value) {
  if (key === "val") {
    DM_ROWS[idx][key] = parseFloat(value.replace(",", ".")) || 0;
  } else {
    DM_ROWS[idx][key] = value;
  }
}

function removeDM(idx) {
  DM_ROWS.splice(idx, 1);
  renderDM();
}

document.getElementById("btnAddDmRow").onclick = addDM;

/* Izraƒçun ukupnih DM */
function calcDM() {
  let rows = [];
  let total = 0;

  DM_ROWS.forEach(dm => {
    const v = dm.sign === "+" ? dm.val : -dm.val;
    rows.push({
      name: dm.name,
      val: dm.val,
      sign: dm.sign,
      signedVal: v
    });
    total += v;
  });

  return { rows, total };
}

/* ==========================================================
   RESET FUNKCIJE
   ========================================================== */

function resetOpenings() {
  openings = [];
  renderOpenings();
}

function resetDM() {
  DM_ROWS = [];
  renderDM();
                   }
  /* ==========================================================
   GLAVNI IZRAƒåUN ‚Äì runAutoCalc()
   ========================================================== */

function runAutoCalc(showResult = true) {

  /* -------- META -------- */
  const meta = {
    siteName:     document.getElementById("siteName").value.trim(),
    roomName:     document.getElementById("roomName").value.trim(),
    situationNo:  document.getElementById("situationNo").value.trim(),
    investorName: document.getElementById("investorName").value.trim()
  };

  /* -------- DIMENZIJE -------- */
  const D = num("dimD");
  const S = num("dimS");
  const V = num("dimV");

  /* -------- TU≈† ZONA -------- */
  const tusS = num("tusS");
  const tusD = num("tusD");
  const tusV = num("tusV");

  /* -------- DM -------- */
  const dm = calcDM();

  /* ==========================================================
     POD
     ========================================================== */
  let pod = D * S;

  /* ==========================================================
     ZIDOVI ‚Äì BRUTO
     ========================================================== */
  let zidovi = 2 * (D * V + S * V);

  /* ==========================================================
     ODUZIMANJE OTVORA
     ========================================================== */
  let subtractArea = 0;
  let subtractPerim = 0;

  openings.forEach(o => {
    if (o.subtract) {
      subtractArea += openingArea(o);
    }
  });

  let zidoviNeto = zidovi - subtractArea;
  if (zidoviNeto < 0) zidoviNeto = 0;

  /* ==========================================================
     HIDRO POD + TU≈† + TRAKA
     ========================================================== */
  let hidroPod    = bool("chkHidroPod")  ? pod : 0;
  let hidroTus    = bool("chkHidroTus")  ? (tusS * tusD) : 0;
  let hidroTraka  = bool("chkHidroTraka")? (2*(D+S)) : 0;

  /* ==========================================================
     SILIKON
     ========================================================== */
  let silikon = 0;
  if (bool("chkSilikon")) {
    silikon += 2*(D+S);
  }

  // dodatne silikonske linije (ako koristi≈° silLines)
  silLines.forEach(s => {
    silikon += s.l || 0;
  });

  /* ==========================================================
     SOKL
     ========================================================== */
  let sokl = 0;
  if (bool("chkSokl")) {
    sokl = (2*(D+S)) - num("soklMinus") + num("soklPlus");
    if (sokl < 0) sokl = 0;
  }

  /* ==========================================================
     STEPENICE
     ========================================================== */
  let stepenice = null;
  if (bool("chkStepenice")) {

    const type  = document.getElementById("stepType").value;
    const w     = num("stepWidth");
    const count = num("stepCount");

    if (type === "duzni") {
      stepenice = {
        mode: "duzni",
        vrijednost: w * count
      };
    } else {
      stepenice = {
        mode: "komad",
        sc: count
      };
    }
  }

  /* ==========================================================
     LAJSNE & GERUNG (osnovna verzija)
     ========================================================== */
  let lajsne = 0;
  let gerung = 0;

  // osnovna logika ‚Äì kasnije se mo≈æe pro≈°iriti po potrebi
  if (lajsne !== null) {
    lajsne = 2*(D+S);
  }
  if (gerung !== null) {
    gerung = 2*(D+S);
  }

  /* ==========================================================
     PREPUNA STRUKTURA ZA POVRATAK
     ========================================================== */

  const results = {
    pod,
    zidovi,
    zidoviNeto,
    subtractArea,
    hidroPod,
    hidroTus,
    hidroTraka,
    silikon,
    sokl,
    stepenice,
    lajsne,
    gerung,
    dm   : dm,
    openings: JSON.parse(JSON.stringify(openings))
  };

  const data = {
    meta,
    results,
    openings: JSON.parse(JSON.stringify(openings)),
    prices: state.prices
  };

  state.lastCalc = data;

  if (showResult) showCalcOutput(data);

  return data;
}

/* ==========================================================
   PRIKAZ IZRAƒåUNA ‚Äì UI (calcResult)
   ========================================================== */

function showCalcOutput(data) {
  const div = document.getElementById("calcOutput");
  const box = document.getElementById("calcResult");
  box.style.display = "block";

  const r = data.results;

  let h = "";
  h += `<b>Pod:</b> ${formatHr(r.pod)} m¬≤<br>`;
  h += `<b>Zidovi neto:</b> ${formatHr(r.zidoviNeto)} m¬≤<br>`;
  h += `<b>Hidro pod:</b> ${formatHr(r.hidroPod)} m¬≤<br>`;
  h += `<b>Hidro tu≈°:</b> ${formatHr(r.hidroTus)} m¬≤<br>`;
  h += `<b>Hidro traka:</b> ${formatHr(r.hidroTraka)} m<br>`;
  h += `<b>Silikon:</b> ${formatHr(r.silikon)} m<br>`;
  h += `<b>Sokl:</b> ${formatHr(r.sokl)} m<br>`;

  if (r.stepenice) {
    if (r.stepenice.mode === "duzni")
      h += `<b>Stepenice:</b> ${formatHr(r.stepenice.vrijednost)} m du≈æno<br>`;
    else
      h += `<b>Stepenice:</b> ${r.stepenice.sc} kom<br>`;
  }

  h += `<b>Lajsne:</b> ${formatHr(r.lajsne)} m<br>`;
  h += `<b>Gerung:</b> ${formatHr(r.gerung)} m<br>`;
  h += `<b>Dodatne mjere ukupno:</b> ${formatHr(r.dm.total)}<br>`;

  div.innerHTML = h;
}
  /* ==========================================================
   PDF ZA JEDNU PROSTORIJU ‚Äì DETALJNI OBRAƒåUN
   ========================================================== */

function buildPdfSingle(data) {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) {
    alert("PDF modul nije uƒçitan.");
    return null;
  }

  const doc = new jsPDF();
  let y = 15;

  function newPage() {
    doc.addPage();
    y = 15;
  }

  function w(txt, extra = 0) {
    const lines = doc.splitTextToSize(txt, 180);
    lines.forEach(t => {
      if (y > 280) newPage();
      doc.text(t, 10, y);
      y += 5;
    });
    y += extra;
  }

  const r = data.results;
  const m = data.meta;
  const openings = data.openings || [];

  const today = new Date();
  const dStr = `${String(today.getDate()).padStart(2,"0")}.${String(today.getMonth()+1).padStart(2,"0")}.${today.getFullYear()}.`;

  /* ----------------------------------------------------------
     HEADER
  ---------------------------------------------------------- */
  doc.setFontSize(14);
  w(`KOB-Keramika ‚Äì Graƒëevinska knjiga / Prostorija`, 4);

  doc.setFontSize(11);
  w(`Gradili≈°te: ${m.siteName || "-"}`);
  w(`Prostorija: ${m.roomName || "-"}`);
  w(`Situacija: ${m.situationNo || "-"}`);
  w(`Investitor: ${m.investorName || "-"}`);
  w(`Datum: ${dStr}`, 4);


  /* ==========================================================
     1. POD
     ========================================================== */
  doc.setFontSize(12);
  w("1. Pod", 2);

  doc.setFontSize(11);
  w(`Povr≈°ina poda: ${formatHr(r.pod)} m¬≤`, 4);


  /* ==========================================================
     2. ZIDOVI ‚Äì NETO
     ========================================================== */
  doc.setFontSize(12);
  w("2. Zidovi", 2);

  doc.setFontSize(11);
  w(`Zidovi neto: ${formatHr(r.zidoviNeto)} m¬≤`);
  w(`Oduzeto otvora: ${formatHr(r.subtractArea)} m¬≤`, 4);


  /* ==========================================================
     3. HIDRO POD
     ========================================================== */
  doc.setFontSize(12);
  w("3. Hidroizolacija poda", 2);
  doc.setFontSize(11);
  w(`Hidro pod: ${formatHr(r.hidroPod)} m¬≤`, 4);


  /* ==========================================================
     4. HIDRO TU≈† ZONA
     ========================================================== */
  doc.setFontSize(12);
  w("4. Hidro tu≈° zona", 2);
  doc.setFontSize(11);
  w(`Povr≈°ina tu≈° zone: ${formatHr(r.hidroTus)} m¬≤`, 4);


  /* ==========================================================
     5. HIDRO TRAKA
     ========================================================== */
  doc.setFontSize(12);
  w("5. Hidro traka", 2);
  doc.setFontSize(11);
  w(`Du≈æina trake: ${formatHr(r.hidroTraka)} m`, 4);


  /* ==========================================================
     6. SILIKON
     ========================================================== */
  doc.setFontSize(12);
  w("6. Silikon", 2);
  doc.setFontSize(11);
  w(`Ukupno silikona: ${formatHr(r.silikon)} m`, 4);


  /* ==========================================================
     7. SOKL
     ========================================================== */
  doc.setFontSize(12);
  w("7. Sokl", 2);
  doc.setFontSize(11);
  w(`Ukupna du≈æina sokla: ${formatHr(r.sokl)} m`, 4);


  /* ==========================================================
     8. STEPENICE
     ========================================================== */
  if (r.stepenice) {
    doc.setFontSize(12);
    w("8. Stepenice", 2);

    doc.setFontSize(11);
    if (r.stepenice.mode === "duzni") {
      w(`Stepenice: ${formatHr(r.stepenice.vrijednost)} m du≈æno`, 4);
    } else {
      w(`Stepenice: ${r.stepenice.sc} kom`, 4);
    }
  }


  /* ==========================================================
     9. LAJSNE
     ========================================================== */
  doc.setFontSize(12);
  w("9. Lajsne", 2);

  doc.setFontSize(11);
  w(`Ukupno lajsni: ${formatHr(r.lajsne)} m`, 4);


  /* ==========================================================
     10. GERUNG
     ========================================================== */
  doc.setFontSize(12);
  w("10. Gerung", 2);

  doc.setFontSize(11);
  w(`Ukupno gerunga: ${formatHr(r.gerung)} m`, 4);


  /* ==========================================================
     11. DODATNE MJERE
     ========================================================== */
  if (r.dm && r.dm.rows && r.dm.rows.length) {
    doc.setFontSize(12);
    w("11. Dodatne mjere", 2);
    doc.setFontSize(11);

    r.dm.rows.forEach((row, i) => {
      w(`${i+1}. ${row.name}: ${row.sign}${formatHr(row.val)} ‚Üí ${formatHr(row.signedVal)}`);
    });

    w(`Ukupno DM: ${formatHr(r.dm.total)}`, 4);
  }


  /* ==========================================================
     12. OTVORI
     ========================================================== */
  if (openings.length) {
    doc.setFontSize(12);
    w("12. Otvori ‚Äì specifikacija", 2);

    doc.setFontSize(11);
    openings.forEach(o => {
      w(
        `- ${o.label}: ${formatHr(o.w)} √ó ${formatHr(o.h)} m √ó ${o.count} kom` +
        ` ‚Üí pov. ${formatHr(openingArea(o))} m¬≤, obod ${formatHr(openingPerim(o))} m` +
        `, oduzeti=${o.subtract ? "DA" : "NE"}`
      );
    });
    y += 4;
  }


  /* ==========================================================
     13. FINANCIJSKI OBRAƒåUN
     ========================================================== */

  const UNIT_PRICES = window.UNIT_PRICES || {}; // cjenik

  const pr = data.prices || {};
  const items = [];

  function addItem(label, key, qty, unit) {
    if (!qty || !UNIT_PRICES[key]) return;
    const price = UNIT_PRICES[key];
    const total = price * qty;
    items.push({ label, qty, unit, price, total });
  }

  addItem("Pod",           "pod",          r.pod,           "m2");
  addItem("Zidovi",        "zidovi",       r.zidoviNeto,    "m2");
  addItem("Hidro pod",     "hidroPod",     r.hidroPod,      "m2");
  addItem("Hidro tu≈°",     "hidroTus",     r.hidroTus,      "m2");
  addItem("Hidro traka",   "hidroTraka",   r.hidroTraka,    "m");
  addItem("Silikon",       "silikon",      r.silikon,       "m");
  addItem("Sokl",          "sokl",         r.sokl,          "m");
  addItem("Lajsne",        "lajsne",       r.lajsne,        "m");
  addItem("Gerung",        "gerung",       r.gerung,        "m");

  if (r.stepenice) {
    if (r.stepenice.mode === "duzni")
      addItem("Stepenice (m)", "stepeniceM", r.stepenice.vrijednost, "m");
    else
      addItem("Stepenice (kom)", "stepeniceKom", r.stepenice.sc, "kom");
  }

  if (items.length) {
    doc.setFontSize(12);
    w("13. Financijski obraƒçun", 2);

    doc.setFontSize(11);

    if (y > 260) newPage();
    doc.text("Stavka", 10, y);
    doc.text("Koliƒçina", 70, y);
    doc.text("Jed.", 100, y);
    doc.text("Cijena", 130, y);
    doc.text("Ukupno", 160, y);
    y += 6;

    let ukupno = 0;

    items.forEach(it => {
      if (y > 280) newPage();
      ukupno += it.total;

      doc.text(it.label, 10,  y);
      doc.text(formatHr(it.qty), 70, y);
      doc.text(it.unit, 100, y);
      doc.text(formatHr(it.price,2), 130, y);
      doc.text(formatHr(it.total,2), 160, y);

      y += 6;
    });

    w(`UKUPNO: ${formatHr(ukupno,2)} EUR`, 4);
  }


  /* ----------------------------------------------------------
     FOOTER
  ---------------------------------------------------------- */

  if (y > 270) newPage();
  doc.setFontSize(11);
  w("Napomena: izraƒçun je informativan ‚Äî konaƒçna faktura mo≈æe sadr≈æavati dodatne stavke (priprema podloge, materijal, prijevoz itd.).");

  return doc;
    }
 /* ==========================================================
   MULTI-ROOM SPREMNIK (vi≈°e prostorija u jednom gradili≈°tu)
   ========================================================== */

let ROOMS = [];

/* Dodaje trenutno izraƒçunatu prostoriju u projekt */
function addRoomFromCurrent() {
  const data = runAutoCalc(false);
  if (!data) {
    alert("Nije moguƒáe dodati prostoriju ‚Äî prvo izraƒçunajte podatke.");
    return;
  }

  // kopije radi sigurnosti
  data.openings = JSON.parse(JSON.stringify(openings));
  data.prices   = state.prices || {};

  ROOMS.push(data);
  renderRoomsList();

  alert("Prostorija dodana u gradili≈°te.");
}

/* Brisanje prostorije */
function removeRoom(i) {
  ROOMS.splice(i, 1);
  renderRoomsList();
}

/* Prikaz liste prostorija */
function renderRoomsList() {
  const el = document.getElementById("roomsList");
  if (!el) return;

  if (!ROOMS.length) {
    el.innerHTML = `<i style="opacity:0.7;font-size:12px;">Nema dodanih prostorija.</i>`;
    return;
  }

  let html = "";
  ROOMS.forEach((r, i) => {
    html += `
      <div style="border-bottom:1px solid #444;padding:6px;margin-bottom:6px;">
        <b>${i+1}. ${r.meta.roomName || "Prostorija"}</b><br>
        <span style="font-size:12px;opacity:0.7;">
          Pod: ${formatHr(r.results.pod)} m¬≤
        </span><br>
        <button class="btn-small secondary" onclick="removeRoom(${i})">üóë Ukloni</button>
      </div>
    `;
  });

  el.innerHTML = html;
}

/* ==========================================================
   PDF ZA VI≈†E PROSTORIJA ‚Äì GRAƒêEVINSKA KNJIGA
   ========================================================== */

function buildMultiRoomPdf(rooms) {
  const { jsPDF } = window.jspdf || {};
  if (!jsPDF) {
    alert("PDF modul nije uƒçitan.");
    return null;
  }
  if (!rooms.length) {
    alert("Nema dodanih prostorija.");
    return null;
  }

  const doc = new jsPDF();
  let y = 15;

  function newPage() {
    doc.addPage();
    y = 15;
  }

  function w(txt, extra = 0) {
    const lines = doc.splitTextToSize(txt, 180);
    lines.forEach(t => {
      if (y > 280) newPage();
      doc.text(t, 10, y);
      y += 5;
    });
    y += extra;
  }

  /* --------------------- HEADER -------------------- */

  const first = rooms[0].meta || {};
  const today = new Date();
  const dStr = `${String(today.getDate()).padStart(2,"0")}.${String(today.getMonth()+1).padStart(2,"0")}.${today.getFullYear()}.`;

  doc.setFontSize(14);
  w("KOB-Keramika ‚Äì Graƒëevinska knjiga (vi≈°e prostorija)", 4);

  doc.setFontSize(11);
  w(`Gradili≈°te: ${first.siteName || "-"}`);
  w(`Investitor: ${first.investorName || "-"}`);
  w(`Datum: ${dStr}`, 4);


  /* ==========================================================
     IZLISTAJ SVE PROSTORIJE
     ========================================================== */

  const totalFin = {}; // financijski zbrojevi po stavkama

  function addFin(key, qty, unit) {
    if (!window.UNIT_PRICES || !window.UNIT_PRICES[key] || !qty) return;
    if (!totalFin[key]) {
      totalFin[key] = { qty: 0, unit, price: window.UNIT_PRICES[key], total: 0 };
    }
    totalFin[key].qty   += qty;
    totalFin[key].total += qty * totalFin[key].price;
  }

  rooms.forEach((room, i) => {
    const r = room.results;
    const m = room.meta;
    const openings = room.openings || [];
    const p = room.prices || {};

    if (y > 250) newPage();

    doc.setFontSize(12);
    w(`${i+1}. Prostorija: ${m.roomName || "-"}`, 2);

    doc.setFontSize(11);
    w(`Pod: ${formatHr(r.pod)} m¬≤`);
    addFin("pod", r.pod, "m2");

    w(`Zidovi neto: ${formatHr(r.zidoviNeto)} m¬≤`);
    addFin("zidovi", r.zidoviNeto, "m2");

    w(`Hidro pod: ${formatHr(r.hidroPod)} m¬≤`);
    addFin("hidroPod", r.hidroPod, "m2");

    w(`Hidro tu≈°: ${formatHr(r.hidroTus)} m¬≤`);
    addFin("hidroTus", r.hidroTus, "m2");

    w(`Hidro traka: ${formatHr(r.hidroTraka)} m`);
    addFin("hidroTraka", r.hidroTraka, "m");

    w(`Silikon: ${formatHr(r.silikon)} m`);
    addFin("silikon", r.silikon, "m");

    w(`Sokl: ${formatHr(r.sokl)} m`);
    addFin("sokl", r.sokl, "m");

    if (r.stepenice) {
      if (r.stepenice.mode === "duzni") {
        w(`Stepenice: ${formatHr(r.stepenice.vrijednost)} m`);
        addFin("stepeniceM", r.stepenice.vrijednost, "m");
      } else {
        w(`Stepenice: ${r.stepenice.sc} kom`);
        addFin("stepeniceKom", r.stepenice.sc, "kom");
      }
    }

    w(`Lajsne: ${formatHr(r.lajsne)} m`);
    addFin("lajsne", r.lajsne, "m");

    w(`Gerung: ${formatHr(r.gerung)} m`);
    addFin("gerung", r.gerung, "m");

    if (r.dm && typeof r.dm.total === "number") {
      w(`Dodatne mjere: ${formatHr(r.dm.total)}`, 2);
      // DM se ne zbraja financijski automatski ‚Äî mo≈æe se naknadno dodati po potrebi.
    }

    y += 4;
  });


  /* ==========================================================
     FINANCIJSKI SA≈ΩETAK ZA GRADILI≈†TE
     ========================================================== */

  if (Object.keys(totalFin).length) {
    if (y > 240) newPage();

    doc.setFontSize(12);
    w("Financijski sa≈æetak za sve prostorije", 2);

    doc.setFontSize(11);

    doc.text("Stavka",   10, y);
    doc.text("Koliƒçina", 70, y);
    doc.text("Jed.",     100, y);
    doc.text("Cijena",   130, y);
    doc.text("Ukupno",   165, y);
    y += 6;

    let SUM = 0;

    Object.keys(totalFin).forEach(key => {
      const t = totalFin[key];
      if (!t) return;

      if (y > 280) newPage();

      doc.text(key,                10, y);
      doc.text(formatHr(t.qty),    70, y);
      doc.text(t.unit,             100, y);
      doc.text(formatHr(t.price),  130, y);
      doc.text(formatHr(t.total),  165, y);

      SUM += t.total;
      y += 6;
    });

    w(`UKUPNO ZA GRADILI≈†TE: ${formatHr(SUM,2)} EUR`, 4);
  }


  /* ----------------------------------------------------------
     FOOTER
  ---------------------------------------------------------- */
  if (y > 270) newPage();

  doc.setFontSize(11);
  w("Napomena: izraƒçun je informativan ‚Äî zavr≈°na faktura mo≈æe sadr≈æavati dodatne stavke.");

  return doc;
}

/* ==========================================================
   EVENT LISTENERI ‚Äì MULTI ROOM
   ========================================================== */

document.getElementById("btnAddRoom").onclick = () => addRoomFromCurrent();

document.getElementById("btnExportPdfMulti").onclick = () => {
  if (!ROOMS.length) {
    alert("Nema dodanih prostorija.");
    return;
  }
  const doc = buildMultiRoomPdf(ROOMS);
  if (!doc) return;

  const first = ROOMS[0].meta || {};
  const site  = (first.siteName || "gradiliste").replace(/\s+/g, "_");

  const today = new Date();
  const yStr  = today.getFullYear();
  const mStr  = String(today.getMonth()+1).padStart(2,"0");
  const dStr  = String(today.getDate()).padStart(2,"0");

  doc.save(`GK_${site}_${yStr}-${mStr}-${dStr}.pdf`);
};
  /* ==========================================================
   CJENIK ‚Äì OSNOVNE JEDINIƒåNE CIJENE
   ========================================================== */

window.UNIT_PRICES = {
  pod:            12.00,   // ‚Ç¨/m2
  zidovi:         12.00,   // ‚Ç¨/m2
  hidroPod:       8.00,    // ‚Ç¨/m2
  hidroTus:       8.00,    // ‚Ç¨/m2
  hidroTraka:     4.00,    // ‚Ç¨/m
  silikon:        3.00,    // ‚Ç¨/m
  sokl:           4.00,    // ‚Ç¨/m
  stepeniceM:     20.00,   // ‚Ç¨/m
  stepeniceKom:   12.00,   // ‚Ç¨/kom
  lajsne:         6.00,    // ‚Ç¨/m
  gerung:         5.00     // ‚Ç¨/m
};

/* ==========================================================
   SPREMANJE CIJENA ‚Äì ako ≈æeli≈° omoguƒáiti promjene
   ========================================================== */

function setUnitPrice(key, value) {
  const v = parseFloat(String(value).replace(",", ".")) || 0;
  window.UNIT_PRICES[key] = v;
}

/* ==========================================================
   ZAPAMTI CIJENE U STANJE PROSTORIJE
   ========================================================== */

function storePricesForCurrent() {
  state.prices = {
    pod:          { qty: state?.lastCalc?.results?.pod,          unit:"m2" },
    zidovi:       { qty: state?.lastCalc?.results?.zidoviNeto,   unit:"m2" },
    hidroPod:     { qty: state?.lastCalc?.results?.hidroPod,     unit:"m2" },
    hidroTus:     { qty: state?.lastCalc?.results?.hidroTus,     unit:"m2" },
    hidroTraka:   { qty: state?.lastCalc?.results?.hidroTraka,   unit:"m" },
    silikon:      { qty: state?.lastCalc?.results?.silikon,      unit:"m" },
    sokl:         { qty: state?.lastCalc?.results?.sokl,         unit:"m" },
    lajsne:       { qty: state?.lastCalc?.results?.lajsne,       unit:"m" },
    gerung:       { qty: state?.lastCalc?.results?.gerung,       unit:"m" }
  };

  const st = state?.lastCalc?.results;
  if (st?.stepenice) {
    if (st.stepenice.mode === "duzni") {
      state.prices.stepeniceM = { qty: st.stepenice.vrijednost, unit:"m" };
    } else {
      state.prices.stepeniceKom = { qty: st.stepenice.sc, unit:"kom" };
    }
  }
}
  /* ==========================================================
   CLOUD ‚Äì FIRESTORE + STORAGE
   (pretpostavlja da su db i storage definirani u DIO 10)
   ========================================================== */

/* Spremi trenutni obraƒçun + PDF u Cloud */
async function saveToCloud() {
  try {
    const data = runAutoCalc(true);
    if (!data) {
      alert("Nema podataka za spremanje.");
      return;
    }

    // Spremi i cijene
    storePricesForCurrent();

    const doc = buildPdfSingle({
      meta: data.meta,
      results: data.results,
      openings: data.openings,
      prices: state.prices
    });
    if (!doc) {
      alert("Ne mogu generirati PDF.");
      return;
    }

    const pdfBlob = doc.output("blob");

    const now = new Date();
    const id  = `obracun_${now.getTime()}`;
    const pdfPath = `pdf/${id}.pdf`;

    // 1) Upload PDF u Storage
    await storage.ref().child(pdfPath).put(pdfBlob);

    // 2) Zapi≈°i metapodatke u Firestore
    await db.collection("obracuni").doc(id).set({
      meta: data.meta,
      results: data.results,
      openings: data.openings,
      prices: state.prices,
      pdfPath,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("Obraƒçun i PDF spremljeni u Cloud.");
    loadArchive();
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri spremanju u Cloud: " + e.message);
  }
}

/* Uƒçitaj arhivu svih obraƒçuna */
async function loadArchive() {
  const listEl = document.getElementById("archiveList");
  if (!listEl) return;
  listEl.innerHTML = "<i>Uƒçitavanje...</i>";

  try {
    const snap = await db.collection("obracuni")
      .orderBy("createdAt", "desc")
      .limit(50)
      .get();

    if (snap.empty) {
      listEl.innerHTML = "<i>Nema spremljenih obraƒçuna.</i>";
      return;
    }

    let html = "";
    snap.forEach(docSnap => {
      const d = docSnap.data();
      const id = docSnap.id;
      const m = d.meta || {};
      const created = d.createdAt ? d.createdAt.toDate() : null;
      const dateStr = created
        ? `${String(created.getDate()).padStart(2,"0")}.${String(created.getMonth()+1).padStart(2,"0")}.${created.getFullYear()}. ${String(created.getHours()).padStart(2,"0")}:${String(created.getMinutes()).padStart(2,"0")}`
        : "-";

      html += `
        <div class="archive-list-item">
          <div><b>${m.siteName || "Gradili≈°te"}</b> ‚Äì ${m.roomName || "Prostorija"}</div>
          <div style="font-size:11px;opacity:0.8;">
            Situacija: ${m.situationNo || "-"} ¬∑ Investitor: ${m.investorName || "-"} ¬∑ Datum: ${dateStr}
          </div>
          <div class="archive-actions">
            <button class="btn-small" onclick="reloadFromCloud('${id}')">üîÑ Uƒçitaj</button>
            <button class="btn-small secondary" onclick="deleteCloudRecord('${id}')">üóë Obri≈°i</button>
          </div>
          <div style="font-size:11px;opacity:0.7;">
            ID: ${id}
          </div>
        </div>
      `;
    });

    listEl.innerHTML = html;
  } catch (e) {
    console.error(e);
    listEl.innerHTML = "<span style='color:#f66;'>Gre≈°ka pri uƒçitavanju arhive.</span>";
  }
}

/* Uƒçitaj jedan obraƒçun iz Cloud-a u formu */
async function reloadFromCloud(id) {
  try {
    const docSnap = await db.collection("obracuni").doc(id).get();
    if (!docSnap.exists) {
      alert("Dokument ne postoji.");
      return;
    }
    const d = docSnap.data();
    const m = d.meta || {};

    document.getElementById("siteName").value     = m.siteName     || "";
    document.getElementById("roomName").value     = m.roomName     || "";
    document.getElementById("situationNo").value  = m.situationNo  || "";
    document.getElementById("investorName").value = m.investorName || "";

    document.getElementById("dimD").value = String(d.results?.D || "").replace(".", ",");
    document.getElementById("dimS").value = String(d.results?.S || "").replace(".", ",");
    document.getElementById("dimV").value = String(d.results?.V || "").replace(".", ",");

    openings = d.openings || [];
    renderOpenings();

    state.lastCalc = {
      meta: m,
      results: d.results || {},
      openings: openings,
      prices: d.prices || {}
    };
    state.prices = d.prices || {};

    showView("autoCalcView");
    runAutoCalc(true);

    alert("Obraƒçun uƒçitan iz Clouda.");
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri uƒçitavanju iz Clouda: " + e.message);
  }
}

/* Brisanje jednog obraƒçuna iz Cloud-a */
async function deleteCloudRecord(id) {
  if (!confirm("Stvarno obrisati ovaj obraƒçun i njegov PDF?")) return;
  try {
    const docRef = db.collection("obracuni").doc(id);
    const docSnap = await docRef.get();
    if (docSnap.exists) {
      const d = docSnap.data();
      if (d.pdfPath) {
        try {
          await storage.ref().child(d.pdfPath).delete();
        } catch (e) {
          console.warn("Ne mogu obrisati PDF iz Storage-a:", e.message);
        }
      }
    }
    await docRef.delete();
    alert("Obraƒçun obrisan.");
    loadArchive();
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri brisanju: " + e.message);
  }
}

/* EVENT ‚Äì Spremi u Cloud gumb */
document.getElementById("btnSaveCloud").onclick = () => {
  saveToCloud();
};
  /* ==========================================================
   PRIKAZ POJEDINIH VIEW-ova
   ========================================================== */

function showView(id) {
  document.querySelectorAll(".view").forEach(v => v.style.display = "none");
  const el = document.getElementById(id);
  if (el) el.style.display = "block";

  if (id === "archiveView") {
    loadArchive();
  }
}

/* ==========================================================
   FIREBASE INIT + AUTH
   ========================================================== */

/* Firebase SDK loader */
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
/* ==========================================================
   FIREBASE KONFIG ‚Äî UNESI SVOJE PODATKE
   ========================================================== */

const firebaseConfig = {
  apiKey: "OVDJE_UPISATI",
  authDomain: "OVDJE_UPISATI",
  projectId: "OVDJE_UPISATI",
  storageBucket: "OVDJE_UPISATI",
  messagingSenderId: "OVDJE_UPISATI",
  appId: "OVDJE_UPISATI"
};

firebase.initializeApp(firebaseConfig);

const db = firebase.firestore();
const storage = firebase.storage();
const auth = firebase.auth();

/* ==========================================================
   AUTH STATUS ‚Äì PRIKAZ
   ========================================================== */

auth.onAuthStateChanged(user => {
  const ui = document.getElementById("userInfo");

  if (user) {
    ui.textContent = `Prijavljen: ${user.email}`;
  } else {
    ui.textContent = "Nije prijavljen";
  }
});

/* ==========================================================
   LOGIN / LOGOUT
   ========================================================== */

async function login() {
  const email = prompt("Email:");
  const pass  = prompt("Lozinka:");

  try {
    await auth.signInWithEmailAndPassword(email, pass);
    alert("Prijavljeni ste.");
  } catch (e) {
    alert("Neuspje≈°an login: " + e.message);
  }
}

function logout() {
  auth.signOut();
  alert("Odjavljeni ste.");
}

/* Dodaj login gumb (ako ≈æeli≈°) ‚Äì nije obavezno
document.getElementById("btnLogin").onclick = login;
*/

/* ==========================================================
   ZATVARANJE SCRIPT TAGA I HTML-a
   ========================================================== */
</script>

</body>
</html>
