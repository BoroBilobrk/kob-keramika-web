<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>KOB-Keramika</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Tesseract.js za OCR iz slike -->
  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <!-- jsPDF za PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Firebase (OPCIJSKI za cloud backup ‚Äì po defaultu iskljuƒçeno) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --bg: #050505;
      --card: #121212;
      --border: #333;
      --accent: #ffffff;
      --accent-soft: #888;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #202020 0, #000 55%);
      color: #fff;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: linear-gradient(90deg, rgba(0,0,0,0.95), rgba(0,0,0,0.9));
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header .left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    header img.logo {
      height: 42px;
      width: auto;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      cursor: pointer;
    }
    header .title-block {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    header .app-name { font-weight: 700; font-size: 18px; letter-spacing: 0.06em; }
    header .subtitle { font-size: 11px; color: #ccc; }
    header .tag {
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 4px 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #ddd;
    }

    main { padding: 12px; max-width: 900px; margin: 0 auto 32px; }
    .card {
      border-radius: 16px;
      padding: 14px 12px;
      margin-bottom: 12px;
      background: radial-gradient(circle at top left, #1c1c1c, #101010);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 14px 35px rgba(0,0,0,0.6);
      animation: fadeIn 0.4s ease-out;
    }
    @keyframes fadeIn {
      from { opacity:0; transform: translateY(6px); }
      to { opacity:1; transform: translateY(0); }
    }
    h3 { margin-top: 0; font-size: 16px; display:flex; align-items:center; gap:6px;}
    h3 span.emoji { font-size:18px; }

    label {
      font-size: 13px;
      display: block;
      margin-top: 8px;
      color: #ddd;
    }
    input, textarea, select, button {
      width: 100%;
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.8);
      color: #fff;
      font-size: 14px;
    }
    input:focus, textarea:focus, select:focus {
      outline: 1px solid var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(255,255,255,0.15);
    }
    button {
      background: var(--accent);
      color: #000;
      font-weight: 600;
      cursor: pointer;
      border-radius: 999px;
      border: none;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.7);
    }
    button.secondary {
      background: #181818;
      color: #fff;
      border: 1px solid var(--border);
    }
    button.ghost {
      background: transparent;
      color: #fff;
      border: 1px solid var(--border);
    }
    button:disabled { opacity: 0.35; cursor: default; box-shadow:none; transform:none; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }
    th, td {
      border-bottom: 1px solid #262626;
      padding: 6px 4px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #151515;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .totals { margin-top: 10px; font-size: 13px; }
    .image-preview { margin-top: 8px; text-align: center; }
    .image-preview img {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid #333;
    }
    .actions-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    .actions-row button { flex: 1; min-width: 120px; }
    footer {
      text-align: center;
      font-size: 11px;
      color: #777;
      padding: 8px;
      border-top: 1px solid #222;
    }
    .hint {
      font-size: 11px;
      color: #aaa;
      margin-top: 4px;
    }

    .view { display: none; }
    .view.active { display: block; }

    #splashView {
      text-align: center;
      padding-top: 32px;
    }
    #splashLogo {
      width: 160px;
      height: auto;
      margin-bottom: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 18px 40px rgba(0,0,0,0.85);
    }
    #splashButtons button { margin-top: 8px; }

    .pill-nav {
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .pill-nav button {
      flex:1;
      font-size:12px;
      padding:6px 8px;
    }
    .pill-nav button.active {
      background:#fff;
      color:#000;
    }

    .badge {
      display:inline-block;
      border-radius:999px;
      padding:2px 8px;
      font-size:10px;
      border:1px solid #444;
      color:#ccc;
      margin-left:4px;
    }

    .measure-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(135px, 1fr));
      gap:8px 10px;
      margin-top:8px;
    }

    .measure-table-container {
      max-height: 260px;
      overflow:auto;
      margin-top:8px;
      border-radius:8px;
      border:1px solid #262626;
      background:#101010;
      padding:4px;
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <img src="logo.png" alt="KOB-Keramika logo" class="logo" id="headerLogo" />
      <div class="title-block">
        <span class="app-name">KOB-Keramika</span>
        <span class="subtitle">Tro≈°kovi i mjerenja po radniku i gradili≈°tu</span>
      </div>
    </div>
    <div class="tag">INTERNI ALAT</div>
  </header>

  <main>
    <!-- POƒåETNI EKRAN -->
    <section id="splashView" class="view active">
      <div class="card">
        <img src="logo.png" id="splashLogo" alt="KOB-Keramika logo" />
        <h3><span class="emoji">üëã</span> Dobrodo≈°li</h3>
        <p>Interna aplikacija za skeniranje raƒçuna, praƒáenje tro≈°kova po radniku i gradili≈°tu te mjerenje ploha (m¬≤ / du≈æni metri / re≈æija).</p>
        <div id="splashButtons">
          <button id="goEntry">‚ûï Unos tro≈°ka</button>
          <button id="goOverview" class="secondary">üìã Pregled tro≈°kova</button>
          <button id="goWorkers" class="secondary">üë∑ Po radniku</button>
        </div>
        <p class="hint">Savjet: u Chromeu odaberi ‚ÄúDodaj na poƒçetni zaslon‚Äù za do≈æivljaj kao aplikacija.</p>
      </div>
    </section>

    <!-- GLAVNI EKRAN (tro≈°kovi + mjerenja) -->
    <section id="entryView" class="view">
      <!-- TRO≈†KOVI -->
      <section class="card">
        <h3><span class="emoji">‚ûï</span> Unos tro≈°ka</h3>
        <label>Radnik
          <input type="text" id="workerInput" placeholder="Ime radnika" />
        </label>
        <label>Gradili≈°te
          <input type="text" id="siteInput" placeholder="Naziv gradili≈°ta / projekta" />
        </label>
        <label>Iznos (‚Ç¨)
          <input type="number" step="0.01" id="amountInput" placeholder="0.00" />
        </label>
        <div class="hint">Ako uƒçita≈° sliku raƒçuna, aplikacija ƒáe poku≈°ati automatski proƒçitati iznos (OCR).</div>
        <label>Opis tro≈°ka
          <textarea id="descInput" rows="2" placeholder="Opis"></textarea>
        </label>

        <label>Dokument (kamera ili galerija)
          <input type="file" id="imageInput" accept="image/*" capture="environment" />
        </label>

        <div class="image-preview" id="imagePreview" style="display:none;">
          <p>Zadnji uƒçitani dokument:</p>
          <img id="previewImg" src="" alt="Skenirani dokument" />
        </div>

        <button id="addExpenseBtn">Spremi tro≈°ak</button>
      </section>

      <section class="card">
        <h3><span class="emoji">üìÇ</span> Filtriranje tro≈°kova, PDF i Excel</h3>
        <label>Filter po radniku
          <select id="workerFilter">
            <option value="">Svi radnici</option>
          </select>
        </label>
        <label>Filter po gradili≈°tu
          <select id="siteFilter">
            <option value="">Sva gradili≈°ta</option>
          </select>
        </label>

        <div class="actions-row">
          <button id="exportCsvBtn">CSV (Excel ‚Äì tro≈°kovi)</button>
          <button id="exportPdfBtn" class="secondary">PDF (trenutni prikaz tro≈°kova)</button>
          <button class="ghost" id="printBtn">Print / PDF</button>
        </div>

        <div class="totals" id="selectedWorkerTotal"></div>
      </section>

      <section class="card">
        <h3><span class="emoji">üìã</span> Popis tro≈°kova</h3>
        <div class="pill-nav">
          <button id="btnShowAll" class="secondary active">Svi zapisi</button>
          <button id="btnShowWorker" class="secondary">Samo odabran radnik</button>
        </div>
        <div id="expensesContainer" style="margin-top:8px;"></div>
        <div class="totals" id="totalsContainer"></div>
      </section>

      <!-- MJERENJE PRO -->
      <section class="card">
        <h3><span class="emoji">üìè</span> Mjerenje PRO po gradili≈°tu i prostoriji</h3>
        <label>Gradili≈°te
          <input type="text" id="measureSiteInput" placeholder="npr. Stan Perkoviƒá" />
        </label>
        <label>Prostorija
          <input type="text" id="measureRoomInput" placeholder="npr. Kupaonica, Kuhinja, Hodnik..." />
        </label>

        <label>Vrsta mjere
          <select id="measureTypeSelect">
            <option value="zid_m2">Zid (m¬≤)</option>
            <option value="pod_m2">Pod (m¬≤)</option>
            <option value="sokl_m">Sokl (m)</option>
            <option value="hidro_m2">Hidroizolacija (m¬≤)</option>
            <option value="hidro_traka_m">Hidroizolacijska traka (m)</option>
            <option value="gerung_m">Gerung (m)</option>
            <option value="lajsne_m">Lajsne (m)</option>
            <option value="stepenice_m">Stepenice (m)</option>
          </select>
        </label>

        <div class="measure-grid">
          <div>
            <label>≈†irina (m)
              <input type="number" step="0.001" id="measureWidthInput" placeholder="npr. 1.25" />
            </label>
          </div>
          <div>
            <label>Visina (m)
              <input type="number" step="0.001" id="measureHeightInput" placeholder="npr. 2.40" />
            </label>
          </div>
          <div>
            <label>Du≈æina (m)
              <input type="number" step="0.001" id="measureLengthInput" placeholder="za du≈æne metre" />
            </label>
          </div>
          <div>
            <label>Direktan iznos (m / m¬≤)
              <input type="number" step="0.001" id="measureQtyInput" placeholder="ako veƒá zna≈° koliƒçinu" />
            </label>
          </div>
          <div style="grid-column:1/-1;">
            <label>Napomena (npr. zid iznad kade, pod kupaonice...)
              <input type="text" id="measureNoteInput" placeholder="Opcionalno" />
            </label>
          </div>
        </div>

        <div class="actions-row">
          <button id="btnAddMeasure">‚ûï Dodaj plohu</button>
          <button id="btnClearMeasureFields" class="ghost">Oƒçisti polja</button>
        </div>

        <div class="actions-row" style="margin-top:6px;">
          <button id="btnExportMeasuresCsv" class="secondary">CSV mjere (dokaznica)</button>
          <button id="btnExportMeasuresPdf" class="secondary">PDF mjere (dokaznica)</button>
        </div>

        <div class="measure-table-container" id="measureCurrentTable"></div>
        <div class="totals" id="measuresSummary" style="margin-top:10px;"></div>
        <p class="hint">
          Mjere se organiziraju po <strong>gradili≈°tu</strong> i <strong>prostoriji</strong>.
          Mo≈æe≈° unositi pojedine plohe (≈°irina √ó visina ili du≈æni metar, ili direktan iznos). Sve se automatski zbraja.
        </p>
      </section>

      <!-- CLOUD BACKUP -->
      <section class="card">
        <h3><span class="emoji">‚òÅÔ∏è</span> Cloud backup / sync <span class="badge">OPCIJSKI</span></h3>
        <label>Sync kod (npr. naziv firme ili ‚Äúkob-produkcija‚Äù)
          <input type="text" id="syncCodeInput" placeholder="npr. kob-keramika-team" />
        </label>
        <div class="actions-row">
          <button id="btnUploadBackup" class="secondary">Spremi u cloud</button>
          <button id="btnDownloadBackup" class="ghost">Uƒçitaj iz clouda</button>
        </div>
        <p class="hint">
          Cloud sync koristi Firebase Firestore i <strong>nije aktivan</strong> dok ne upi≈°e≈° svoje Firebase podatke u kod.
          Trenutno sve radi lokalno i sigurno na ovom ureƒëaju.
        </p>
      </section>
    </section>

    <!-- EKRAN PO RADNIKU -->
    <section id="workersView" class="view">
      <section class="card">
        <h3><span class="emoji">üë∑</span> Sa≈æetak po radniku</h3>
        <div id="workersSummary"></div>
        <p class="hint">Dodirni ‚ÄúPrika≈æi‚Äù za filtrirani prikaz tro≈°kova tog radnika.</p>
      </section>
    </section>
  </main>

  <footer>
    KOB-Keramika ‚Äî lokalna PWA aplikacija (tro≈°kovi + mjere; cloud sync je opcijski).
  </footer>

  <script>
    // Kljuƒçevi za lokalnu pohranu
    const STORAGE_KEY = 'kob_keramika_expenses_v5';
    const MEASURES_KEY = 'kob_keramika_measures_v2';

    // Tipovi mjera
    const MEASURE_TYPES = {
      zid_m2: { label: 'Zid', unit: 'm¬≤', kind: 'area' },
      pod_m2: { label: 'Pod', unit: 'm¬≤', kind: 'area' },
      sokl_m: { label: 'Sokl', unit: 'm', kind: 'length' },
      hidro_m2: { label: 'Hidroizolacija', unit: 'm¬≤', kind: 'area' },
      hidro_traka_m: { label: 'Hidro traka', unit: 'm', kind: 'length' },
      gerung_m: { label: 'Gerung', unit: 'm', kind: 'length' },
      lajsne_m: { label: 'Lajsne', unit: 'm', kind: 'length' },
      stepenice_m: { label: 'Stepenice', unit: 'm', kind: 'length' }
    };

    function loadExpenses() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error('Load error', e);
        return [];
      }
    }
    function saveExpenses(list) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
    }

    function loadMeasures() {
      try {
        const raw = localStorage.getItem(MEASURES_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) {
        console.error('Measures load error', e);
        return {};
      }
    }
    function saveMeasures(m) {
      localStorage.setItem(MEASURES_KEY, JSON.stringify(m));
    }

    let expenses = loadExpenses();
    let measures = loadMeasures(); // struktura: { [site]: { [room]: [ {id, type, qty, width, height, length, note, ts} ] } }

    // -------------------------------------------------------
    // POGLEDI
    // -------------------------------------------------------
    const splashView = document.getElementById('splashView');
    const entryView  = document.getElementById('entryView');
    const workersView = document.getElementById('workersView');
    const goEntryBtn = document.getElementById('goEntry');
    const goOverviewBtn = document.getElementById('goOverview');
    const goWorkersBtn = document.getElementById('goWorkers');
    const headerLogo = document.getElementById('headerLogo');
    const workersSummary = document.getElementById('workersSummary');

    function showView(id) {
      [splashView, entryView, workersView].forEach(v => v.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }
    goEntryBtn.addEventListener('click', () => showView('entryView'));
    goOverviewBtn.addEventListener('click', () => showView('entryView'));
    goWorkersBtn.addEventListener('click', () => { renderWorkersSummary(); showView('workersView'); });
    headerLogo.addEventListener('click', () => showView('splashView'));

    // -------------------------------------------------------
    // ELEMENTI TRO≈†KOVA
    // -------------------------------------------------------
    const workerInput = document.getElementById('workerInput');
    const siteInput = document.getElementById('siteInput');
    const amountInput = document.getElementById('amountInput');
    const descInput = document.getElementById('descInput');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const addExpenseBtn = document.getElementById('addExpenseBtn');
    const expensesContainer = document.getElementById('expensesContainer');
    const totalsContainer = document.getElementById('totalsContainer');
    const selectedWorkerTotal = document.getElementById('selectedWorkerTotal');
    const workerFilter = document.getElementById('workerFilter');
    const siteFilter = document.getElementById('siteFilter');
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const printBtn = document.getElementById('printBtn');
    const btnShowAll = document.getElementById('btnShowAll');
    const btnShowWorker = document.getElementById('btnShowWorker');
    const syncCodeInput = document.getElementById('syncCodeInput');
    const btnUploadBackup = document.getElementById('btnUploadBackup');
    const btnDownloadBackup = document.getElementById('btnDownloadBackup');

    let latestImageDataUrl = null;
    let listMode = 'all';

    btnShowAll.addEventListener('click', () => {
      listMode = 'all';
      btnShowAll.classList.add('active');
      btnShowWorker.classList.remove('active');
      renderAll();
    });
    btnShowWorker.addEventListener('click', () => {
      listMode = 'worker';
      btnShowWorker.classList.add('active');
      btnShowAll.classList.remove('active');
      renderAll();
    });

    // -------------------------------------------------------
    // ELEMENTI MJERENJA PRO
    // -------------------------------------------------------
    const measureSiteInput = document.getElementById('measureSiteInput');
    const measureRoomInput = document.getElementById('measureRoomInput');
    const measureTypeSelect = document.getElementById('measureTypeSelect');
    const measureWidthInput = document.getElementById('measureWidthInput');
    const measureHeightInput = document.getElementById('measureHeightInput');
    const measureLengthInput = document.getElementById('measureLengthInput');
    const measureQtyInput = document.getElementById('measureQtyInput');
    const measureNoteInput = document.getElementById('measureNoteInput');
    const btnAddMeasure = document.getElementById('btnAddMeasure');
    const btnClearMeasureFields = document.getElementById('btnClearMeasureFields');
    const btnExportMeasuresCsv = document.getElementById('btnExportMeasuresCsv');
    const btnExportMeasuresPdf = document.getElementById('btnExportMeasuresPdf');
    const measureCurrentTable = document.getElementById('measureCurrentTable');
    const measuresSummary = document.getElementById('measuresSummary');

    // -------------------------------------------------------
    // OCR ZA IZNOS
    // -------------------------------------------------------
    function smartExtractAmount(text) {
      if (!text) return null;
      const lower = text.toLowerCase();
      const lines = lower.split(/\r?\n/);

      function findAmountInLine(line) {
        const numRegex = /([0-9]+(?:[.,][0-9]{1,2}))/g;
        let m, max = null;
        while ((m = numRegex.exec(line)) !== null) {
          const v = parseFloat(m[1].replace(',', '.'));
          if (!isNaN(v) && v > 0 && v <= 100000 && (max === null || v > max)) {
            max = v;
          }
        }
        return max;
      }

      const keywords = ['ukupno', 'za plaƒáanje', 'za platiti', 'total', 'gesamt', 'sveukupno'];
      for (const line of lines) {
        if (keywords.some(k => line.includes(k))) {
          const found = findAmountInLine(line);
          if (found !== null) return found.toString();
        }
      }

      const euroRegex = /(eur|euro|‚Ç¨)\s*([0-9]+(?:[.,][0-9]{1,2})?)/g;
      let match, best = null;
      while ((match = euroRegex.exec(lower)) !== null) {
        const val = parseFloat(match[2].replace(',', '.'));
        if (!isNaN(val) && (best === null || val > best)) best = val;
      }
      if (best !== null) return best.toString();

      let globalMax = null;
      for (const line of lines) {
        const val = findAmountInLine(line);
        if (val !== null && (globalMax === null || val > globalMax)) {
          globalMax = val;
        }
      }
      return globalMax !== null ? globalMax.toString() : null;
    }

    imageInput.addEventListener('change', () => {
      const file = imageInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (evt) => {
        latestImageDataUrl = evt.target.result;
        previewImg.src = latestImageDataUrl;
        imagePreview.style.display = 'block';

        if (window.Tesseract) {
          try {
            const res = await Tesseract.recognize(latestImageDataUrl, 'eng', { logger: m => console.log(m) });
            const amountStr = smartExtractAmount(res.data.text);
            if (amountStr) amountInput.value = amountStr;
          } catch (e) {
            console.warn('OCR error', e);
          }
        }
      };
      reader.readAsDataURL(file);
    });

    // -------------------------------------------------------
    // DODAVANJE TRO≈†KA
    // -------------------------------------------------------
    addExpenseBtn.addEventListener('click', () => {
      const worker = workerInput.value.trim();
      const site = siteInput.value.trim();
      const amount = parseFloat((amountInput.value || '0').replace(',', '.'));
      const desc = descInput.value.trim();

      if (!worker || isNaN(amount)) {
        alert('Unesi ime radnika i ispravan iznos.');
        return;
      }

      const exp = {
        id: Date.now(),
        worker,
        site,
        amount,
        desc,
        image: latestImageDataUrl || null,
        date: new Date().toISOString()
      };
      expenses.push(exp);
      saveExpenses(expenses);

      workerInput.value = '';
      siteInput.value = '';
      amountInput.value = '';
      descInput.value = '';
      renderAll();
    });

    // -------------------------------------------------------
    // MJERENJE PRO ‚Äì DODAVANJE PLOHE
    // -------------------------------------------------------
    btnAddMeasure.addEventListener('click', () => {
      const site = measureSiteInput.value.trim();
      const room = measureRoomInput.value.trim();
      const type = measureTypeSelect.value;

      if (!site || !room) {
        alert('Upi≈°i naziv gradili≈°ta i prostorije.');
        return;
      }
      const meta = MEASURE_TYPES[type];
      if (!meta) {
        alert('Odaberi tip mjere.');
        return;
      }

      const direct = parseFloat((measureQtyInput.value || '0').replace(',', '.'));
      const w = parseFloat((measureWidthInput.value || '0').replace(',', '.'));
      const h = parseFloat((measureHeightInput.value || '0').replace(',', '.'));
      const L = parseFloat((measureLengthInput.value || '0').replace(',', '.'));

      let qty = null;

      if (!isNaN(direct) && direct > 0) {
        qty = direct;
      } else if (meta.kind === 'area') {
        if (!isNaN(w) && w > 0 && !isNaN(h) && h > 0) {
          qty = w * h;
        }
      } else if (meta.kind === 'length') {
        if (!isNaN(L) && L > 0) {
          qty = L;
        }
      }

      if (qty === null) {
        alert('Unesi dimenzije ili direktnu koliƒçinu.');
        return;
      }

      if (!measures[site]) measures[site] = {};
      if (!measures[site][room]) measures[site][room] = [];
      measures[site][room].push({
        id: Date.now(),
        type,
        qty,
        width: !isNaN(w) && w > 0 ? w : null,
        height: !isNaN(h) && h > 0 ? h : null,
        length: !isNaN(L) && L > 0 ? L : null,
        note: measureNoteInput.value.trim() || '',
        ts: new Date().toISOString()
      });
      saveMeasures(measures);

      renderMeasuresCurrent();
      renderMeasuresSummary();
    });

    btnClearMeasureFields.addEventListener('click', () => {
      measureWidthInput.value = '';
      measureHeightInput.value = '';
      measureLengthInput.value = '';
      measureQtyInput.value = '';
      measureNoteInput.value = '';
    });

    // -------------------------------------------------------
    // RENDER MJERA ZA AKTUALNO GRADILI≈†TE/PROSTORIJU
    // -------------------------------------------------------
    function renderMeasuresCurrent() {
      const site = measureSiteInput.value.trim();
      const room = measureRoomInput.value.trim();
      if (!site || !room || !measures[site] || !measures[site][room] || !measures[site][room].length) {
        measureCurrentTable.innerHTML = '<p>Nema unesenih ploha za odabrano gradili≈°te/prostoriju.</p>';
        return;
      }
      const list = measures[site][room].slice().sort((a,b) => a.ts.localeCompare(b.ts));
      let html = '<table><thead><tr><th>Vrsta</th><th>Dimenzije</th><th>Koliƒçina</th><th>Napomena</th></tr></thead><tbody>';
      list.forEach(m => {
        const meta = MEASURE_TYPES[m.type] || { label: m.type, unit: '' };
        let dim = '';
        if (m.width && m.height) dim = (m.width + '√ó' + m.height + ' m');
        else if (m.length) dim = m.length + ' m';
        html += '<tr>' +
          '<td>' + meta.label + '</td>' +
          '<td>' + dim + '</td>' +
          '<td>' + m.qty.toFixed(3) + ' ' + meta.unit + '</td>' +
          '<td>' + (m.note || '') + '</td>' +
          '</tr>';
      });
      html += '</tbody></table>';
      measureCurrentTable.innerHTML = html;
    }

    measureSiteInput.addEventListener('change', () => {
      renderMeasuresCurrent();
      renderMeasuresSummary();
    });
    measureRoomInput.addEventListener('change', () => {
      renderMeasuresCurrent();
    });

    // -------------------------------------------------------
    // SA≈ΩETAK MJERA PO GRADILI≈†TU
    // -------------------------------------------------------
    function renderMeasuresSummary() {
      const site = measureSiteInput.value.trim();
      if (!site || !measures[site]) {
        const keys = Object.keys(measures);
        if (!keys.length) {
          measuresSummary.innerHTML = '<p>Nema spremljenih mjerenja.</p>';
          return;
        }
        let html = '<strong>Postoje mjerenja za gradili≈°ta:</strong><br>' + keys.join(', ');
        measuresSummary.innerHTML = html;
        return;
      }

      const rooms = measures[site];
      const totalByType = {};
      Object.keys(rooms).forEach(room => {
        rooms[room].forEach(m => {
          if (!totalByType[m.type]) totalByType[m.type] = 0;
          totalByType[m.type] += m.qty;
        });
      });

      let html = '<strong>Sa≈æetak mjera za gradili≈°te: ' + site + '</strong><br>';
      Object.keys(rooms).sort().forEach(room => {
        html += '<div style="margin-top:6px;"><u>Prostorija: ' + room + '</u><br>';
        const localByType = {};
        rooms[room].forEach(m => {
          if (!localByType[m.type]) localByType[m.type] = 0;
          localByType[m.type] += m.qty;
        });
        Object.keys(localByType).forEach(t => {
          const meta = MEASURE_TYPES[t] || { label: t, unit: '' };
          html += meta.label + ': ' + localByType[t].toFixed(3) + ' ' + meta.unit + '<br>';
        });
        html += '</div>';
      });

      html += '<div style="margin-top:8px;"><strong>Ukupno za gradili≈°te:</strong><br>';
      Object.keys(totalByType).forEach(t => {
        const meta = MEASURE_TYPES[t] || { label: t, unit: '' };
        html += meta.label + ': ' + totalByType[t].toFixed(3) + ' ' + meta.unit + '<br>';
      });
      html += '</div>';

      measuresSummary.innerHTML = html;
    }

    // -------------------------------------------------------
    // RENDER TRO≈†KOVA I SA≈ΩETAKA
    // -------------------------------------------------------
    function renderAll() {
      const workers = [...new Set(expenses.map(e => e.worker))].sort();
      const currentWorker = workerFilter.value;
      workerFilter.innerHTML = '<option value="">Svi radnici</option>';
      workers.forEach(w => {
        const opt = document.createElement('option');
        opt.value = w;
        opt.textContent = w;
        if (w === currentWorker) opt.selected = true;
        workerFilter.appendChild(opt);
      });

      const sites = [...new Set(expenses.map(e => e.site).filter(s => s))].sort();
      const currentSite = siteFilter.value;
      siteFilter.innerHTML = '<option value="">Sva gradili≈°ta</option>';
      sites.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if (s === currentSite) opt.selected = true;
        siteFilter.appendChild(opt);
      });

      const filterWorker = workerFilter.value;
      const filterSite = siteFilter.value;

      let filtered = expenses.slice();
      if (filterWorker) filtered = filtered.filter(e => e.worker === filterWorker);
      if (filterSite) filtered = filtered.filter(e => e.site === filterSite);
      if (listMode === 'worker' && filterWorker) {
        filtered = filtered.filter(e => e.worker === filterWorker);
      }
      filtered.sort((a,b) => b.date.localeCompare(a.date));

      if (!filtered.length) {
        expensesContainer.innerHTML = '<p>Nema upisanih tro≈°kova.</p>';
      } else {
        let html = '<div style="max-height:320px;overflow:auto;"><table><thead><tr>' +
          '<th>Datum</th><th>Radnik</th><th>Gradili≈°te</th><th>Iznos</th><th>Opis</th></tr></thead><tbody>';
        filtered.forEach(e => {
          const d = new Date(e.date);
          const ds = d.toLocaleDateString('hr-HR') + ' ' +
            d.toLocaleTimeString('hr-HR', { hour: '2-digit', minute: '2-digit' });
          html += '<tr>' +
            '<td>' + ds + '</td>' +
            '<td>' + e.worker + '</td>' +
            '<td>' + (e.site || '') + '</td>' +
            '<td>' + e.amount.toFixed(2) + '</td>' +
            '<td>' + (e.desc || '') + '</td>' +
            '</tr>';
        });
        html += '</tbody></table></div>';
        expensesContainer.innerHTML = html;
      }

      const totals = {};
      expenses.forEach(e => {
        totals[e.worker] = (totals[e.worker] || 0) + e.amount;
      });
      if (!Object.keys(totals).length) {
        totalsContainer.innerHTML = '';
      } else {
        let tHtml = '<strong>Ukupno po radniku (svi tro≈°kovi):</strong><br>';
        Object.keys(totals).forEach(w => {
          tHtml += w + ': ' + totals[w].toFixed(2) + ' ‚Ç¨<br>';
        });
        totalsContainer.innerHTML = tHtml;
      }

      if (filterWorker && filtered.length) {
        const sumSel = filtered.reduce((s,e) => s + e.amount, 0);
        selectedWorkerTotal.innerHTML =
          '<strong>Ukupno za radnika ' + filterWorker +
          (filterSite ? ' na ' + filterSite : '') +
          ' (trenutni prikaz):</strong> ' +
          sumSel.toFixed(2) + ' ‚Ç¨';
      } else {
        selectedWorkerTotal.innerHTML = '';
      }

      renderWorkersSummary();
      renderMeasuresSummary();
      renderMeasuresCurrent();
    }

    workerFilter.addEventListener('change', () => {
      if (workerFilter.value) listMode = 'worker';
      renderAll();
    });
    siteFilter.addEventListener('change', renderAll);

    // -------------------------------------------------------
    // SA≈ΩETAK PO RADNIKU
    // -------------------------------------------------------
    function renderWorkersSummary() {
      if (!expenses.length) {
        workersSummary.innerHTML = '<p>Nema podataka.</p>';
        return;
      }
      const agg = {};
      expenses.forEach(e => {
        if (!agg[e.worker]) agg[e.worker] = { total: 0, count: 0 };
        agg[e.worker].total += e.amount;
        agg[e.worker].count += 1;
      });
      let html = '<table><thead><tr><th>Radnik</th><th>Broj tro≈°kova</th><th>Ukupno</th><th></th></tr></thead><tbody>';
      Object.keys(agg).forEach(w => {
        const info = agg[w];
        html += '<tr>' +
          '<td>' + w + '</td>' +
          '<td>' + info.count + '</td>' +
          '<td>' + info.total.toFixed(2) + ' ‚Ç¨</td>' +
          '<td><button data-worker="' + w + '" class="btnShowWorker">Prika≈æi</button></td>' +
          '</tr>';
      });
      html += '</tbody></table>';
      workersSummary.innerHTML = html;

      workersSummary.querySelectorAll('.btnShowWorker').forEach(btn => {
        btn.addEventListener('click', () => {
          const w = btn.getAttribute('data-worker');
          workerFilter.value = w;
          listMode = 'worker';
          btnShowWorker.classList.add('active');
          btnShowAll.classList.remove('active');
          renderAll();
          showView('entryView');
        });
      });
    }

    // -------------------------------------------------------
    // EXPORT TRO≈†KOVA CSV & PDF
    // -------------------------------------------------------
    exportCsvBtn.addEventListener('click', () => {
      if (!expenses.length) {
        alert('Nema tro≈°kova za export.');
        return;
      }
      const rows = [['datum', 'radnik', 'gradiliste', 'iznos', 'opis']];
      expenses.forEach(e => {
        rows.push([
          e.date,
          e.worker,
          e.site || '',
          e.amount.toString().replace('.', ','),
          e.desc || ''
        ]);
      });
      const csvContent = rows
        .map(row => row.map(val => '"' + String(val || '').replace(/"/g,'""') + '"').join(';'))
        .join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kob_keramika_troskovi.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    exportPdfBtn.addEventListener('click', () => {
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert('PDF modul nije uƒçitan.');
        return;
      }
      const filterWorker = workerFilter.value;
      const filterSite = siteFilter.value;
      let list = expenses.slice();
      if (filterWorker) list = list.filter(e => e.worker === filterWorker);
      if (filterSite) list = list.filter(e => e.site === filterSite);
      if (!list.length) {
        alert('Nema tro≈°kova za generiranje PDF-a.');
        return;
      }
      const doc = new jsPDF();
      doc.setFontSize(14);
      let title = 'Izvje≈°taj ‚Äì tro≈°kovi';
      if (filterWorker) title += ' za ' + filterWorker;
      if (filterSite) title += ' (' + filterSite + ')';
      doc.text(title, 10, 16);
      doc.setFontSize(10);
      let y = 24;
      list.forEach(e => {
        const d = new Date(e.date);
        const ds = d.toLocaleDateString('hr-HR');
        const line = `${ds} | ${e.worker} | ${e.site || ''} | ${e.amount.toFixed(2)} ‚Ç¨ | ${e.desc || ''}`;
        const split = doc.splitTextToSize(line, 190);
        if (y + split.length * 5 > 280) {
          doc.addPage();
          y = 20;
        }
        split.forEach(l => {
          doc.text(l, 10, y);
          y += 5;
        });
      });
      doc.save('kob_keramika_izvjestaj_troskovi.pdf');
    });

    printBtn.addEventListener('click', () => window.print());

    // -------------------------------------------------------
    // EXPORT MJERA CSV & PDF (MJERNA DOKAZNICA)
    // -------------------------------------------------------
    btnExportMeasuresCsv.addEventListener('click', () => {
      const site = measureSiteInput.value.trim();
      if (!site) {
        alert('Za CSV export mjera upi≈°i gradili≈°te.');
        return;
      }
      if (!measures[site]) {
        alert('Nema mjera za ovo gradili≈°te.');
        return;
      }

      const rows = [['gradiliste','prostorija','vrsta','sirina','visina','duzina','kolicina','jedinica','napomena','vrijeme']];
      Object.keys(measures[site]).forEach(room => {
        measures[site][room].forEach(m => {
          const meta = MEASURE_TYPES[m.type] || { label:m.type, unit:'' };
          rows.push([
            site,
            room,
            meta.label,
            m.width != null ? m.width : '',
            m.height != null ? m.height : '',
            m.length != null ? m.length : '',
            m.qty.toFixed(3),
            meta.unit,
            m.note || '',
            m.ts
          ]);
        });
      });

      const csvContent = rows
        .map(row => row.map(val => '"' + String(val || '').replace(/"/g,'""') + '"').join(';'))
        .join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kob_keramika_mjere_' + site.replace(/\s+/g,'_') + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    btnExportMeasuresPdf.addEventListener('click', () => {
      const site = measureSiteInput.value.trim();
      if (!site) {
        alert('Za PDF mjerne knjige upi≈°i gradili≈°te.');
        return;
      }
      if (!measures[site]) {
        alert('Nema mjera za ovo gradili≈°te.');
        return;
      }
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert('PDF modul nije uƒçitan.');
        return;
      }

      const doc = new jsPDF();
      doc.setFontSize(14);
      doc.text('KOB-Keramika ‚Äì Mjerna dokaznica', 10, 16);
      doc.setFontSize(11);
      doc.text('Gradili≈°te: ' + site, 10, 24);
      doc.setFontSize(10);
      let y = 32;

      const rooms = measures[site];
      Object.keys(rooms).sort().forEach(room => {
        if (y > 260) { doc.addPage(); y = 20; }
        doc.setFontSize(11);
        doc.text('Prostorija: ' + room, 10, y);
        y += 4;
        doc.setFontSize(9);

        const localByType = {};
        rooms[room].forEach(m => {
          if (!localByType[m.type]) localByType[m.type] = 0;
          localByType[m.type] += m.qty;
        });

        Object.keys(localByType).forEach(t => {
          if (y > 270) { doc.addPage(); y = 20; }
          const meta = MEASURE_TYPES[t] || {label:t, unit:''};
          doc.text('- ' + meta.label + ': ' + localByType[t].toFixed(3) + ' ' + meta.unit, 12, y);
          y += 4;
        });
        y += 2;
      });

      doc.save('kob_keramika_mjerne_dokaznice_' + site.replace(/\s+/g,'_') + '.pdf');
    });

    // -------------------------------------------------------
    // CLOUD BACKUP (FIREBASE ‚Äì OPCIJSKI)
    // -------------------------------------------------------
    const USE_FIREBASE = false; // postavi na true nakon ≈°to doda≈° svoj firebaseConfig
    let db = null;

    if (USE_FIREBASE && window.firebase) {
      const firebaseConfig = {
        // TODO: ovdje zalijepi≈° svoj Firebase config iz konzole
        // apiKey: "...",
        // authDomain: "...",
        // projectId: "...",
        // storageBucket: "...",
        // messagingSenderId: "...",
        // appId: "..."
      };
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    }

    btnUploadBackup.addEventListener('click', async () => {
      const code = syncCodeInput.value.trim();
      if (!code) {
        alert('Upi≈°i sync kod.');
        return;
      }
      if (!USE_FIREBASE || !db) {
        alert('Cloud sync nije konfiguriran. Trenutno sve radi lokalno. Kad bude≈° htio pravi cloud, javit ƒáe≈° da proƒëemo Firebase konfiguraciju.');
        return;
      }
      try {
        await db.collection('kobKeramikaBackups').doc(code).set({
          data: expenses,
          measures: measures,
          ts: Date.now()
        });
        alert('Backup spremljen u cloud.');
      } catch (e) {
        console.error(e);
        alert('Gre≈°ka pri spremanju backupa.');
      }
    });

    btnDownloadBackup.addEventListener('click', async () => {
      const code = syncCodeInput.value.trim();
      if (!code) {
        alert('Upi≈°i sync kod.');
        return;
      }
      if (!USE_FIREBASE || !db) {
        alert('Cloud sync nije konfiguriran. Trenutno sve radi lokalno. Kad bude≈° htio pravi cloud, javit ƒáe≈° da proƒëemo Firebase konfiguraciju.');
        return;
      }
      try {
        const snap = await db.collection('kobKeramikaBackups').doc(code).get();
        if (!snap.exists) {
          alert('Nije pronaƒëen backup za taj sync kod.');
          return;
        }
        const data = snap.data();
        expenses = data.data || [];
        measures = data.measures || {};
        saveExpenses(expenses);
        saveMeasures(measures);
        renderAll();
        alert('Backup uƒçitan.');
      } catch (e) {
        console.error(e);
        alert('Gre≈°ka pri uƒçitavanju backupa.');
      }
    });

    // inicijalni render
    renderAll();
  </script>
</body>
</html>
