<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>KOB-Keramika ‚Äì Pro obraƒçun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA manifest (ako postoji) -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- jsPDF za PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase (AUTH + Firestore + Storage) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

  <style>
    :root {
      --bg: #050505;
      --card: #121212;
      --border: #333;
      --accent: #ffffff;
      --accent-soft: #888;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI";
      background: radial-gradient(circle at top, #202020 0, #000 55%);
      color: #fff;
    }

    header {
      position: sticky;
      top: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
    }

    header .left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header img.logo {
      height: 42px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.15);
    }

    main {
      padding: 12px;
      max-width: 1100px;
      margin: 0 auto 40px auto;
    }

    .card {
      border-radius: 16px;
      padding: 14px 12px;
      margin-bottom: 12px;
      background: radial-gradient(circle at top left, #1c1c1c, #101010);
      border: 1px solid rgba(255,255,255,0.06);
    }

    .view { display: none; }
    .view.active { display: block; }

    h2 { margin-top: 0; }

    label {
      font-size: 13px;
      display: block;
      margin-top: 8px;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 3px;
      background: #000;
      color: #fff;
      border: 1px solid #333;
      border-radius: 8px;
      font-size: 13px;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid #fff;
      background: #fff;
      color: #000;
      padding: 8px 14px;
      margin-top: 10px;
      font-size: 13px;
    }

    button.secondary {
      background: transparent;
      color: #fff;
      border-color: #444;
    }

    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
      font-size: 13px;
    }

    .checkbox-row input[type="checkbox"] {
      width: auto;
    }

    .section-title {
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
    }

    .layout-split {
      display: block;
    }

    @media (min-width: 800px) {
      .layout-split {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 12px;
      }
    }

    .openings-header {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 8px;
    }

    .opening-card {
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 8px;
      background: #141414;
      border: 1px solid #333;
      font-size: 12px;
    }

    .opening-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .opening-meta {
      opacity: 0.85;
    }

    .opening-actions {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #444;
      margin-right: 4px;
      margin-top: 2px;
    }

    #calcOutput {
      font-size: 13px;
      line-height: 1.35;
    }

    .dm-row {
      display: grid;
      grid-template-columns: 1.5fr 1fr 0.7fr auto;
      gap: 6px;
      margin-top: 6px;
      align-items: center;
    }

    .dm-row button {
      width: auto;
      padding: 4px 8px;
      font-size: 11px;
      margin-top: 0;
    }

    .height-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 6px;
      margin-top: 6px;
      align-items: center;
    }

    .height-row button {
      width: auto;
      padding: 4px 8px;
      font-size: 11px;
      margin-top: 0;
    }

    /* Login i arhiva */
    .centered {
      max-width: 420px;
      margin: 30px auto;
    }

    .archive-list-item {
      border-bottom: 1px solid #333;
      padding: 8px 0;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .archive-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #444;
      font-size: 11px;
      margin-right: 4px;
    }
  </style>
</head>
<body>

<header>
  <div class="left">
    <img src="logo.png" class="logo" alt="Logo">
    <div>
      <div style="font-weight:bold">KOB-Keramika</div>
      <div style="font-size:12px;opacity:0.8">Pro obraƒçun prostorije</div>
    </div>
  </div>
  <div style="font-size:11px;opacity:0.7;" id="userInfo">Nije prijavljen</div>
</header>

<main>

  <!-- LOGIN VIEW -->
  <section id="loginView" class="view active">
    <div class="card centered">
      <h2>Prijava u KOB-Keramika</h2>
      <label>E-mail
        <input type="email" id="loginEmail" placeholder="you@example.com">
      </label>
      <label>Lozinka
        <input type="password" id="loginPassword" placeholder="******">
      </label>
      <button id="btnLogin">üîê Prijava</button>
      <button id="btnRegister" class="secondary">‚ûï Registracija</button>
      <p id="loginError" style="color:#f66;font-size:12px;"></p>
    </div>
  </section>

  <!-- HOME VIEW -->
  <section id="homeView" class="view">
    <div class="card">
      <h2>≈†to ≈æeli≈° raditi?</h2>
      <button id="btnOpenAutoCalc">üìê Automatski obraƒçun prostorije</button>
      <button id="btnOpenMeasures">‚úèÔ∏è Ruƒçni unos mjera (u pripremi)</button>
      <button id="btnOpenCosts">üí∞ Tro≈°kovi</button>
      <button id="btnOpenPrices">üí∂ Modul cijena</button>
      <button id="btnOpenArchive">üìÇ Arhiva obraƒçuna (Cloud)</button>
      <button id="btnLogout" class="secondary">üö™ Odjava</button>
    </div>
  </section>

  <!-- AUTOMATSKI OBRAƒåUN PROSTORIJE -->
  <section id="autoCalcView" class="view">

    <div class="card">
      <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
      <h2>üìê Automatski obraƒçun prostorije</h2>
      <p style="font-size:13px;opacity:0.8;">
        Dimenzije prostorije + otvori (vrata, prozori, ni≈°e, geberit, vertikale) ‚Üí automatski obraƒçun poda, zidova,
        hidroizolacije, traka, silikona, sokla, stepenica, lajsni i gerunga. Na kraju se generira detaljna graƒëevinska knjiga (PDF),
        CSV za Excel i mo≈æe≈° spremiti u Cloud.
      </p>
    </div>

    <!-- VI≈†E PROSTORIJA U OBRAƒåUNU -->
    <div class="card">
      <div class="section-title">üß© Vi≈°e prostorija u jednom obraƒçunu</div>
      <p style="font-size:12px;opacity:0.8;">
        1. Unesi podatke za prostoriju i klikni <b>Izraƒçunaj sve</b><br>
        2. Zatim klikni <b>‚ûï Dodaj ovu prostoriju</b> da je doda≈° u skup.<br>
        3. Ponovi za svaku sljedeƒáu prostoriju.<br>
        Graƒëevinska knjiga (PDF) i Cloud pohrana koristit ƒáe sve dodane prostorije.
      </p>
      <button id="btnAddRoomToSet">‚ûï Dodaj ovu prostoriju</button>
      <button id="btnClearRoomsSet" class="secondary btn-small" style="margin-left:6px;">üóë Oƒçisti popis</button>
      <p style="font-size:11px;opacity:0.7;margin-top:6px;">
        Dodano prostorija: <span id="roomsCounter">0</span>
      </p>
    </div>

    <!-- PODACI O GRADILI≈†TU -->
    <div class="card">
      <div class="section-title">üèó Podaci o gradili≈°tu</div>
      <label>Naziv gradili≈°ta
        <input type="text" id="siteName" placeholder="npr. Stan Novak ‚Äì Maksimir">
      </label>
      <label>Prostorija
        <input type="text" id="roomName" placeholder="npr. Kupaonica 1">
      </label>
      <div class="two-col">
        <label>Situcija / redni broj
          <input type="text" id="situationNo" placeholder="npr. Situacija 1">
        </label>
        <label>Investitor
          <input type="text" id="investorName" placeholder="npr. Novak Ivan">
        </label>
      </div>
    </div>

    <!-- FORMAT PLOƒåICE -->
    <div class="card">
      <div class="section-title">üß± Format ploƒçice (obavezno)</div>
      <label>Odaberi format
        <select id="tileFormatSelect">
          <option value="">-- Odaberi format --</option>
          <!-- mali -->
          <option value="10x10">10 √ó 10 cm</option>
          <option value="15x15">15 √ó 15 cm</option>
          <option value="20x20">20 √ó 20 cm</option>
          <option value="20x25">20 √ó 25 cm</option>
          <option value="20x30">20 √ó 30 cm</option>
          <option value="25x33">25 √ó 33 cm</option>
          <option value="25x40">25 √ó 40 cm</option>
          <option value="25x50">25 √ó 50 cm</option>
          <!-- srednji -->
          <option value="30x30">30 √ó 30 cm</option>
          <option value="30x45">30 √ó 45 cm</option>
          <option value="30x60">30 √ó 60 cm</option>
          <option value="40x40">40 √ó 40 cm</option>
          <option value="45x45">45 √ó 45 cm</option>
          <option value="50x50">50 √ó 50 cm</option>
          <option value="50x100">50 √ó 100 cm</option>
          <!-- veliki -->
          <option value="60x60">60 √ó 60 cm</option>
          <option value="60x120">60 √ó 120 cm</option>
          <option value="75x75">75 √ó 75 cm</option>
          <option value="80x80">80 √ó 80 cm</option>
          <option value="90x90">90 √ó 90 cm</option>
          <option value="100x100">100 √ó 100 cm</option>
          <!-- NOVO -->
          <option value="120x120">120 √ó 120 cm</option>
          <!-- XXL -->
          <option value="100x300">100 √ó 300 cm</option>
          <option value="120x240">120 √ó 240 cm</option>
          <option value="120x260">120 √ó 260 cm</option>
          <option value="120x270">120 √ó 270 cm</option>
          <option value="120x280">120 √ó 280 cm</option>
          <option value="120x300">120 √ó 300 cm</option>
          <option value="160x320">160 √ó 320 cm</option>
          <option value="162x324">162 √ó 324 cm</option>
          <!-- ruƒçni -->
          <option value="custom">Ruƒçni unos</option>
        </select>
      </label>
      <div id="tileCustomFields" style="display:none;">
        <div class="two-col">
          <label>≈†irina ploƒçice (cm)
            <input type="text" id="tileW" placeholder="npr. 60">
          </label>
          <label>Duljina ploƒçice (cm)
            <input type="text" id="tileH" placeholder="npr. 120">
          </label>
        </div>
      </div>
      <p style="font-size:11px;opacity:0.7;margin-top:4px;">
        Bez odabranog formata ploƒçice obraƒçun se neƒáe pokrenuti.
      </p>
    </div>

    <div class="layout-split">

      <!-- LIJEVA STRANA ‚Äì UNOS -->
      <div>

        <div class="card">
          <div class="section-title">üìè Osnovne dimenzije prostorije</div>

          <label>Duljina D (m)
            <input type="text" id="dimD" placeholder="npr. 4,20">
          </label>

          <label>≈†irina ≈† (m)
            <input type="text" id="dimS" placeholder="npr. 3,10">
          </label>

          <label>Visina V (m)
            <input type="text" id="dimV" placeholder="npr. 2,65">
          </label>
        </div>

        <div class="card">
          <div class="section-title">‚òë ≈†to se raƒçuna?</div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkPod">
            <label for="chkPod">Pod (m¬≤)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkZidovi">
            <label for="chkZidovi">Zidovi (bruto ‚Äì samo vrata se odbijaju)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkHidroPod">
            <label for="chkHidroPod">Hidroizolacija ‚Äì pod</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkHidroTus">
            <label for="chkHidroTus">Hidroizolacija ‚Äì tu≈° zona</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkHidroTraka">
            <label for="chkHidroTraka">Hidro traka (pod + prozor + ni≈°a)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkSilikon">
            <label for="chkSilikon">Silikon (bez vrata)</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkSokl">
            <label for="chkSokl">Sokl</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkStepenice">
            <label for="chkStepenice">Stepenice</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkLajsne">
            <label for="chkLajsne">Lajsne</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkGerung">
            <label for="chkGerung">Gerung</label>
          </div>

          <div class="checkbox-row">
            <input type="checkbox" id="chkDodatne">
            <label for="chkDodatne">Dodatne mjere (+/‚àí)</label>
          </div>
        </div>

        <!-- Tu≈° zona -->
        <div class="card" id="cardTus" style="display:none;">
          <div class="section-title">üöø Tu≈° zona</div>
          <div class="two-col">
            <label>Duljina tu≈°a d (m)
              <input type="text" id="tusD" placeholder="npr. 0,90">
            </label>
            <label>≈†irina tu≈°a ≈° (m)
              <input type="text" id="tusS" placeholder="npr. 1,45">
            </label>
          </div>
          <label>Visina tu≈°a v (m) ‚Äì po defaultu glavna visina
            <input type="text" id="tusV" placeholder="prazno = visina prostorije">
          </label>
          <p style="font-size:11px;opacity:0.7;margin-top:4px;">
            Hidro tu≈° = (2√ód + ≈°) √ó v
          </p>
        </div>

        <!-- Silikon ‚Äì vi≈°estruke visine -->
        <div class="card" id="cardSilikon" style="display:none;">
          <div class="section-title">üßº Silikon</div>
          <p style="font-size:12px;opacity:0.8;">
            Formula: (2√óD + 2√ó≈† + 4√óV) + ‚àë(dodatne visine) + rubovi svih otvora osim vrata.
          </p>
          <div id="silHeightsContainer"></div>
          <button type="button" class="btn-small secondary" id="btnAddHeight">‚ûï Dodaj visinu</button>
        </div>

        <!-- Sokl -->
        <div class="card" id="cardSokl" style="display:none;">
          <div class="section-title">üìè Sokl ‚Äì korekcije</div>
          <label>Odbijanje sokla (m)
            <input type="text" id="soklMinus" placeholder="0">
          </label>
          <label>Dodatno sokla (m)
            <input type="text" id="soklPlus" placeholder="0">
          </label>
          <p style="font-size:11px;opacity:0.7;margin-top:4px;">
            Sokl = 2√ó(D+≈†) ‚àí odbijanje + dodatno
          </p>
        </div>

        <!-- Stepenice -->
        <div class="card" id="cardStepenice" style="display:none;">
          <div class="section-title">ü™ú Stepenice</div>
          <label>≈†irina stepenice (m)
            <input type="text" id="stepWidth" placeholder="npr. 1,00">
          </label>
          <label>Broj stepenica (kom)
            <input type="text" id="stepCount" placeholder="npr. 5">
          </label>
          <label>Vrsta obraƒçuna
            <select id="stepMode">
              <option value="duzni">Du≈æni metri (≈† √ó kom)</option>
              <option value="komada">Broj komada</option>
            </select>
          </label>
        </div>

        <!-- Lajsne -->
        <div class="card" id="cardLajsne" style="display:none;">
          <div class="section-title">üîπ Lajsne</div>
          <p style="font-size:12px;opacity:0.8;">
            Ukupno lajsni = ruƒçni metri + rubovi oznaƒçenih elemenata.
          </p>
          <label>Lajsna 1 (m)
            <input type="text" id="l1" placeholder="0">
          </label>
          <label>Lajsna 2 (m)
            <input type="text" id="l2" placeholder="0">
          </label>
          <label>Lajsna 3 (m)
            <input type="text" id="l3" placeholder="0">
          </label>
          <div class="section-title">Lajsne na elementima</div>
          <div class="checkbox-row"><input type="checkbox" id="lProzor"><label for="lProzor">Prozori</label></div>
          <div class="checkbox-row"><input type="checkbox" id="lNisa"><label for="lNisa">Ni≈°e</label></div>
          <div class="checkbox-row"><input type="checkbox" id="lGeberit"><label for="lGeberit">Geberit</label></div>
          <div class="checkbox-row"><input type="checkbox" id="lVert"><label for="lVert">Vertikale</label></div>
        </div>

        <!-- Gerung -->
        <div class="card" id="cardGerung" style="display:none;">
          <div class="section-title">üî™ Gerung</div>
          <p style="font-size:12px;opacity:0.8;">
            Ukupno gerunga = ruƒçni metri + rubovi oznaƒçenih elemenata.
          </p>
          <label>Gerung 1 (m)
            <input type="text" id="g1" placeholder="0">
          </label>
          <label>Gerung 2 (m)
            <input type="text" id="g2" placeholder="0">
          </label>
          <label>Gerung 3 (m)
            <input type="text" id="g3" placeholder="0">
          </label>
          <div class="section-title">Gerung na elementima</div>
          <div class="checkbox-row"><input type="checkbox" id="gProzor"><label for="gProzor">Prozori</label></div>
          <div class="checkbox-row"><input type="checkbox" id="gNisa"><label for="gNisa">Ni≈°e</label></div>
          <div class="checkbox-row"><input type="checkbox" id="gGeberit"><label for="gGeberit">Geberit</label></div>
          <div class="checkbox-row"><input type="checkbox" id="gVert"><label for="gVert">Vertikale</label></div>
        </div>

        <!-- Dodatne mjere -->
        <div class="card" id="cardDodatne" style="display:none;">
          <div class="section-title">‚ûï‚ûñ Dodatne mjere</div>
          <p style="font-size:12px;opacity:0.8;">
            Mo≈æe≈° dodati do 10 polja kao + ili ‚àí mjera. Ukupno se zatim dodaje/oduzima od oznaƒçenih kategorija.
          </p>
          <div id="dmContainer"></div>
          <button type="button" class="btn-small secondary" id="btnAddDmRow">‚ûï Dodaj mjeru</button>

          <div class="section-title">Gdje se primjenjuje?</div>
          <div class="checkbox-row"><input type="checkbox" id="dmPod"><label for="dmPod">Pod</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmZidovi"><label for="dmZidovi">Zidovi</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmHidro"><label for="dmHidro">Hidro pod</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmSil"><label for="dmSil">Silikon</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmTraka"><label for="dmTraka">Hidro traka</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmSokl"><label for="dmSokl">Sokl</label></div>
        </div>

        <!-- Gumbi za izraƒçun -->
  div class="card" id="cardDodatne" style="display:none;">
          <div class="section-title">‚ûï‚ûñ Dodatne mjere</div>
          <p style="font-size:12px;opacity:0.8;">
            Mo≈æe≈° dodati do 10 polja kao + ili ‚àí mjera. Ukupno se zatim dodaje/oduzima od oznaƒçenih kategorija.
          </p>
          <div id="dmContainer"></div>
          <button type="button" class="btn-small secondary" id="btnAddDmRow">‚ûï Dodaj mjeru</button>

          <div class="section-title">Gdje se primjenjuje?</div>
          <div class="checkbox-row"><input type="checkbox" id="dmPod"><label for="dmPod">Pod</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmZidovi"><label for="dmZidovi">Zidovi</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmHidro"><label for="dmHidro">Hidro pod</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmSil"><label for="dmSil">Silikon</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmTraka"><label for="dmTraka">Hidro traka</label></div>
          <div class="checkbox-row"><input type="checkbox" id="dmSokl"><label for="dmSokl">Sokl</label></div>
        </div>

        <!-- Gumbi za izraƒçun -->
        <div class="card">
          <button id="btnCalcNow">üîç Izraƒçunaj sve</button>
          <button id="btnExportPdfAuto" class="secondary">üìÑ PDF ‚Äì graƒëevinska knjiga</button>
          <button id="btnExportCsvAuto" class="secondary">üìë CSV ‚Äì Excel export</button>
          <button id="btnSaveCloud" class="secondary">‚òÅÔ∏è Spremi u Cloud (podatci + PDF)</button>
        </div>

      </div>

      <!-- DESNA STRANA ‚Äì OTVORI + REZULTATI -->
      <div>

        <!-- Otvori kao kartice -->
        <div class="card">
          <div class="section-title">üß± Otvori (vrata, prozori, ni≈°e, geberit, vertikale)</div>
          <p style="font-size:12px;opacity:0.8;">
            Vrata se odbijaju od zidova, ali ne ulaze u silikon. Prozori i ni≈°e ulaze u hidro traku i silikon.
            Geberit i vertikale slu≈æe za lajsne i gerung.
          </p>
          <div class="openings-header">
            <button id="btnAddDoor"     class="btn-small">‚ûï Vrata</button>
            <button id="btnAddWindow"   class="btn-small">‚ûï Prozor</button>
            <button id="btnAddNiche"    class="btn-small">‚ûï Ni≈°a</button>
            <button id="btnAddGeberit"  class="btn-small">‚ûï Geberit</button>
            <button id="btnAddVert"     class="btn-small">‚ûï Vertikala</button>
            <button id="btnAddCustom"   class="btn-small">‚ûï Custom otvor</button>
          </div>
          <div id="openingsList"></div>
        </div>

        <!-- Rezultati -->
        <div class="card" id="calcResult" style="display:none;">
          <h3>üìä Rezultati obraƒçuna</h3>
          <div id="calcOutput"></div>
        </div>

      </div>

    </div>
  </section>

  <!-- MODUL CIJENA -->
  <section id="pricesView" class="view">
    <div class="card">
      <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
      <h2>üí∂ Modul cijena</h2>
      <p style="font-size:12px;opacity:0.8;">
        Ovdje unosi≈° jediniƒçne cijene rada (‚Ç¨/m¬≤, ‚Ç¨/m, ‚Ç¨/kom). Te cijene se spremaju u Cloud i koriste u
        graƒëevinskoj knjizi i PDF-u.
      </p>
    </div>
    <div class="card">
      <div class="two-col">
        <label>Cijena poda (‚Ç¨/m¬≤)
          <input type="text" id="price_pod">
        </label>
        <label>Cijena zidova (‚Ç¨/m¬≤)
          <input type="text" id="price_zidovi">
        </label>
      </div>
      <div class="two-col">
        <label>Hidro ‚Äì pod (‚Ç¨/m¬≤)
          <input type="text" id="price_hidroPod">
        </label>
        <label>Hidro ‚Äì tu≈° (‚Ç¨/m¬≤)
          <input type="text" id="price_hidroTus">
        </label>
      </div>
      <div class="two-col">
        <label>Hidro traka (‚Ç¨/m)
          <input type="text" id="price_hidroTraka">
        </label>
        <label>Silikon (‚Ç¨/m)
          <input type="text" id="price_silikon">
        </label>
      </div>
      <div class="two-col">
        <label>Sokl (‚Ç¨/m)
          <input type="text" id="price_sokl">
        </label>
        <label>Stepenice ‚Äì du≈æni metri (‚Ç¨/m)
          <input type="text" id="price_stepeniceM">
        </label>
      </div>
      <div class="two-col">
        <label>Stepenice ‚Äì komad (‚Ç¨/kom)
          <input type="text" id="price_stepeniceKom">
        </label>
        <label>Lajsne (‚Ç¨/m)
          <input type="text" id="price_lajsne">
        </label>
      </div>
      <label>Gerung (‚Ç¨/m)
        <input type="text" id="price_gerung">
      </label>

      <button id="btnSavePrices">üíæ Spremi cjenik</button>
      <p id="pricesMsg" style="font-size:12px;margin-top:6px;opacity:0.8;"></p>
    </div>
  </section>
   <!-- MODUL TRO≈†KOVI -->
  <section id="costsView" class="view">
    <div class="card">
      <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
      <h2>üí∞ Modul tro≈°kovi</h2>
      <p style="font-size:12px;opacity:0.8;">
        Ovdje vodi≈° dodatne tro≈°kove (npr. prijevoz, najam skele, alat...).
        <b>Ovi tro≈°kovi se NE ukljuƒçuju u graƒëevinsku knjigu</b>, informativni su.
      </p>
    </div>
    <div class="card">
      <h3 style="font-size:14px;margin-top:0;">Popis tro≈°kova</h3>
      <div id="costsList"></div>

      <h3 style="font-size:13px;margin-top:14px;">Dodaj novi tro≈°ak</h3>
      <div class="two-col">
        <label>Naziv tro≈°ka
          <input type="text" id="costName" placeholder="npr. Prijevoz materijala">
        </label>
        <label>Iznos (EUR)
          <input type="text" id="costAmount" placeholder="npr. 50">
        </label>
      </div>
      <button id="btnAddCost">‚ûï Dodaj tro≈°ak</button>
      <p style="font-size:11px;opacity:0.7;margin-top:6px;">
        Tro≈°kovi se spremaju u tvoj korisniƒçki profil (Firebase) i ne ulaze u PDF obraƒçuna.
      </p>
    </div>
  </section>

  <!-- ARHIVA VIEW -->
  <section id="archiveView" class="view">
    <div class="card">
      <button class="secondary" onclick="showView('homeView')">‚Üê Natrag</button>
      <h2>üìÇ Arhiva obraƒçuna (Cloud)</h2>
      <p style="font-size:12px;opacity:0.8;">
        Popis svih spremljenih obraƒçuna. Svi prijavljeni korisnici vide sve zapise.
      </p>
    </div>
    <div class="card">
      <div id="archiveList"></div>
    </div>
  </section>

</main>

<script>
/* ---------------- FIREBASE INIT ---------------- */

const firebaseConfig = {
  apiKey: "AIzaSyDIuDJqFE3G2yk98WPwGHkc6xomWXUdu3o",
  authDomain: "kob-keramika.firebaseapp.com",
  projectId: "kob-keramika",
  storageBucket: "kob-keramika.firebasestorage.app",
  messagingSenderId: "604488601212",
  appId: "1:604488601212:web:70552af260d9e5a283c3f9",
  measurementId: "G-KDTBSP3H39"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const { jsPDF } = window.jspdf || {};

/* ---------------- GLOBAL STATE ---------------- */

let currentUser = null;

let UNIT_PRICES = {
  pod: 0,          // ‚Ç¨/m2
  zidovi: 0,       // ‚Ç¨/m2
  hidroPod: 0,     // ‚Ç¨/m2
  hidroTus: 0,     // ‚Ç¨/m2
  hidroTraka: 0,   // ‚Ç¨/m
  silikon: 0,      // ‚Ç¨/m
  sokl: 0,         // ‚Ç¨/m
  stepeniceM: 0,   // ‚Ç¨/m
  stepeniceKom: 0, // ‚Ç¨/kom
  lajsne: 0,       // ‚Ç¨/m
  gerung: 0        // ‚Ç¨/m
};

let openings = [];
let openingIdCounter = 1;
let lastCalc = null;
let roomsSet = []; // vi≈°e prostorija

const dmContainer = document.getElementById('dmContainer');
const silHeightsContainer = document.getElementById('silHeightsContainer');
const roomsCounterEl = document.getElementById('roomsCounter');

function parseNum(val) {
  if (val === undefined || val === null) return 0;
  let s = String(val).trim().replace(',', '.');
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}
function parseIntSafe(val) {
  if (val === undefined || val === null) return 0;
  let s = String(val).trim().replace(',', '.');
  const n = parseInt(s, 10);
  return isNaN(n) ? 0 : n;
}
function formatHr(n, dec = 3) {
  if (typeof n !== "number" || isNaN(n)) n = 0;
  return n.toFixed(dec).replace('.', ',');
}

function showView(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}
  /* ---------------- LOGIN UI ---------------- */

document.getElementById('btnLogin').onclick = async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  errEl.textContent = "";
  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch (e) {
    errEl.textContent = "Gre≈°ka: " + e.message;
  }
};

document.getElementById('btnRegister').onclick = async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const pass  = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  errEl.textContent = "";
  try {
    await auth.createUserWithEmailAndPassword(email, pass);
  } catch (e) {
    errEl.textContent = "Gre≈°ka: " + e.message;
  }
};

document.getElementById('btnLogout').onclick = () => auth.signOut();

// Auth state
auth.onAuthStateChanged(user => {
  currentUser = user;
  const userInfo = document.getElementById('userInfo');
  if (user) {
    userInfo.textContent = "Prijavljen: " + (user.email || "Korisnik");
    showView('homeView');
    loadPricesFromDb();
  } else {
    userInfo.textContent = "Nije prijavljen";
    showView('loginView');
  }
});

/* ---------------- NAVIGACIJA ---------------- */

document.getElementById('btnOpenAutoCalc').onclick = () => showView('autoCalcView');
document.getElementById('btnOpenArchive').onclick  = () => { showView('archiveView'); loadArchive(); };
document.getElementById('btnOpenPrices').onclick   = () => { showView('pricesView'); loadPricesFromDb(); };
document.getElementById('btnOpenCosts').onclick    = () => { showView('costsView'); loadCostsFromDb(); };
// Ruƒçni unos mjera u pripremi
document.getElementById('btnOpenMeasures').onclick = () => {
  alert("Ruƒçni unos mjera je jo≈° u pripremi.");
};

/* ---------------- POMOƒÜNE FUNKCIJE UI ---------------- */

const tileFormatSelect = document.getElementById('tileFormatSelect');
const tileCustomFields = document.getElementById('tileCustomFields');

tileFormatSelect.addEventListener('change', () => {
  const val = tileFormatSelect.value;
  if (val === 'custom') {
    tileCustomFields.style.display = 'block';
  } else {
    tileCustomFields.style.display = 'none';
    // mo≈æe≈° kasnije iskoristiti format za neku logiku ako ≈æeli≈°
  }
});

// prikaz/skrivanje kartica po checkboxovima
function toggleCard(chkId, cardId) {
  const chk = document.getElementById(chkId);
  const card = document.getElementById(cardId);
  const update = () => {
    card.style.display = chk.checked ? 'block' : 'none';
  };
  chk.addEventListener('change', update);
  update();
}

toggleCard('chkHidroTus', 'cardTus');
toggleCard('chkSilikon', 'cardSilikon');
toggleCard('chkSokl', 'cardSokl');
toggleCard('chkStepenice', 'cardStepenice');
toggleCard('chkLajsne', 'cardLajsne');
toggleCard('chkGerung', 'cardGerung');
toggleCard('chkDodatne', 'cardDodatne');

/* ---------------- SILIKON ‚Äì VISINE ---------------- */

document.getElementById('btnAddHeight').addEventListener('click', () => {
  if (!silHeightsContainer) return;
  const row = document.createElement('div');
  row.className = 'height-row';
  row.innerHTML = `
    <input type="text" class="silHeightVal" placeholder="npr. 0,90">
    <button type="button" class="btn-small secondary">üóë</button>
  `;
  const btn = row.querySelector('button');
  btn.addEventListener('click', () => row.remove());
  silHeightsContainer.appendChild(row);
});

/* ---------------- DODATNE MJERE ---------------- */

document.getElementById('btnAddDmRow').addEventListener('click', () => {
  if (!dmContainer) return;
  const count = dmContainer.querySelectorAll('.dm-row').length;
  if (count >= 10) {
    alert("Maksimalno 10 dodatnih mjera.");
    return;
  }
  const row = document.createElement('div');
  row.className = 'dm-row';
  row.innerHTML = `
    <input type="text" class="dmName" placeholder="npr. Ni≈°a dodatno">
    <input type="text" class="dmVal" placeholder="m2 ili m">
    <select class="dmSign">
      <option value="+">+</option>
      <option value="-">-</option>
    </select>
    <button type="button" class="btn-small secondary">üóë</button>
  `;
  const btn = row.querySelector('button');
  btn.addEventListener('click', () => row.remove());
  dmContainer.appendChild(row);
});
  /* ---------------- OTVORI ---------------- */

function openingLabel(type) {
  switch (type) {
    case 'vrata':   return 'Vrata';
    case 'prozor':  return 'Prozor';
    case 'nisa':    return 'Ni≈°a';
    case 'geberit': return 'Geberit';
    case 'vert':    return 'Vertikala';
    default:        return 'Custom otvor';
  }
}

function addOpening(type) {
  const label = openingLabel(type);
  const w = parseNum(prompt(`≈†irina (m) za ${label}:`, "0,90"));
  const h = parseNum(prompt(`Visina (m) za ${label}:`, "2,10"));
  const count = parseIntSafe(prompt(`Broj komada za ${label}:`, "1"));
  if (!w || !h || !count) {
    alert("Neispravan unos.");
    return;
  }
  const subtract = (type === 'vrata' || type === 'prozor' || type === 'nisa'); // za zidove
  const o = {
    id: "o" + (openingIdCounter++),
    type,
    label,
    w,
    h,
    count,
    subtract
  };
  openings.push(o);
  renderOpenings();
}

function openingArea(o) {
  return (o.w || 0) * (o.h || 0) * (o.count || 0);
}
function openingPerim(o) {
  return 2 * ((o.w || 0) + (o.h || 0)) * (o.count || 0);
}

function deleteOpening(id) {
  openings = openings.filter(o => o.id !== id);
  renderOpenings();
}

function renderOpenings() {
  const list = document.getElementById('openingsList');
  if (!list) return;
  if (!openings.length) {
    list.innerHTML = "<p style='font-size:12px;opacity:0.7;'>Jo≈° nema unesenih otvora.</p>";
    return;
  }
  let html = "";
  openings.forEach(o => {
    html += `
      <div class="opening-card">
        <div class="opening-title">${o.label}</div>
        <div class="opening-meta">
          <span class="tag">S = ${formatHr(o.w, 3)} m</span>
          <span class="tag">V = ${formatHr(o.h, 3)} m</span>
          <span class="tag">Kom = ${o.count}</span>
          <span class="tag">P = ${formatHr(openingArea(o), 3)} m¬≤</span>
          <span class="tag">Obod = ${formatHr(openingPerim(o), 3)} m</span>
          <span class="tag">Odbija zidove: ${o.subtract ? 'DA' : 'NE'}</span>
          <span class="tag">Za silikon: ${o.type === 'vrata' ? 'NE' : 'DA (osim vrata)'}</span>
          <span class="tag">Za hidro traku: ${(o.type === 'prozor' || o.type === 'nisa') ? 'DA' : 'NE'}</span>
        </div>
        <div class="opening-actions">
          <button class="btn-small secondary" onclick="deleteOpening('${o.id}')">üóë Obri≈°i</button>
        </div>
      </div>
    `;
  });
  list.innerHTML = html;
}

document.getElementById('btnAddDoor').onclick    = () => addOpening('vrata');
document.getElementById('btnAddWindow').onclick  = () => addOpening('prozor');
document.getElementById('btnAddGeberit').onclick = () => addOpening('geberit');
document.getElementById('btnAddNiche').onclick   = () => addOpening('nisa');
document.getElementById('btnAddVert').onclick    = () => addOpening('vert');
document.getElementById('btnAddCustom').onclick  = () => addOpening('custom');

/* ---------------- AUTOMATSKI OBRAƒåUN ---------------- */

function updateRoomsCounter() {
  if (roomsCounterEl) roomsCounterEl.textContent = roomsSet.length.toString();
}

function runAutoCalc(showHtml) {
  const meta = {
    siteName: document.getElementById('siteName').value.trim(),
    roomName: document.getElementById('roomName').value.trim(),
    situationNo: document.getElementById('situationNo').value.trim(),
    investorName: document.getElementById('investorName').value.trim()
  };

  const tileVal = tileFormatSelect.value;
  let tileFormat = { wcm: null, hcm: null };
  if (!tileVal) {
    alert("Odaberi format ploƒçice.");
    return null;
  }
  if (tileVal === 'custom') {
    const wcm = parseNum(document.getElementById('tileW').value);
    const hcm = parseNum(document.getElementById('tileH').value);
    if (!wcm || !hcm) {
      alert("Unesi ruƒçni format ploƒçice.");
      return null;
    }
    tileFormat = { wcm, hcm };
  } else {
    const [wcmStr, hcmStr] = tileVal.split('x');
    tileFormat = { wcm: parseNum(wcmStr), hcm: parseNum(hcmStr) };
  }

  const D = parseNum(document.getElementById('dimD').value);
  const S = parseNum(document.getElementById('dimS').value);
  const V = parseNum(document.getElementById('dimV').value);

  if (!D || !S || !V) {
    alert("Unesi osnovne dimenzije D, ≈† i V.");
    return null;
  }

  const chkPod       = document.getElementById('chkPod').checked;
  const chkZidovi    = document.getElementById('chkZidovi').checked;
  const chkHidroPod  = document.getElementById('chkHidroPod').checked;
  const chkHidroTus  = document.getElementById('chkHidroTus').checked;
  const chkHidroTrak = document.getElementById('chkHidroTraka').checked;
  const chkSilikon   = document.getElementById('chkSilikon').checked;
  const chkSokl      = document.getElementById('chkSokl').checked;
  const chkStepenice = document.getElementById('chkStepenice').checked;
  const chkLajsne    = document.getElementById('chkLajsne').checked;
  const chkGerung    = document.getElementById('chkGerung').checked;
  const chkDodatne   = document.getElementById('chkDodatne').checked;

  let html = "";
  const results = {};
  const prices = {};
  const gkLines = [];

  gkLines.push("1. Osnovni podaci");
  gkLines.push(`Gradili≈°te: ${meta.siteName || '-'}`);
  gkLines.push(`Prostorija: ${meta.roomName || '-'}`);
  gkLines.push(`Situacija: ${meta.situationNo || '-'}`);
  gkLines.push(`Investitor: ${meta.investorName || '-'}`);
  gkLines.push("");

  html += `<b>Osnovni podaci:</b><br>`;
  html += `Gradili≈°te: ${meta.siteName || '-'}<br>`;
  html += `Prostorija: ${meta.roomName || '-'}<br>`;
  html += `Situacija: ${meta.situationNo || '-'}<br>`;
  html += `Investitor: ${meta.investorName || '-'}<br><br>`;

  html += `<b>Dimenzije prostorije:</b><br>`;
  html += `D = ${formatHr(D)} m, ≈† = ${formatHr(S)} m, V = ${formatHr(V)} m<br><br>`;

  gkLines.push("2. Dimenzije prostorije");
  gkLines.push(`D = ${formatHr(D)} m`);
  gkLines.push(`≈† = ${formatHr(S)} m`);
  gkLines.push(`V = ${formatHr(V)} m`);
  gkLines.push("");

  // POD
  if (chkPod) {
    const pod = D * S;
    results.pod = pod;

    html += `<b>Pod:</b><br>`;
    html += `P = D√ó≈† = ${formatHr(D)}√ó${formatHr(S)} = <b>${formatHr(pod)} m¬≤</b><br><br>`;

    gkLines.push("3. Pod");
    gkLines.push(`P = ${formatHr(pod)} m¬≤`);
    gkLines.push("");

    prices.pod = { qty: pod, unit: "m¬≤", price: UNIT_PRICES.pod };
  }

  // ZIDOVI
  if (chkZidovi) {
    const zidBruto = 2 * D * V + 2 * S * V;
    let odbijVrata = 0;
    openings.forEach(o => {
      if (o.type === 'vrata' && o.subtract) odbijVrata += openingArea(o);
    });
    const zidNeto = zidBruto - odbijVrata;
    results.zidoviBruto = zidBruto;
    results.zidoviNeto = zidNeto;
    results.zidoviOdbijVrata = odbijVrata;

    html += `<b>Zidovi:</b><br>`;
    html += `Bruto = 2√óD√óV + 2√ó≈†√óV = 2√ó${formatHr(D)}√ó${formatHr(V)} + 2√ó${formatHr(S)}√ó${formatHr(V)} = ${formatHr(zidBruto)} m¬≤<br>`;
    html += `Odbijanje vrata = ${formatHr(odbijVrata)} m¬≤<br>`;
    html += `Neto zidovi = <b>${formatHr(zidNeto)} m¬≤</b><br><br>`;

    gkLines.push("4. Zidovi");
    gkLines.push(`Bruto = ${formatHr(zidBruto)} m¬≤`);
    gkLines.push(`Odbijanje vrata = ${formatHr(odbijVrata)} m¬≤`);
    gkLines.push(`Neto = ${formatHr(zidNeto)} m¬≤`);
    gkLines.push("");

    prices.zidovi = { qty: zidNeto, unit: "m¬≤", price: UNIT_PRICES.zidovi };
  }
    // HIDRO POD
  if (chkHidroPod) {
    const hidroPod = D * S;
    results.hidroPod = hidroPod;

    html += `<b>Hidroizolacija ‚Äì pod:</b><br>`;
    html += `P = ${formatHr(hidroPod)} m¬≤<br><br>`;

    gkLines.push("5. Hidro ‚Äì pod");
    gkLines.push(`P = ${formatHr(hidroPod)} m¬≤`);
    gkLines.push("");

    prices.hidroPod = { qty: hidroPod, unit: "m¬≤", price: UNIT_PRICES.hidroPod };
  }

  // HIDRO TU≈†
  if (chkHidroTus) {
    const dTus = parseNum(document.getElementById('tusD').value) || D;
    const sTus = parseNum(document.getElementById('tusS').value) || S;
    const vTus = parseNum(document.getElementById('tusV').value) || V;
    const hidroTus = (2 * dTus + sTus) * vTus;
    results.hidroTus = hidroTus;
    results.hidroTusData = { dTus, sTus, vTus };

    html += `<b>Hidroizolacija ‚Äì tu≈°:</b><br>`;
    html += `Formula: (2√ód + ≈°) √ó v = (2√ó${formatHr(dTus)} + ${formatHr(sTus)}) √ó ${formatHr(vTus)} = <b>${formatHr(hidroTus)} m¬≤</b><br><br>`;

    gkLines.push("6. Hidro ‚Äì tu≈° zona");
    gkLines.push(`(2√ó${formatHr(dTus)} + ${formatHr(sTus)}) √ó ${formatHr(vTus)} = ${formatHr(hidroTus)} m¬≤`);
    gkLines.push("");

    prices.hidroTus = { qty: hidroTus, unit: "m¬≤", price: UNIT_PRICES.hidroTus };
  }

  // HIDRO TRAKA
  if (chkHidroTrak) {
    // osnovno: opseg poda
    let traka = 2 * (D + S);
    // + oko prozora i ni≈°a
    let extra = 0;
    openings.forEach(o => {
      if (o.type === 'prozor' || o.type === 'nisa') {
        extra += openingPerim(o);
      }
    });
    traka += extra;
    results.hidroTraka = traka;
    results.hidroTrakaExtra = extra;

    html += `<b>Hidro traka:</b><br>`;
    html += `Osnovno (pod) = 2√ó(D+≈†) = 2√ó(${formatHr(D)}+${formatHr(S)}) = ${formatHr(2*(D+S))} m<br>`;
    html += `+ rubovi prozora/ni≈°a = ${formatHr(extra)} m<br>`;
    html += `Ukupno hidro traka = <b>${formatHr(traka)} m</b><br><br>`;

    gkLines.push("7. Hidro traka");
    gkLines.push(`Osnovno: ${formatHr(2*(D+S))} m`);
    gkLines.push(`Prozori/ni≈°e: ${formatHr(extra)} m`);
    gkLines.push(`Ukupno: ${formatHr(traka)} m`);
    gkLines.push("");

    prices.hidroTraka = { qty: traka, unit: "m", price: UNIT_PRICES.hidroTraka };
  }

  // SILIKON
  if (chkSilikon) {
    let baseSil = 2 * D + 2 * S + 4 * V;
    let extraHeights = 0;
    const rows = silHeightsContainer.querySelectorAll('.height-row');
    rows.forEach(row => {
      const val = parseNum(row.querySelector('.silHeightVal').value);
      extraHeights += val;
    });
    let openingsSil = 0;
    openings.forEach(o => {
      if (o.type !== 'vrata') openingsSil += openingPerim(o);
    });
    const silikon = baseSil + extraHeights + openingsSil;
    results.silikon = silikon;
    results.silikonData = { baseSil, extraHeights, openingsSil };

    html += `<b>Silikon:</b><br>`;
    html += `Osnovno = 2√óD + 2√ó≈† + 4√óV = 2√ó${formatHr(D)} + 2√ó${formatHr(S)} + 4√ó${formatHr(V)} = ${formatHr(baseSil)} m<br>`;
    html += `+ dodatne visine = ${formatHr(extraHeights)} m<br>`;
    html += `+ rubovi svih otvora osim vrata = ${formatHr(openingsSil)} m<br>`;
    html += `Ukupno silikon = <b>${formatHr(silikon)} m</b><br><br>`;

    gkLines.push("8. Silikon");
    gkLines.push(`Osnovno: ${formatHr(baseSil)} m`);
    gkLines.push(`Dodatne visine: ${formatHr(extraHeights)} m`);
    gkLines.push(`Otvor(i): ${formatHr(openingsSil)} m`);
    gkLines.push(`Ukupno: ${formatHr(silikon)} m`);
    gkLines.push("");

    prices.silikon = { qty: silikon, unit: "m", price: UNIT_PRICES.silikon };
  }

  // SOKL
  if (chkSokl) {
    const osnovni = 2 * (D + S);
    const minus = parseNum(document.getElementById('soklMinus').value);
    const plus  = parseNum(document.getElementById('soklPlus').value);
    const sokl = osnovni - minus + plus;
    results.sokl = sokl;
    results.soklData = { osnovni, minus, plus };

    html += `<b>Sokl:</b><br>`;
    html += `Osnovni opseg = 2√ó(D+≈†) = 2√ó(${formatHr(D)}+${formatHr(S)}) = ${formatHr(osnovni)} m<br>`;
    html += `‚àí odbijanje = ${formatHr(minus)} m<br>`;
    html += `+ dodatno = ${formatHr(plus)} m<br>`;
    html += `Ukupno sokl = <b>${formatHr(sokl)} m</b><br><br>`;

    gkLines.push("9. Sokl");
    gkLines.push(`Osnovno: ${formatHr(osnovni)} m`);
    gkLines.push(`Odbijanje: ${formatHr(minus)} m`);
    gkLines.push(`Dodatno: ${formatHr(plus)} m`);
    gkLines.push(`Ukupno: ${formatHr(sokl)} m`);
    gkLines.push("");

    prices.sokl = { qty: sokl, unit: "m", price: UNIT_PRICES.sokl };
  }

  // STEPENICE
  if (chkStepenice) {
    const sw = parseNum(document.getElementById('stepWidth').value);
    const sc = parseIntSafe(document.getElementById('stepCount').value);
    const mode = document.getElementById('stepMode').value || 'duzni';
    const stepeniceVal = sw * sc;

    results.stepenice = { vrijednost: stepeniceVal, mode, sw, sc };

    html += `<b>Stepenice:</b><br>`;
    html += `≈†irina √ó komada = ${formatHr(sw)} √ó ${sc} = <b>${formatHr(stepeniceVal)} ${mode === 'duzni' ? 'm' : 'kom'}</b><br><br>`;

    gkLines.push("10. Stepenice");
    gkLines.push(`≈†irina: ${formatHr(sw)} m`);
    gkLines.push(`Komada: ${sc}`);
    gkLines.push(`Ukupno: ${formatHr(stepeniceVal)} ${mode === 'duzni' ? 'm' : 'kom'}`);
    gkLines.push("");

    if (mode === 'duzni') {
      prices.stepeniceM = { qty: stepeniceVal, unit: "m", price: UNIT_PRICES.stepeniceM };
    } else {
      prices.stepeniceKom = { qty: sc, unit: "kom", price: UNIT_PRICES.stepeniceKom };
    }
  }

  // LAJSNE
  if (chkLajsne) {
    const L1 = parseNum(document.getElementById('l1').value);
    const L2 = parseNum(document.getElementById('l2').value);
    const L3 = parseNum(document.getElementById('l3').value);
    const baseL = L1 + L2 + L3;

    const lProzor = document.getElementById('lProzor').checked;
    const lNisa   = document.getElementById('lNisa').checked;
    const lGeb    = document.getElementById('lGeberit').checked;
    const lVert   = document.getElementById('lVert').checked;

    let perimLajsne = 0;
    openings.forEach(o => {
      if (o.type === 'prozor' && lProzor) perimLajsne += openingPerim(o);
      if (o.type === 'nisa'   && lNisa)   perimLajsne += openingPerim(o);
      if (o.type === 'geberit'&& lGeb)    perimLajsne += openingPerim(o);
      if (o.type === 'vert'   && lVert)   perimLajsne += openingPerim(o);
    });

    const lajsne = baseL + perimLajsne;
    results.lajsne = lajsne;
    results.lajsneData = { baseL, perimLajsne };

    html += `<b>Lajsne:</b><br>`;
    html += `Ruƒçno = ${formatHr(baseL)} m<br>`;
    html += `Rubovi prozor/ni≈°a/geberit/vertikale (prema kvaƒçicama) = ${formatHr(perimLajsne)} m<br>`;
    html += `Ukupno lajsne = <b>${formatHr(lajsne)} m</b><br><br>`;

    gkLines.push("11. Lajsne");
    gkLines.push(`Ruƒçno: ${formatHr(baseL)} m`);
    gkLines.push(`Elementi: ${formatHr(perimLajsne)} m`);
    gkLines.push(`Ukupno: ${formatHr(lajsne)} m`);
    gkLines.push("");

    prices.lajsne = { qty: lajsne, unit: "m", price: UNIT_PRICES.lajsne };
  }
    // GERUNG
  if (chkGerung) {
    const G1 = parseNum(document.getElementById('g1').value);
    const G2 = parseNum(document.getElementById('g2').value);
    const G3 = parseNum(document.getElementById('g3').value);
    const baseG = G1 + G2 + G3;

    const gProzor = document.getElementById('gProzor').checked;
    const gNisa   = document.getElementById('gNisa').checked;
    const gGeb    = document.getElementById('gGeberit').checked;
    const gVert   = document.getElementById('gVert').checked;

    let perimGerung = 0;
    openings.forEach(o => {
      if (o.type === 'prozor' && gProzor) perimGerung += openingPerim(o);
      if (o.type === 'nisa'   && gNisa)   perimGerung += openingPerim(o);
      if (o.type === 'geberit'&& gGeb)    perimGerung += openingPerim(o);
      if (o.type === 'vert'   && gVert)   perimGerung += openingPerim(o);
    });

    const gerung = baseG + perimGerung;
    results.gerung = gerung;
    results.gerungData = { baseG, perimGerung };

    html += `<b>Gerung:</b><br>`;
    html += `Ruƒçno = ${formatHr(baseG)} m<br>`;
    html += `Rubovi prozor/ni≈°a/geberit/vertikale (prema kvaƒçicama) = ${formatHr(perimGerung)} m<br>`;
    html += `Ukupno gerung = <b>${formatHr(gerung)} m</b><br><br>`;

    gkLines.push("12. Gerung");
    gkLines.push(`Ruƒçno: ${formatHr(baseG)} m`);
    gkLines.push(`Elementi: ${formatHr(perimGerung)} m`);
    gkLines.push(`Ukupno: ${formatHr(gerung)} m`);
    gkLines.push("");

    prices.gerung = { qty: gerung, unit: "m", price: UNIT_PRICES.gerung };
  }

  // DODATNE MJERE
  let dmTotal = 0;
  let dmRowsData = [];
  if (chkDodatne) {
    const rows = dmContainer.querySelectorAll('.dm-row');
    rows.forEach(row => {
      const name = row.querySelector('.dmName').value || '';
      const val = parseNum(row.querySelector('.dmVal').value);
      const sign = row.querySelector('.dmSign').value;
      const signedVal = sign === '-' ? -val : val;
      dmTotal += signedVal;
      dmRowsData.push({ name, val, sign, signedVal });
    });

    const dmPod  = document.getElementById('dmPod').checked;
    const dmZid  = document.getElementById('dmZidovi').checked;
    const dmHid  = document.getElementById('dmHidro').checked;
    const dmSil  = document.getElementById('dmSil').checked;
    const dmTrak = document.getElementById('dmTraka').checked;
    const dmSok  = document.getElementById('dmSokl').checked;

    html += `<b>Dodatne mjere (+/‚àí):</b><br>`;
    if (!dmRowsData.length) {
      html += `Nema unesenih dodatnih mjera.<br><br>`;
    } else {
      dmRowsData.forEach((r, idx) => {
        html += `${idx+1}. ${r.name || 'Mjera'}: ${r.sign}${formatHr(r.val)} ‚áí ${formatHr(r.signedVal)}<br>`;
      });
      html += `Ukupno dodatne mjere = <b>${formatHr(dmTotal)}</b><br><br>`;
    }

    if (dmTotal !== 0) {
      if (dmPod && results.pod != null)             results.pod        += dmTotal;
      if (dmZid && results.zidoviNeto != null)      results.zidoviNeto += dmTotal;
      if (dmHid && results.hidroPod != null)        results.hidroPod   += dmTotal;
      if (dmSil && results.silikon != null)         results.silikon    += dmTotal;
      if (dmTrak && results.hidroTraka != null)     results.hidroTraka += dmTotal;
      if (dmSok && results.sokl != null)            results.sokl       += dmTotal;
    }

    results.dm = { total: dmTotal, rows: dmRowsData };

    gkLines.push("13. Dodatne mjere");
    dmRowsData.forEach((r, idx) => {
      gkLines.push(`${idx+1}. ${r.name || 'Mjera'}: ${r.sign}${formatHr(r.val)} ‚áí ${formatHr(r.signedVal)}`);
    });
    gkLines.push(`Ukupno: ${formatHr(dmTotal)}`);
    gkLines.push("");
  }

  // Otvori
  if (openings.length) {
    gkLines.push("14. Otvori ‚Äì specifikacija");
    openings.forEach(o => {
      gkLines.push(`- ${o.label}: tip=${o.type}, S=${formatHr(o.w)} m, V=${formatHr(o.h)} m, kom=${o.count}, ` +
                   `povr≈°ina=${formatHr(openingArea(o))} m¬≤, obod=${formatHr(openingPerim(o))} m, ` +
                   `odbijanje zidova=${o.subtract ? 'DA' : 'NE'}`);
    });
    gkLines.push("");
  }

  lastCalc = {
    D, S, V,
    meta,
    tileFormat,
    openings: JSON.parse(JSON.stringify(openings)),
    results,
    prices,
    gkLines,
    createdAt: new Date().toISOString()
  };

  if (showHtml) {
    document.getElementById('calcOutput').innerHTML = html;
    document.getElementById('calcResult').style.display = 'block';
  }

  return lastCalc;
}

document.getElementById('btnCalcNow').addEventListener('click', () => {
  runAutoCalc(true);
});

/* ---------------- VI≈†E PROSTORIJA ---------------- */

document.getElementById('btnAddRoomToSet').addEventListener('click', () => {
  const calc = runAutoCalc(false);
  if (!calc) return;
  roomsSet.push(calc);
  updateRoomsCounter();
  alert("Prostorija dodana u skup za graƒëevinsku knjigu.");
});

document.getElementById('btnClearRoomsSet').addEventListener('click', () => {
  if (!confirm("Stvarno ≈æeli≈° obrisati sve dodane prostorije iz skupa?")) return;
  roomsSet = [];
  updateRoomsCounter();
});
  /* ---------------- MODUL CIJENA (Firestore) ---------------- */

function fillPricesFormFromState() {
  const map = {
    pod: "price_pod",
    zidovi: "price_zidovi",
    hidroPod: "price_hidroPod",
    hidroTus: "price_hidroTus",
    hidroTraka: "price_hidroTraka",
    silikon: "price_silikon",
    sokl: "price_sokl",
    stepeniceM: "price_stepeniceM",
    stepeniceKom: "price_stepeniceKom",
    lajsne: "price_lajsne",
    gerung: "price_gerung"
  };
  Object.keys(map).forEach(key => {
    const el = document.getElementById(map[key]);
    if (!el) return;
    const val = UNIT_PRICES[key] || 0;
    el.value = val ? String(val).replace('.', ',') : "";
  });
}

async function loadPricesFromDb() {
  if (!currentUser) {
    fillPricesFormFromState();
    return;
  }
  try {
    const docRef = db.collection('users')
      .doc(currentUser.uid)
      .collection('settings')
      .doc('cjenik');
    const snap = await docRef.get();
    if (snap.exists) {
      const data = snap.data() || {};
      UNIT_PRICES = {
        ...UNIT_PRICES,
        ...data
      };
    }
  } catch (e) {
    console.error("Gre≈°ka pri uƒçitavanju cjenika:", e);
  }
  fillPricesFormFromState();
}

document.getElementById('btnSavePrices').addEventListener('click', async () => {
  if (!currentUser) {
    alert("Mora≈° biti prijavljen da bi spremio cjenik.");
    return;
  }
  const msgEl = document.getElementById('pricesMsg');
  msgEl.textContent = "";
  const map = {
    pod: "price_pod",
    zidovi: "price_zidovi",
    hidroPod: "price_hidroPod",
    hidroTus: "price_hidroTus",
    hidroTraka: "price_hidroTraka",
    silikon: "price_silikon",
    sokl: "price_sokl",
    stepeniceM: "price_stepeniceM",
    stepeniceKom: "price_stepeniceKom",
    lajsne: "price_lajsne",
    gerung: "price_gerung"
  };
  Object.keys(map).forEach(key => {
    const el = document.getElementById(map[key]);
    if (!el) return;
    const v = parseNum(el.value);
    UNIT_PRICES[key] = v;
  });

  try {
    await db.collection('users')
      .doc(currentUser.uid)
      .collection('settings')
      .doc('cjenik')
      .set(UNIT_PRICES, { merge: true });
    msgEl.textContent = "Cjenik spremljen.";
  } catch (e) {
    console.error(e);
    msgEl.textContent = "Gre≈°ka pri spremanju cjenika.";
  }
});

/* ---------------- MODUL TRO≈†KOVI ---------------- */

function renderCostsList(items) {
  const list = document.getElementById('costsList');
  if (!list) return;
  if (!items.length) {
    list.innerHTML = "<p style='font-size:12px;opacity:0.8;'>Jo≈° nema unesenih tro≈°kova.</p>";
    return;
  }
  let html = "";
  items.forEach(item => {
    const d = item.data;
    const id = item.id;
    const amount = parseNum(d.amount);
    const name = d.name || "Tro≈°ak";
    const dt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
    const dateStr = dt ? dt.toLocaleDateString('hr-HR') : "";
    html += `
      <div class="archive-list-item">
        <div><b>${name}</b> ‚Äì ${formatHr(amount, 2)} EUR</div>
        <div style="font-size:11px;opacity:0.7;">${dateStr}</div>
        <div class="archive-actions">
          <button class="btn-small secondary" onclick="deleteCost('${id}')">üóë Obri≈°i</button>
        </div>
      </div>
    `;
  });
  list.innerHTML = html;
}

async function loadCostsFromDb() {
  const list = document.getElementById('costsList');
  if (!currentUser) {
    if (list) {
      list.innerHTML = "<p style='font-size:12px;opacity:0.8;'>Prijavi se da vidi≈° tro≈°kove.</p>";
    }
    return;
  }
  try {
    const snap = await db.collection('users')
      .doc(currentUser.uid)
      .collection('troskovi')
      .orderBy('createdAt', 'desc')
      .get();
    const items = [];
    snap.forEach(doc => items.push({ id: doc.id, data: doc.data() }));
    renderCostsList(items);
  } catch (e) {
    console.error("Gre≈°ka pri uƒçitavanju tro≈°kova:", e);
  }
}

document.getElementById('btnAddCost').addEventListener('click', async () => {
  if (!currentUser) {
    alert("Mora≈° biti prijavljen da bi dodao tro≈°ak.");
    return;
  }
  const nameEl = document.getElementById('costName');
  const amountEl = document.getElementById('costAmount');
  const name = (nameEl.value || "").trim();
  const amount = parseNum(amountEl.value);
  if (!name || !amount) {
    alert("Unesi naziv i iznos tro≈°ka.");
    return;
  }
  try {
    await db.collection('users')
      .doc(currentUser.uid)
      .collection('troskovi')
      .add({
        name,
        amount,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    nameEl.value = "";
    amountEl.value = "";
    loadCostsFromDb();
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri spremanju tro≈°ka.");
  }
});

async function deleteCost(id) {
  if (!currentUser) return;
  if (!confirm("Obrisati ovaj tro≈°ak?")) return;
  try {
    await db.collection('users')
      .doc(currentUser.uid)
      .collection('troskovi')
      .doc(id)
      .delete();
    loadCostsFromDb();
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri brisanju tro≈°ka.");
  }
}

/* ---------------- PDF / CSV ---------------- */

function buildPdfForRooms(rooms) {
  if (!jsPDF) {
    alert("jsPDF nije pravilno uƒçitan.");
    return null;
  }
  const doc = new jsPDF('p', 'mm', 'a4');
  let y = 15;

  function newPage() {
    doc.addPage();
    y = 15;
  }

  function writeLine(text, indent = 0) {
    const x = 10 + indent;
    const lines = doc.splitTextToSize(text, 190 - indent);
    lines.forEach(line => {
      if (y > 280) newPage();
      doc.text(line, x, y);
      y += 5;
    });
  }

  doc.setFontSize(14);
  doc.text("KOB-Keramika ‚Äì Graƒëevinska knjiga", 10, y);
  y += 8;
  doc.setFontSize(11);

  rooms.forEach((room, idx) => {
    if (idx > 0) {
      newPage();
      doc.setFontSize(14);
      doc.text("KOB-Keramika ‚Äì Graƒëevinska knjiga", 10, y);
      y += 8;
      doc.setFontSize(11);
    }

    writeLine(`Prostorija ${idx+1}: ${room.meta.roomName || '-'}`, 0);
    writeLine(`Gradili≈°te: ${room.meta.siteName || '-'}`, 2);
    writeLine(`Situacija: ${room.meta.situationNo || '-'}`, 2);
    writeLine(`Investitor: ${room.meta.investorName || '-'}`, 2);
    writeLine(`Dimenzije: D=${formatHr(room.D)} m, ≈†=${formatHr(room.S)} m, V=${formatHr(room.V)} m`, 2);
    writeLine(`Format ploƒçice: ${room.tileFormat.wcm} √ó ${room.tileFormat.hcm} cm`, 2);
    y += 3;

    (room.gkLines || []).forEach(line => {
      if (!line) {
        y += 2;
      } else {
        writeLine(line, 2);
      }
    });

    // Financijski dio po prostoriji
    const p = room.prices || {};
    const priceRows = [];
    function addPriceRow(name, key) {
      const item = p[key];
      if (!item || !item.qty || !UNIT_PRICES[key]) return;
      const qty = item.qty;
      const unit = item.unit;
      const pr  = UNIT_PRICES[key];
      const total = qty * pr;
      priceRows.push({ name, qty, unit, pr, total });
    }

    addPriceRow("Pod", "pod");
    addPriceRow("Zidovi", "zidovi");
    addPriceRow("Hidro pod", "hidroPod");
    addPriceRow("Hidro tu≈°", "hidroTus");
    addPriceRow("Hidro traka", "hidroTraka");
    addPriceRow("Silikon", "silikon");
    addPriceRow("Sokl", "sokl");
    addPriceRow("Stepenice (m)", "stepeniceM");
    addPriceRow("Stepenice (kom)", "stepeniceKom");
    addPriceRow("Lajsne", "lajsne");
    addPriceRow("Gerung", "gerung");

    if (priceRows.length) {
      let ukupno = 0;
      priceRows.forEach(rp => ukupno += rp.total);

      y += 4;
      if (y > 260) newPage();
      doc.setFontSize(12);
      writeLine("Financijski obraƒçun ove prostorije", 0);
      doc.setFontSize(11);
      if (y > 280) newPage();
      doc.text("Stavka", 10, y);
      doc.text("Koliƒçina", 70, y);
      doc.text("Jed.", 100, y);
      doc.text("Cijena", 120, y);
      doc.text("Ukupno", 160, y);
      y += 5;

      priceRows.forEach(rp => {
        if (y > 280) newPage();
        doc.text(rp.name, 10, y);
        doc.text(formatHr(rp.qty), 70, y);
        doc.text(rp.unit, 100, y);
        doc.text(formatHr(rp.pr, 2), 120, y);
        doc.text(formatHr(rp.total, 2), 160, y);
        y += 5;
      });
      y += 4;
      writeLine(`UKUPNO prostorija ${idx+1}: ${formatHr(ukupno, 2)} EUR`, 2);
    }
  });

  y += 6;
  if (y > 270) newPage();
  writeLine("Napomena: obraƒçun je informativan ‚Äì konaƒçna faktura mo≈æe imati dodatne stavke (priprema podloge, prijevoz, materijal itd.).", 0);

  return doc;
}

function exportPdfForCurrent() {
  const rooms = roomsSet.length ? roomsSet.slice() : [];
  if (!rooms.length) {
    const calc = runAutoCalc(false);
    if (!calc) return;
    rooms.push(calc);
  }
  const doc = buildPdfForRooms(rooms);
  if (!doc) return;
  const meta = rooms[0].meta || {};
  const fileName = `GK_${(meta.siteName || 'gradiliste').replace(/\s+/g,'_')}_${Date.now()}.pdf`;
  doc.save(fileName);
}

function exportCsvForCurrent() {
  const rooms = roomsSet.length ? roomsSet.slice() : [];
  if (!rooms.length) {
    const calc = runAutoCalc(false);
    if (!calc) return;
    rooms.push(calc);
  }
  let csv = "Prostorija;Stavka;Kolicina;Jedinica\n";
  rooms.forEach((room, idx) => {
    const r = room.results || {};
    const rn = room.meta.roomName || `Prostorija ${idx+1}`;
    function add(name, val, unit) {
      if (val == null) return;
      csv += `${rn};${name};${formatHr(val)};${unit}\n`;
    }
    add("Pod", r.pod, "m2");
    add("Zidovi (neto)", r.zidoviNeto, "m2");
    add("Hidro pod", r.hidroPod, "m2");
    add("Hidro tus zona", r.hidroTus, "m2");
    add("Hidro traka", r.hidroTraka, "m");
    add("Silikon", r.silikon, "m");
    add("Sokl", r.sokl, "m");
    if (r.stepenice && r.stepenice.mode === 'duzni') {
      add("Stepenice (m)", r.stepenice.vrijednost, "m");
    } else if (r.stepenice) {
      add("Stepenice (kom)", r.stepenice.sc, "kom");
    }
    add("Lajsne", r.lajsne, "m");
    add("Gerung", r.gerung, "m");
  });
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "obracun.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

document.getElementById('btnExportPdfAuto').addEventListener('click', exportPdfForCurrent);
document.getElementById('btnExportCsvAuto').addEventListener('click', exportCsvForCurrent);

/* ---------------- SPREMANJE U CLOUD / ARHIVA ---------------- */

async function saveToCloud() {
  if (!currentUser) {
    alert("Mora≈° biti prijavljen da bi spremio u Cloud.");
    return;
  }
  const rooms = roomsSet.length ? roomsSet.slice() : [];
  let calcUsed = null;
  if (!rooms.length) {
    const calc = runAutoCalc(false);
    if (!calc) return;
    rooms.push(calc);
    calcUsed = calc;
  } else {
    calcUsed = rooms[0];
  }

  const docPdf = buildPdfForRooms(rooms);
  if (!docPdf) return;
  const pdfBlob = docPdf.output('blob');

  const timestamp = Date.now();
  const pdfPath = `obracuni_pdfs/${currentUser.uid}/${timestamp}.pdf`;
  const storageRef = storage.ref().child(pdfPath);

  try {
    const snap = await storageRef.put(pdfBlob);
    const pdfURL = await snap.ref.getDownloadURL();

    const meta = calcUsed.meta || {};
    const dfmt = firebase.firestore.FieldValue.serverTimestamp();

    const docData = {
      createdAt: dfmt,
      userId: currentUser.uid,
      userEmail: currentUser.email || null,
      meta,
      roomsCount: rooms.length,
      rooms: rooms,
      pdfURL,
      pdfPath
    };

    await db.collection('obracuni').add(docData);
    alert("Obraƒçun i PDF spremljeni u Cloud.");
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri spremanju u Cloud: " + e.message);
  }
}

document.getElementById('btnSaveCloud').addEventListener('click', saveToCloud);

async function loadArchive() {
  const list = document.getElementById('archiveList');
  if (!list) return;
  list.innerHTML = "<p style='font-size:12px;opacity:0.7;'>Uƒçitavanje...</p>";
  try {
    const snap = await db.collection('obracuni')
      .orderBy('createdAt', 'desc')
      .limit(50)
      .get();
    if (snap.empty) {
      list.innerHTML = "<p style='font-size:12px;opacity:0.7;'>Nema spremljenih obraƒçuna.</p>";
      return;
    }
    let html = "";
    snap.forEach(docSnap => {
      const id = docSnap.id;
      const d = docSnap.data();
      const m = d.meta || {};
      const dt = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate() : null;
      const dateStr = dt ? dt.toLocaleString('hr-HR') : "";
      html += `
        <div class="archive-list-item">
          <div><b>${m.siteName || '-'}</b> ‚Äì ${m.roomName || 'Prostorija'} (${m.situationNo || '-'})</div>
          <div style="font-size:11px;opacity:0.7;">
            Datum: ${dateStr} ‚Ä¢ ID: ${id} ‚Ä¢ Korisnik: ${d.userEmail || d.userId || '-'}
          </div>
          <div class="archive-actions">
            ${d.pdfURL ? `<a class="btn-small" style="text-decoration:none;background:#fff;color:#000;border-radius:8px;padding:4px 8px;" href="${d.pdfURL}" target="_blank">üìÑ Otvori PDF</a>` : ""}
            <button class="btn-small secondary" onclick="reloadFromCloud('${id}')">üîç Otvori u kalkulatoru</button>
            <button class="btn-small secondary" onclick="deleteCloudRecord('${id}')">üóë Obri≈°i</button>
          </div>
        </div>
      `;
    });
    list.innerHTML = html;
  } catch (e) {
    console.error(e);
    list.innerHTML = "<p style='color:#f66;font-size:12px;'>Gre≈°ka pri ƒçitanju Cloud arhive.</p>";
  }
}

// ponovno otvori obraƒçun iz Cloud-a (uƒçita PODATKE PRVE PROSTORIJE u formu)
async function reloadFromCloud(id) {
  try {
    const docSnap = await db.collection('obracuni').doc(id).get();
    if (!docSnap.exists) {
      alert("Dokument ne postoji.");
      return;
    }
    const d = docSnap.data();
    const rooms = d.rooms || [];
    if (!rooms.length) {
      alert("Ovaj zapis nema detaljne podatke prostorije.");
      return;
    }
    const r0 = rooms[0];
    const m = r0.meta || {};
    document.getElementById('siteName').value = m.siteName || "";
    document.getElementById('roomName').value = m.roomName || "";
    document.getElementById('situationNo').value = m.situationNo || "";
    document.getElementById('investorName').value = m.investorName || "";

    // format ploƒçice ‚Äì poku≈°aj mapirati natrag
    if (r0.tileFormat && r0.tileFormat.wcm && r0.tileFormat.hcm) {
      const val = `${r0.tileFormat.wcm}x${r0.tileFormat.hcm}`;
      const select = document.getElementById('tileFormatSelect');
      if ([...select.options].some(o => o.value === val)) {
        select.value = val;
        tileCustomFields.style.display = 'none';
      } else {
        select.value = 'custom';
        tileCustomFields.style.display = 'block';
        document.getElementById('tileW').value = r0.tileFormat.wcm;
        document.getElementById('tileH').value = r0.tileFormat.hcm;
      }
    }

    document.getElementById('dimD').value = String(r0.D).replace('.', ',');
    document.getElementById('dimS').value = String(r0.S).replace('.', ',');
    document.getElementById('dimV').value = String(r0.V).replace('.', ',');

    openings = r0.openings || [];
    renderOpenings();

    roomsSet = rooms.slice();
    updateRoomsCounter();

    showView('autoCalcView');
    runAutoCalc(true);
    alert("Obraƒçun uƒçitan iz Clouda. U formi je prikazana prva prostorija.");
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri uƒçitavanju iz Clouda: " + e.message);
  }
}

async function deleteCloudRecord(id) {
  if (!confirm("Stvarno obrisati ovaj obraƒçun i njegov PDF?")) return;
  try {
    const docSnap = await db.collection('obracuni').doc(id).get();
    if (docSnap.exists) {
      const d = docSnap.data();
      if (d.pdfPath) {
        try {
          await storage.ref().child(d.pdfPath).delete();
        } catch (e) {
          console.warn("Ne mogu obrisati PDF iz Storage-a:", e.message);
        }
      }
    }
    await db.collection('obracuni').doc(id).delete();
    alert("Obraƒçun obrisan.");
    loadArchive();
  } catch (e) {
    console.error(e);
    alert("Gre≈°ka pri brisanju: " + e.message);
  }
}
</script>

</body>
</html>

